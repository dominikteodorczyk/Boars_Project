<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>src.EPR API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../src.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;src</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#compute_od_row">compute_od_row</a>
            </li>
            <li>
                    <a class="class" href="#EPRConfig">EPRConfig</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#EPRConfig.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.rho">rho</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.gamma">gamma</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.beta">beta</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.tau">tau</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.min_waiting_time_minutes">min_waiting_time_minutes</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.tessellation_attractiveness_column">tessellation_attractiveness_column</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.simulation_with_attractiveness_raster">simulation_with_attractiveness_raster</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.attractiveness_raster_path">attractiveness_raster_path</a>
                        </li>
                        <li>
                                <a class="function" href="#EPRConfig.check_attractiveness_raster">check_attractiveness_raster</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPRConfig.model_config">model_config</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EPR">EPR</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EPR.__init__">EPR</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.rho">rho</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.gamma">gamma</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.beta">beta</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.tau">tau</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.min_waiting_time_hours">min_waiting_time_hours</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.trajectories">trajectories</a>
                        </li>
                        <li>
                                <a class="variable" href="#EPR.trajectories_df">trajectories_df</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.convert_trajectories_to_dataframe">convert_trajectories_to_dataframe</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.convert_trajectories_to_geodataframe">convert_trajectories_to_geodataframe</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.expand_trajectory_to_hourly_steps">expand_trajectory_to_hourly_steps</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.generate_synthetic_trajectory">generate_synthetic_trajectory</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.pick_preferential_location">pick_preferential_location</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.explore_new_location">explore_new_location</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.choose_next_location">choose_next_location</a>
                        </li>
                        <li>
                                <a class="function" href="#EPR.simulate_agent_trajectory">simulate_agent_trajectory</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Ditras">Ditras</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Ditras.__init__">Ditras</a>
                        </li>
                        <li>
                                <a class="function" href="#Ditras.generate_synthetic_trajectory">generate_synthetic_trajectory</a>
                        </li>
                        <li>
                                <a class="function" href="#Ditras.simulate_agent_trajectory">simulate_agent_trajectory</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../src.html">src</a><wbr>.EPR    </h1>

                
                        <input id="mod-EPR-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-EPR-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">powerlaw</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">rasterstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zonal_stats</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeoDataFrame</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">lil_matrix</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">model_validator</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.gravity</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gravity</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.markov_chain</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkovChain</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">euclidean_distance</span><span class="p">,</span> <span class="n">get_geom_centroid</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_od_row</span><span class="p">(</span><span class="n">origin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">relevances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>                   <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    Compute a single row of the OD matrix for a given origin using the gravity model.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    The result is a probability distribution over all possible destinations.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    Args:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">        origin (int): Index of the origin cell.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        centroids (np.ndarray): Array of shape (n_cells,) with list of (lat, lon) centroids.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">        relevances (np.ndarray): Array of shape (n_cells,) with cell relevances (e.g., population).</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        gravity_model (Gravity): An instance of the Gravity model to compute scores.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    Returns:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">        np.ndarray: Probability distribution over destinations from the origin.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">origin_ll</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">origin_ll</span><span class="p">,</span> <span class="n">dest_ll</span><span class="p">)</span> <span class="k">for</span> <span class="n">dest_ll</span> <span class="ow">in</span> <span class="n">centroids</span><span class="p">])</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="c1"># Gravity scores for this origin to all destinations</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">scores</span> <span class="o">=</span> <span class="n">gravity_model</span><span class="o">.</span><span class="n">_compute_gravity_score</span><span class="p">(</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">origin</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">relevances</span><span class="p">[</span><span class="n">origin</span><span class="p">:</span> <span class="n">origin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">relevances</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>    <span class="k">if</span> <span class="n">scores</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>        <span class="c1"># Fallback to a uniform distribution instead of zeros only.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="k">return</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">scores</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="k">class</span><span class="w"> </span><span class="nc">EPRConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    Configuration for the Exploration &amp; Preferential Return (EPR) mobility model.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    Validates parameters and provides default values.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    Attributes:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">        name (str): Name of the EPR model.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        rho (float): Base exploration probability (0 &lt;= rho &lt;= 1).</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">        gamma (float): Exploration decay rate (gamma &gt;= 0).</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        beta (float): Waiting‑time exponent (beta &gt;= 0).</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        tau (int): Waiting‑time truncation in hours (tau &gt;= 1).</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        min_waiting_time_minutes (int): Minimum waiting time in minutes (min_waiting_time_minutes &gt;= 0).</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        tessellation_attractiveness_column (str): Column name in tessellation for spatial relevance.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        simulation_with_attractiveness_raster (bool): Whether to use an attractiveness raster for simulation.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        attractiveness_raster_path (Optional[str]): Path to the attractiveness raster file.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;EPR Model&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name of the EPR model&quot;</span><span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>    <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Base exploration probability&quot;</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.21</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Exploration decay rate&quot;</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Waiting‑time exponent&quot;</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">tau</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Waiting‑time truncation (h)&quot;</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="n">min_waiting_time_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum waiting time in minutes&quot;</span><span class="p">)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="n">tessellation_attractiveness_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;population&quot;</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Column name in tessellation for spatial relevance (e.g., population, points_count)&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="p">)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="n">simulation_with_attractiveness_raster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to use an attractiveness raster for simulation (if available)&quot;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="n">attractiveness_raster_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Path to the attractiveness raster file (if simulation_with_attractiveness_raster is True)&quot;</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_attractiveness_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EPRConfig&quot;</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">        Validate that if `simulation_with_attractiveness_raster` is True,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">        then `attractiveness_raster_path` must be provided and non-empty.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        Raises:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">            ValueError: If the conditions are not met.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        Returns:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">            EPRConfig: The validated configuration instance.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_with_attractiveness_raster</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">attractiveness_raster_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">attractiveness_raster_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>                    <span class="s2">&quot;`attractiveness_raster_path` must be provided and non-empty when &quot;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>                    <span class="s2">&quot;`simulation_with_attractiveness_raster` is True.&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>                <span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="k">class</span><span class="w"> </span><span class="nc">EPR</span><span class="p">:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exploration &amp; Preferential Return (EPR) mobility model.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">    Implements the mechanism described in *Song et al., 2010* with an optional</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">    on‑demand gravity‑based OD matrix.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EPRConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        Initialize the EPR model with the given configuration.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        Args:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">            config (EPRConfig): Configuration parameters for the EPR model.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="c1"># Hyper-parameters</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">rho</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">gamma</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">beta</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tau</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">min_waiting_time_minutes</span> <span class="o">/</span> <span class="mf">60.0</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="c1"># Spatial context</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_with_attractiveness_raster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">simulation_with_attractiveness_raster</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">attractiveness_raster_path</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tessellation_attractiveness_column</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="c1"># OD matrix (lazy)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="c1"># Agent state (updated per‑agent iteration)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">:</span> <span class="n">Agent</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="c1"># Output trajectory buffer: [iter, agent_id, timestamp, location]</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>    <span class="nd">@property</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rho</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">        Base exploration probability.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">        Getter:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">                float: The base exploration probability (0 &lt;= rho &lt;= 1).</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>    <span class="nd">@property</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">        Exploration decay rate.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">        Getter:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">                float: The exploration decay rate (gamma &gt;= 0).</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="nd">@property</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        Waiting‑time exponent.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Getter:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">                float: The waiting‑time exponent (beta &gt;= 0).</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    <span class="nd">@property</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tau</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">        Waiting‑time truncation in hours.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        Getter:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">                int: The waiting‑time truncation in hours (tau &gt;= 1).</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="nd">@property</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">min_waiting_time_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        Minimum waiting time in hours.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        Getter:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">                float: The minimum waiting time in hours (min_waiting_time_hours &gt;= 0).</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>    <span class="nd">@property</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        The raw trajectory list. Each entry is a list of: [iter, agent_id, timestamp, location].</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        Getter:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">                list[list]: The raw trajectory data.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>    <span class="nd">@property</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trajectories_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        The trajectory data as a pandas DataFrame with columns: iter, agent_id, timestamp, location.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        Getter:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">            **Returns:**</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">                pd.DataFrame | None: The trajectory DataFrame, or None if not yet converted.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trajectories_to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        Convert the trajectory list to a pandas DataFrame. Stores the result in `self._trajectories_df`.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">,</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">]</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="o">=</span> <span class="n">df</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trajectories_to_geodataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        Convert the trajectory DataFrame to a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        Requires that the tessellation is set and that the trajectories DataFrame is available.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        Returns:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">            gpd.GeoDataFrame: The trajectory data as a GeoDataFrame with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        Raises:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            ValueError: If the tessellation is not set or if the trajectories DataFrame is not available.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tessellation is not set. Cannot convert trajectories to GeoDataFrame.&quot;</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="n">projected_tessellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="n">projected_tessellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">projected_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="k">return</span> <span class="n">gdf</span><span class="p">[[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        Expand the trajectory to hourly steps between start_date and end_date.</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        Fills in missing hours by forward-filling the last known location.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        Args:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        Raises:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">            ValueError: If the trajectories DataFrame is not available.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        Returns:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">            None: The method updates `self._trajectories_df` in place.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trajectories DataFrame is not available. Cannot expand to hourly steps.&quot;</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;agent_id&quot;</span><span class="p">):</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)[[</span><span class="s2">&quot;location&quot;</span><span class="p">]]</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="n">all_hours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">all_hours</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">})</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="n">resampled</span><span class="p">[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="n">resampled</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resampled</span><span class="p">))</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resampled</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="k">if</span> <span class="n">expanded</span> <span class="k">else</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;iter&quot;</span><span class="p">])</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_wait_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        Draw a single waiting time (in hours) from a truncated power law.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        Returns:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">            float: A sampled waiting time in hours.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">powerlaw</span><span class="o">.</span><span class="n">Truncated_Power_Law</span><span class="p">(</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="n">xmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">generate_random</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_wait_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        Return waiting time as ``datetime.timedelta``. Uses `_sample_wait_hours()` internally.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">        Returns:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">            timedelta: A sampled waiting time as a timedelta object.</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_wait_hours</span><span class="p">())</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_preferential_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">        Select a *visited* cell according to visitation frequencies. Excludes the current location.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">        Args:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">            current_loc (int): The agent&#39;s current location index.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">        Returns:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">            int: The selected location index.</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="o">.</span><span class="n">visited_locations</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">locs</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">visited</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">current_loc</span><span class="p">))</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="n">probs</span> <span class="o">/=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_explore_new_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        Pick a *new* location using (cached) OD probabilities. If the OD row for the current location is not yet</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        computed, it will be calculated on‑demand. Excludes the current location from possible destinations. If no other</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        locations are available (e.g., only one cell in tessellation), returns the current location.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">        Args:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">            current_loc (int): The agent&#39;s current location index.</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">        Returns:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">            int: The selected new location index. If no new location is available, returns `current_loc`.</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="c1"># Retrieve or lazily compute probability vector for this origin.</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="n">od_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="o">.</span><span class="n">getrowview</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="k">if</span> <span class="n">od_row</span><span class="o">.</span><span class="n">nnz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">compute_od_row</span><span class="p">(</span><span class="n">current_loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span><span class="p">,</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                                   <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="p">[</span><span class="n">current_loc</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">probs</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">od_row</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="n">destinations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">))</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_choose_next_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        Decide whether to *explore* or *return*, then pick the destination. The exploration probability decays with</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">        the number of unique visited locations. If exploring, a new location is chosen using the OD matrix;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        if returning, a previously visited location is selected based on visitation frequency. If no new locations</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        are available, the agent will return to a visited location.</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">        Returns:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">            int: The selected next location index.</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="n">num_visited</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="c1"># First step: explore from the starting cell</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="k">if</span> <span class="n">num_visited</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explore_new_location</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="o">*</span><span class="n">_prev</span><span class="p">,</span> <span class="n">current_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="c1"># Exploration probability decays with #visited locations (Song et al.)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="n">p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">num_visited</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="n">explore_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_new</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">num_visited</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">num_visited</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="k">if</span> <span class="n">explore_flag</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explore_new_location</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_preferential_location</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                                      <span class="n">tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                                      <span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">od_matrix</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        Simulate trajectories for *n_agents* between *start_date* and *end_date*. Each agent starts from a specified or</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">        model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        Args:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">            n_agents (int): Number of agents to simulate.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">            start_date (datetime): Start date of the simulation period.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">            end_date (datetime): End date of the simulation period.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">            tessellation (gpd.GeoDataFrame): Spatial tessellation with a geometry column and an attractiveness column.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">            gravity_model (Gravity | None): An optional Gravity model instance. If None, a default singly-constrained model is used.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">            starting_cells (list[int] | None): Optional list of starting cell indices for agents. If provided, must have at least `n_agents` elements. If None, starting cells are chosen randomly.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">            od_matrix (lil_matrix | None): Optional precomputed OD matrix. If None, it will be computed on‑demand.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">            random_state (int | None): Optional random seed for reproducibility.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">        Returns:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">            gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">        Raises:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">            ValueError: If `starting_cells` is provided but has fewer than `n_agents` elements.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_agents</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;starting_cells&#39; must contain at least &#39;n_agents&#39; elements.&quot;</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="c1"># Spatial context</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="o">=</span> <span class="n">tessellation</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_geom_centroid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="c1"># Gravity model (lazily created)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="n">gravity_model</span> <span class="ow">or</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;singly constrained&quot;</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="c1"># OD matrix initialisation</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="n">od_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">))</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">od_matrix</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="c1"># Simulate each agent separately</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trajectory generation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                    <span class="n">starting_cells</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_dataframe</span><span class="p">()</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_geodataframe</span><span class="p">()</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">        Run the event‑based simulation loop for a single agent. The agent starts at the specified starting cell and</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">        iteratively decides to explore new locations or return to previously visited ones, based on the EPR model&#39;s</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        probabilities. The agent waits at each location for a time drawn from a truncated power law distribution before</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">        moving again. The trajectory is recorded in `self._trajectories`.</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">        Args:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">            agent (Agent): The agent to simulate.</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        Returns:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">            None: The method updates `self._trajectories` in place.</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_date</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="n">iter_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="c1"># First record — agent starts at *start* timestamp</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">])</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="c1"># Iterate until *end_date*</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="n">current_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_wait_delta</span><span class="p">()</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="n">end_date</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="k">break</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="n">iter_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_next_location</span><span class="p">()</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="n">next_loc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">])</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>    <span class="n">pick_preferential_location</span> <span class="o">=</span> <span class="n">_pick_preferential_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="n">explore_new_location</span> <span class="o">=</span> <span class="n">_explore_new_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>    <span class="n">choose_next_location</span> <span class="o">=</span> <span class="n">_choose_next_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>    <span class="n">simulate_agent_trajectory</span> <span class="o">=</span> <span class="n">_simulate_agent_trajectory</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Ditras</span><span class="p">(</span><span class="n">EPR</span><span class="p">):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">    Ditras model, inheriting from EPR. Uses a Markov chain for diary generation. Overrides the trajectory generation method to</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">    incorporate diary-based location choices. Requires a MarkovChain instance for diary generation.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EPRConfig</span><span class="p">,</span> <span class="n">diary_generator</span><span class="p">:</span> <span class="n">MarkovChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">        Initialize the Ditras model with the given configuration and diary generator. Inherits from EPR.</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a><span class="sd">        Args:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">            config (EPRConfig): Configuration parameters for the EPR model.</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">            diary_generator (MarkovChain): An instance of MarkovChain for generating activity diaries.</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_diary_generator</span> <span class="o">=</span> <span class="n">diary_generator</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                                      <span class="n">tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                                      <span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">od_matrix</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        Simulate trajectories for *n_agents* between *start_date* and *end_date*. Each agent starts from a specified or</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">        random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">        model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">        Args:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">            n_agents (int): Number of agents to simulate.</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">            start_date (datetime): Start date of the simulation period.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">            end_date (datetime): End date of the simulation period.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">            tessellation (gpd.GeoDataFrame): Spatial tessellation with a geometry column and an attractiveness column.</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">            gravity_model (Gravity | None): An optional Gravity model instance. If None, a default singly-constrained model is used.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">            starting_cells (list[int] | None): Optional list of starting cell indices for agents. If provided, must have at least `n_agents` elements. If None, starting cells are chosen randomly.</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">            od_matrix (lil_matrix | None): Optional precomputed OD matrix. If None, it will be computed on‑demand.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">            random_state (int | None): Optional random seed for reproducibility.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        Returns:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">        Raises:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">            ValueError: If `starting_cells` is provided but has fewer than `n_agents` elements.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_agents</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;starting_cells&#39; must contain at least &#39;n_agents&#39; elements.&quot;</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="c1"># Spatial context</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="o">=</span> <span class="n">tessellation</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_with_attractiveness_raster</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="n">raster</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>            <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">tessellation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">nodata</span><span class="o">=</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>            <span class="n">mean_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="n">tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mean_values</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_geom_centroid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="c1"># Gravity model (lazily created)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="n">gravity_model</span> <span class="ow">or</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;singly constrained&quot;</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="c1"># OD matrix initialisation</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="n">od_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">))</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">od_matrix</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="c1"># Simulate each agent separately</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trajectory generation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                    <span class="n">starting_cells</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_dataframe</span><span class="p">()</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_geodataframe</span><span class="p">()</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">        Run the event‑based simulation loop for a single agent.</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">        The agent starts at the specified starting cell and follows an activity diary generated by a Markov chain.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="sd">        The trajectory is recorded in `self._trajectories`.</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">        Args:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="sd">            agent (Agent): The agent to simulate.</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">        Returns:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">            None: The method updates `self._trajectories` in place.</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="n">n_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="n">iter_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>        <span class="n">diary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diary_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">duration_hours</span><span class="o">=</span><span class="n">n_hours</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                                                  <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">diary_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">abstract_location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                <span class="n">iter_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_next_location</span><span class="p">()</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="n">next_loc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">])</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="n">simulate_agent_trajectory</span> <span class="o">=</span> <span class="n">_simulate_agent_trajectory</span>  <span class="c1"># Expose for docs</span>
</span></pre></div>


            </section>
                <section id="compute_od_row">
                            <input id="compute_od_row-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_od_row</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">origin</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">centroids</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">relevances</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">gravity_model</span><span class="p">:</span> <span class="n"><a href="gravity.html#Gravity">src.gravity.Gravity</a></span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="compute_od_row-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_od_row"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_od_row-23"><a href="#compute_od_row-23"><span class="linenos">23</span></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_od_row</span><span class="p">(</span><span class="n">origin</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">centroids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">relevances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="compute_od_row-24"><a href="#compute_od_row-24"><span class="linenos">24</span></a>                   <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="compute_od_row-25"><a href="#compute_od_row-25"><span class="linenos">25</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_od_row-26"><a href="#compute_od_row-26"><span class="linenos">26</span></a><span class="sd">    Compute a single row of the OD matrix for a given origin using the gravity model.</span>
</span><span id="compute_od_row-27"><a href="#compute_od_row-27"><span class="linenos">27</span></a><span class="sd">    The result is a probability distribution over all possible destinations.</span>
</span><span id="compute_od_row-28"><a href="#compute_od_row-28"><span class="linenos">28</span></a>
</span><span id="compute_od_row-29"><a href="#compute_od_row-29"><span class="linenos">29</span></a><span class="sd">    Args:</span>
</span><span id="compute_od_row-30"><a href="#compute_od_row-30"><span class="linenos">30</span></a><span class="sd">        origin (int): Index of the origin cell.</span>
</span><span id="compute_od_row-31"><a href="#compute_od_row-31"><span class="linenos">31</span></a><span class="sd">        centroids (np.ndarray): Array of shape (n_cells,) with list of (lat, lon) centroids.</span>
</span><span id="compute_od_row-32"><a href="#compute_od_row-32"><span class="linenos">32</span></a><span class="sd">        relevances (np.ndarray): Array of shape (n_cells,) with cell relevances (e.g., population).</span>
</span><span id="compute_od_row-33"><a href="#compute_od_row-33"><span class="linenos">33</span></a><span class="sd">        gravity_model (Gravity): An instance of the Gravity model to compute scores.</span>
</span><span id="compute_od_row-34"><a href="#compute_od_row-34"><span class="linenos">34</span></a><span class="sd">    Returns:</span>
</span><span id="compute_od_row-35"><a href="#compute_od_row-35"><span class="linenos">35</span></a><span class="sd">        np.ndarray: Probability distribution over destinations from the origin.</span>
</span><span id="compute_od_row-36"><a href="#compute_od_row-36"><span class="linenos">36</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_od_row-37"><a href="#compute_od_row-37"><span class="linenos">37</span></a>    <span class="n">origin_ll</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span>
</span><span id="compute_od_row-38"><a href="#compute_od_row-38"><span class="linenos">38</span></a>    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">origin_ll</span><span class="p">,</span> <span class="n">dest_ll</span><span class="p">)</span> <span class="k">for</span> <span class="n">dest_ll</span> <span class="ow">in</span> <span class="n">centroids</span><span class="p">])</span>
</span><span id="compute_od_row-39"><a href="#compute_od_row-39"><span class="linenos">39</span></a>
</span><span id="compute_od_row-40"><a href="#compute_od_row-40"><span class="linenos">40</span></a>    <span class="c1"># Gravity scores for this origin to all destinations</span>
</span><span id="compute_od_row-41"><a href="#compute_od_row-41"><span class="linenos">41</span></a>    <span class="n">scores</span> <span class="o">=</span> <span class="n">gravity_model</span><span class="o">.</span><span class="n">_compute_gravity_score</span><span class="p">(</span>
</span><span id="compute_od_row-42"><a href="#compute_od_row-42"><span class="linenos">42</span></a>        <span class="n">origin</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">relevances</span><span class="p">[</span><span class="n">origin</span><span class="p">:</span> <span class="n">origin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">relevances</span>
</span><span id="compute_od_row-43"><a href="#compute_od_row-43"><span class="linenos">43</span></a>    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="compute_od_row-44"><a href="#compute_od_row-44"><span class="linenos">44</span></a>
</span><span id="compute_od_row-45"><a href="#compute_od_row-45"><span class="linenos">45</span></a>    <span class="k">if</span> <span class="n">scores</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="compute_od_row-46"><a href="#compute_od_row-46"><span class="linenos">46</span></a>        <span class="c1"># Fallback to a uniform distribution instead of zeros only.</span>
</span><span id="compute_od_row-47"><a href="#compute_od_row-47"><span class="linenos">47</span></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</span><span id="compute_od_row-48"><a href="#compute_od_row-48"><span class="linenos">48</span></a>
</span><span id="compute_od_row-49"><a href="#compute_od_row-49"><span class="linenos">49</span></a>    <span class="k">return</span> <span class="n">scores</span> <span class="o">/</span> <span class="n">scores</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Compute a single row of the OD matrix for a given origin using the gravity model.
The result is a probability distribution over all possible destinations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>origin (int):</strong>  Index of the origin cell.</li>
<li><strong>centroids (np.ndarray):</strong>  Array of shape (n_cells,) with list of (lat, lon) centroids.</li>
<li><strong>relevances (np.ndarray):</strong>  Array of shape (n_cells,) with cell relevances (e.g., population).</li>
<li><strong>gravity_model (Gravity):</strong>  An instance of the Gravity model to compute scores.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: Probability distribution over destinations from the origin.</p>
</blockquote>
</div>


                </section>
                <section id="EPRConfig">
                            <input id="EPRConfig-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EPRConfig</span><wbr>(<span class="base">pydantic.main.BaseModel</span>):

                <label class="view-source-button" for="EPRConfig-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPRConfig"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPRConfig-52"><a href="#EPRConfig-52"><span class="linenos"> 52</span></a><span class="k">class</span><span class="w"> </span><span class="nc">EPRConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="EPRConfig-53"><a href="#EPRConfig-53"><span class="linenos"> 53</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPRConfig-54"><a href="#EPRConfig-54"><span class="linenos"> 54</span></a><span class="sd">    Configuration for the Exploration &amp; Preferential Return (EPR) mobility model.</span>
</span><span id="EPRConfig-55"><a href="#EPRConfig-55"><span class="linenos"> 55</span></a><span class="sd">    Validates parameters and provides default values.</span>
</span><span id="EPRConfig-56"><a href="#EPRConfig-56"><span class="linenos"> 56</span></a>
</span><span id="EPRConfig-57"><a href="#EPRConfig-57"><span class="linenos"> 57</span></a><span class="sd">    Attributes:</span>
</span><span id="EPRConfig-58"><a href="#EPRConfig-58"><span class="linenos"> 58</span></a><span class="sd">        name (str): Name of the EPR model.</span>
</span><span id="EPRConfig-59"><a href="#EPRConfig-59"><span class="linenos"> 59</span></a><span class="sd">        rho (float): Base exploration probability (0 &lt;= rho &lt;= 1).</span>
</span><span id="EPRConfig-60"><a href="#EPRConfig-60"><span class="linenos"> 60</span></a><span class="sd">        gamma (float): Exploration decay rate (gamma &gt;= 0).</span>
</span><span id="EPRConfig-61"><a href="#EPRConfig-61"><span class="linenos"> 61</span></a><span class="sd">        beta (float): Waiting‑time exponent (beta &gt;= 0).</span>
</span><span id="EPRConfig-62"><a href="#EPRConfig-62"><span class="linenos"> 62</span></a><span class="sd">        tau (int): Waiting‑time truncation in hours (tau &gt;= 1).</span>
</span><span id="EPRConfig-63"><a href="#EPRConfig-63"><span class="linenos"> 63</span></a><span class="sd">        min_waiting_time_minutes (int): Minimum waiting time in minutes (min_waiting_time_minutes &gt;= 0).</span>
</span><span id="EPRConfig-64"><a href="#EPRConfig-64"><span class="linenos"> 64</span></a><span class="sd">        tessellation_attractiveness_column (str): Column name in tessellation for spatial relevance.</span>
</span><span id="EPRConfig-65"><a href="#EPRConfig-65"><span class="linenos"> 65</span></a><span class="sd">        simulation_with_attractiveness_raster (bool): Whether to use an attractiveness raster for simulation.</span>
</span><span id="EPRConfig-66"><a href="#EPRConfig-66"><span class="linenos"> 66</span></a><span class="sd">        attractiveness_raster_path (Optional[str]): Path to the attractiveness raster file.</span>
</span><span id="EPRConfig-67"><a href="#EPRConfig-67"><span class="linenos"> 67</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EPRConfig-68"><a href="#EPRConfig-68"><span class="linenos"> 68</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;EPR Model&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name of the EPR model&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-69"><a href="#EPRConfig-69"><span class="linenos"> 69</span></a>    <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Base exploration probability&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-70"><a href="#EPRConfig-70"><span class="linenos"> 70</span></a>    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.21</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Exploration decay rate&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-71"><a href="#EPRConfig-71"><span class="linenos"> 71</span></a>    <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Waiting‑time exponent&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-72"><a href="#EPRConfig-72"><span class="linenos"> 72</span></a>    <span class="n">tau</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Waiting‑time truncation (h)&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-73"><a href="#EPRConfig-73"><span class="linenos"> 73</span></a>    <span class="n">min_waiting_time_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum waiting time in minutes&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-74"><a href="#EPRConfig-74"><span class="linenos"> 74</span></a>    <span class="n">tessellation_attractiveness_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="EPRConfig-75"><a href="#EPRConfig-75"><span class="linenos"> 75</span></a>        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;population&quot;</span><span class="p">,</span>
</span><span id="EPRConfig-76"><a href="#EPRConfig-76"><span class="linenos"> 76</span></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Column name in tessellation for spatial relevance (e.g., population, points_count)&quot;</span>
</span><span id="EPRConfig-77"><a href="#EPRConfig-77"><span class="linenos"> 77</span></a>    <span class="p">)</span>
</span><span id="EPRConfig-78"><a href="#EPRConfig-78"><span class="linenos"> 78</span></a>    <span class="n">simulation_with_attractiveness_raster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="EPRConfig-79"><a href="#EPRConfig-79"><span class="linenos"> 79</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="EPRConfig-80"><a href="#EPRConfig-80"><span class="linenos"> 80</span></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to use an attractiveness raster for simulation (if available)&quot;</span>
</span><span id="EPRConfig-81"><a href="#EPRConfig-81"><span class="linenos"> 81</span></a>    <span class="p">)</span>
</span><span id="EPRConfig-82"><a href="#EPRConfig-82"><span class="linenos"> 82</span></a>    <span class="n">attractiveness_raster_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="EPRConfig-83"><a href="#EPRConfig-83"><span class="linenos"> 83</span></a>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EPRConfig-84"><a href="#EPRConfig-84"><span class="linenos"> 84</span></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Path to the attractiveness raster file (if simulation_with_attractiveness_raster is True)&quot;</span>
</span><span id="EPRConfig-85"><a href="#EPRConfig-85"><span class="linenos"> 85</span></a>    <span class="p">)</span>
</span><span id="EPRConfig-86"><a href="#EPRConfig-86"><span class="linenos"> 86</span></a>
</span><span id="EPRConfig-87"><a href="#EPRConfig-87"><span class="linenos"> 87</span></a>    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="EPRConfig-88"><a href="#EPRConfig-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_attractiveness_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EPRConfig&quot;</span><span class="p">:</span>
</span><span id="EPRConfig-89"><a href="#EPRConfig-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPRConfig-90"><a href="#EPRConfig-90"><span class="linenos"> 90</span></a><span class="sd">        Validate that if `simulation_with_attractiveness_raster` is True,</span>
</span><span id="EPRConfig-91"><a href="#EPRConfig-91"><span class="linenos"> 91</span></a><span class="sd">        then `attractiveness_raster_path` must be provided and non-empty.</span>
</span><span id="EPRConfig-92"><a href="#EPRConfig-92"><span class="linenos"> 92</span></a>
</span><span id="EPRConfig-93"><a href="#EPRConfig-93"><span class="linenos"> 93</span></a><span class="sd">        Raises:</span>
</span><span id="EPRConfig-94"><a href="#EPRConfig-94"><span class="linenos"> 94</span></a><span class="sd">            ValueError: If the conditions are not met.</span>
</span><span id="EPRConfig-95"><a href="#EPRConfig-95"><span class="linenos"> 95</span></a><span class="sd">        Returns:</span>
</span><span id="EPRConfig-96"><a href="#EPRConfig-96"><span class="linenos"> 96</span></a><span class="sd">            EPRConfig: The validated configuration instance.</span>
</span><span id="EPRConfig-97"><a href="#EPRConfig-97"><span class="linenos"> 97</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPRConfig-98"><a href="#EPRConfig-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_with_attractiveness_raster</span><span class="p">:</span>
</span><span id="EPRConfig-99"><a href="#EPRConfig-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">attractiveness_raster_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">attractiveness_raster_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="EPRConfig-100"><a href="#EPRConfig-100"><span class="linenos">100</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EPRConfig-101"><a href="#EPRConfig-101"><span class="linenos">101</span></a>                    <span class="s2">&quot;`attractiveness_raster_path` must be provided and non-empty when &quot;</span>
</span><span id="EPRConfig-102"><a href="#EPRConfig-102"><span class="linenos">102</span></a>                    <span class="s2">&quot;`simulation_with_attractiveness_raster` is True.&quot;</span>
</span><span id="EPRConfig-103"><a href="#EPRConfig-103"><span class="linenos">103</span></a>                <span class="p">)</span>
</span><span id="EPRConfig-104"><a href="#EPRConfig-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Configuration for the Exploration &amp; Preferential Return (EPR) mobility model.
Validates parameters and provides default values.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>name (str):</strong>  Name of the EPR model.</li>
<li><strong>rho (float):</strong>  Base exploration probability (0 &lt;= rho &lt;= 1).</li>
<li><strong>gamma (float):</strong>  Exploration decay rate (gamma &gt;= 0).</li>
<li><strong>beta (float):</strong>  Waiting‑time exponent (beta &gt;= 0).</li>
<li><strong>tau (int):</strong>  Waiting‑time truncation in hours (tau &gt;= 1).</li>
<li><strong>min_waiting_time_minutes (int):</strong>  Minimum waiting time in minutes (min_waiting_time_minutes &gt;= 0).</li>
<li><strong>tessellation_attractiveness_column (str):</strong>  Column name in tessellation for spatial relevance.</li>
<li><strong>simulation_with_attractiveness_raster (bool):</strong>  Whether to use an attractiveness raster for simulation.</li>
<li><strong>attractiveness_raster_path (Optional[str]):</strong>  Path to the attractiveness raster file.</li>
</ul>
</div>


                            <div id="EPRConfig.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.name"></a>
    
    

                            </div>
                            <div id="EPRConfig.rho" class="classattr">
                                <div class="attr variable">
            <span class="name">rho</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.rho"></a>
    
    

                            </div>
                            <div id="EPRConfig.gamma" class="classattr">
                                <div class="attr variable">
            <span class="name">gamma</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.gamma"></a>
    
    

                            </div>
                            <div id="EPRConfig.beta" class="classattr">
                                <div class="attr variable">
            <span class="name">beta</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.beta"></a>
    
    

                            </div>
                            <div id="EPRConfig.tau" class="classattr">
                                <div class="attr variable">
            <span class="name">tau</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.tau"></a>
    
    

                            </div>
                            <div id="EPRConfig.min_waiting_time_minutes" class="classattr">
                                <div class="attr variable">
            <span class="name">min_waiting_time_minutes</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.min_waiting_time_minutes"></a>
    
    

                            </div>
                            <div id="EPRConfig.tessellation_attractiveness_column" class="classattr">
                                <div class="attr variable">
            <span class="name">tessellation_attractiveness_column</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.tessellation_attractiveness_column"></a>
    
    

                            </div>
                            <div id="EPRConfig.simulation_with_attractiveness_raster" class="classattr">
                                <div class="attr variable">
            <span class="name">simulation_with_attractiveness_raster</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.simulation_with_attractiveness_raster"></a>
    
    

                            </div>
                            <div id="EPRConfig.attractiveness_raster_path" class="classattr">
                                <div class="attr variable">
            <span class="name">attractiveness_raster_path</span><span class="annotation">: Optional[str]</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.attractiveness_raster_path"></a>
    
    

                            </div>
                            <div id="EPRConfig.check_attractiveness_raster" class="classattr">
                                        <input id="EPRConfig.check_attractiveness_raster-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-model_validator">@model_validator(mode=&#39;after&#39;)</div>

        <span class="def">def</span>
        <span class="name">check_attractiveness_raster</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#EPRConfig">EPRConfig</a></span>:</span></span>

                <label class="view-source-button" for="EPRConfig.check_attractiveness_raster-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPRConfig.check_attractiveness_raster"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPRConfig.check_attractiveness_raster-87"><a href="#EPRConfig.check_attractiveness_raster-87"><span class="linenos"> 87</span></a>    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="EPRConfig.check_attractiveness_raster-88"><a href="#EPRConfig.check_attractiveness_raster-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_attractiveness_raster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EPRConfig&quot;</span><span class="p">:</span>
</span><span id="EPRConfig.check_attractiveness_raster-89"><a href="#EPRConfig.check_attractiveness_raster-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPRConfig.check_attractiveness_raster-90"><a href="#EPRConfig.check_attractiveness_raster-90"><span class="linenos"> 90</span></a><span class="sd">        Validate that if `simulation_with_attractiveness_raster` is True,</span>
</span><span id="EPRConfig.check_attractiveness_raster-91"><a href="#EPRConfig.check_attractiveness_raster-91"><span class="linenos"> 91</span></a><span class="sd">        then `attractiveness_raster_path` must be provided and non-empty.</span>
</span><span id="EPRConfig.check_attractiveness_raster-92"><a href="#EPRConfig.check_attractiveness_raster-92"><span class="linenos"> 92</span></a>
</span><span id="EPRConfig.check_attractiveness_raster-93"><a href="#EPRConfig.check_attractiveness_raster-93"><span class="linenos"> 93</span></a><span class="sd">        Raises:</span>
</span><span id="EPRConfig.check_attractiveness_raster-94"><a href="#EPRConfig.check_attractiveness_raster-94"><span class="linenos"> 94</span></a><span class="sd">            ValueError: If the conditions are not met.</span>
</span><span id="EPRConfig.check_attractiveness_raster-95"><a href="#EPRConfig.check_attractiveness_raster-95"><span class="linenos"> 95</span></a><span class="sd">        Returns:</span>
</span><span id="EPRConfig.check_attractiveness_raster-96"><a href="#EPRConfig.check_attractiveness_raster-96"><span class="linenos"> 96</span></a><span class="sd">            EPRConfig: The validated configuration instance.</span>
</span><span id="EPRConfig.check_attractiveness_raster-97"><a href="#EPRConfig.check_attractiveness_raster-97"><span class="linenos"> 97</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPRConfig.check_attractiveness_raster-98"><a href="#EPRConfig.check_attractiveness_raster-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_with_attractiveness_raster</span><span class="p">:</span>
</span><span id="EPRConfig.check_attractiveness_raster-99"><a href="#EPRConfig.check_attractiveness_raster-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">attractiveness_raster_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">attractiveness_raster_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="EPRConfig.check_attractiveness_raster-100"><a href="#EPRConfig.check_attractiveness_raster-100"><span class="linenos">100</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="EPRConfig.check_attractiveness_raster-101"><a href="#EPRConfig.check_attractiveness_raster-101"><span class="linenos">101</span></a>                    <span class="s2">&quot;`attractiveness_raster_path` must be provided and non-empty when &quot;</span>
</span><span id="EPRConfig.check_attractiveness_raster-102"><a href="#EPRConfig.check_attractiveness_raster-102"><span class="linenos">102</span></a>                    <span class="s2">&quot;`simulation_with_attractiveness_raster` is True.&quot;</span>
</span><span id="EPRConfig.check_attractiveness_raster-103"><a href="#EPRConfig.check_attractiveness_raster-103"><span class="linenos">103</span></a>                <span class="p">)</span>
</span><span id="EPRConfig.check_attractiveness_raster-104"><a href="#EPRConfig.check_attractiveness_raster-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Validate that if <code><a href="#EPRConfig.simulation_with_attractiveness_raster">simulation_with_attractiveness_raster</a></code> is True,
then <code><a href="#EPRConfig.attractiveness_raster_path">attractiveness_raster_path</a></code> must be provided and non-empty.</p>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If the conditions are not met.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>EPRConfig: The validated configuration instance.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPRConfig.model_config" class="classattr">
                                <div class="attr variable">
            <span class="name">model_config</span><span class="annotation">: ClassVar[pydantic.config.ConfigDict]</span>        =
<span class="default_value">{}</span>

        
    </div>
    <a class="headerlink" href="#EPRConfig.model_config"></a>
    
            <div class="docstring"><p>Configuration for the model, should be a dictionary conforming to [<code>ConfigDict</code>][pydantic.config.ConfigDict].</p>
</div>


                            </div>
                </section>
                <section id="EPR">
                            <input id="EPR-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EPR</span>:

                <label class="view-source-button" for="EPR-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR-107"><a href="#EPR-107"><span class="linenos">107</span></a><span class="k">class</span><span class="w"> </span><span class="nc">EPR</span><span class="p">:</span>
</span><span id="EPR-108"><a href="#EPR-108"><span class="linenos">108</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Exploration &amp; Preferential Return (EPR) mobility model.</span>
</span><span id="EPR-109"><a href="#EPR-109"><span class="linenos">109</span></a>
</span><span id="EPR-110"><a href="#EPR-110"><span class="linenos">110</span></a><span class="sd">    Implements the mechanism described in *Song et al., 2010* with an optional</span>
</span><span id="EPR-111"><a href="#EPR-111"><span class="linenos">111</span></a><span class="sd">    on‑demand gravity‑based OD matrix.</span>
</span><span id="EPR-112"><a href="#EPR-112"><span class="linenos">112</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EPR-113"><a href="#EPR-113"><span class="linenos">113</span></a>
</span><span id="EPR-114"><a href="#EPR-114"><span class="linenos">114</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EPRConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-115"><a href="#EPR-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-116"><a href="#EPR-116"><span class="linenos">116</span></a><span class="sd">        Initialize the EPR model with the given configuration.</span>
</span><span id="EPR-117"><a href="#EPR-117"><span class="linenos">117</span></a>
</span><span id="EPR-118"><a href="#EPR-118"><span class="linenos">118</span></a><span class="sd">        Args:</span>
</span><span id="EPR-119"><a href="#EPR-119"><span class="linenos">119</span></a><span class="sd">            config (EPRConfig): Configuration parameters for the EPR model.</span>
</span><span id="EPR-120"><a href="#EPR-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-121"><a href="#EPR-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span id="EPR-122"><a href="#EPR-122"><span class="linenos">122</span></a>
</span><span id="EPR-123"><a href="#EPR-123"><span class="linenos">123</span></a>        <span class="c1"># Hyper-parameters</span>
</span><span id="EPR-124"><a href="#EPR-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">rho</span>
</span><span id="EPR-125"><a href="#EPR-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">gamma</span>
</span><span id="EPR-126"><a href="#EPR-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">beta</span>
</span><span id="EPR-127"><a href="#EPR-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tau</span>
</span><span id="EPR-128"><a href="#EPR-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">min_waiting_time_minutes</span> <span class="o">/</span> <span class="mf">60.0</span>
</span><span id="EPR-129"><a href="#EPR-129"><span class="linenos">129</span></a>
</span><span id="EPR-130"><a href="#EPR-130"><span class="linenos">130</span></a>        <span class="c1"># Spatial context</span>
</span><span id="EPR-131"><a href="#EPR-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_with_attractiveness_raster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">simulation_with_attractiveness_raster</span>
</span><span id="EPR-132"><a href="#EPR-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">attractiveness_raster_path</span>
</span><span id="EPR-133"><a href="#EPR-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-134"><a href="#EPR-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-135"><a href="#EPR-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-136"><a href="#EPR-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tessellation_attractiveness_column</span>
</span><span id="EPR-137"><a href="#EPR-137"><span class="linenos">137</span></a>
</span><span id="EPR-138"><a href="#EPR-138"><span class="linenos">138</span></a>        <span class="c1"># OD matrix (lazy)</span>
</span><span id="EPR-139"><a href="#EPR-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-140"><a href="#EPR-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EPR-141"><a href="#EPR-141"><span class="linenos">141</span></a>
</span><span id="EPR-142"><a href="#EPR-142"><span class="linenos">142</span></a>        <span class="c1"># Agent state (updated per‑agent iteration)</span>
</span><span id="EPR-143"><a href="#EPR-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-144"><a href="#EPR-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">:</span> <span class="n">Agent</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-145"><a href="#EPR-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-146"><a href="#EPR-146"><span class="linenos">146</span></a>
</span><span id="EPR-147"><a href="#EPR-147"><span class="linenos">147</span></a>        <span class="c1"># Output trajectory buffer: [iter, agent_id, timestamp, location]</span>
</span><span id="EPR-148"><a href="#EPR-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EPR-149"><a href="#EPR-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR-150"><a href="#EPR-150"><span class="linenos">150</span></a>
</span><span id="EPR-151"><a href="#EPR-151"><span class="linenos">151</span></a>    <span class="nd">@property</span>
</span><span id="EPR-152"><a href="#EPR-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rho</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR-153"><a href="#EPR-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-154"><a href="#EPR-154"><span class="linenos">154</span></a><span class="sd">        Base exploration probability.</span>
</span><span id="EPR-155"><a href="#EPR-155"><span class="linenos">155</span></a>
</span><span id="EPR-156"><a href="#EPR-156"><span class="linenos">156</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-157"><a href="#EPR-157"><span class="linenos">157</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-158"><a href="#EPR-158"><span class="linenos">158</span></a><span class="sd">                float: The base exploration probability (0 &lt;= rho &lt;= 1).</span>
</span><span id="EPR-159"><a href="#EPR-159"><span class="linenos">159</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-160"><a href="#EPR-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span>
</span><span id="EPR-161"><a href="#EPR-161"><span class="linenos">161</span></a>
</span><span id="EPR-162"><a href="#EPR-162"><span class="linenos">162</span></a>    <span class="nd">@property</span>
</span><span id="EPR-163"><a href="#EPR-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR-164"><a href="#EPR-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-165"><a href="#EPR-165"><span class="linenos">165</span></a><span class="sd">        Exploration decay rate.</span>
</span><span id="EPR-166"><a href="#EPR-166"><span class="linenos">166</span></a>
</span><span id="EPR-167"><a href="#EPR-167"><span class="linenos">167</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-168"><a href="#EPR-168"><span class="linenos">168</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-169"><a href="#EPR-169"><span class="linenos">169</span></a><span class="sd">                float: The exploration decay rate (gamma &gt;= 0).</span>
</span><span id="EPR-170"><a href="#EPR-170"><span class="linenos">170</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-171"><a href="#EPR-171"><span class="linenos">171</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span>
</span><span id="EPR-172"><a href="#EPR-172"><span class="linenos">172</span></a>
</span><span id="EPR-173"><a href="#EPR-173"><span class="linenos">173</span></a>    <span class="nd">@property</span>
</span><span id="EPR-174"><a href="#EPR-174"><span class="linenos">174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR-175"><a href="#EPR-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-176"><a href="#EPR-176"><span class="linenos">176</span></a><span class="sd">        Waiting‑time exponent.</span>
</span><span id="EPR-177"><a href="#EPR-177"><span class="linenos">177</span></a>
</span><span id="EPR-178"><a href="#EPR-178"><span class="linenos">178</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-179"><a href="#EPR-179"><span class="linenos">179</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-180"><a href="#EPR-180"><span class="linenos">180</span></a><span class="sd">                float: The waiting‑time exponent (beta &gt;= 0).</span>
</span><span id="EPR-181"><a href="#EPR-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-182"><a href="#EPR-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span>
</span><span id="EPR-183"><a href="#EPR-183"><span class="linenos">183</span></a>
</span><span id="EPR-184"><a href="#EPR-184"><span class="linenos">184</span></a>    <span class="nd">@property</span>
</span><span id="EPR-185"><a href="#EPR-185"><span class="linenos">185</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tau</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR-186"><a href="#EPR-186"><span class="linenos">186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-187"><a href="#EPR-187"><span class="linenos">187</span></a><span class="sd">        Waiting‑time truncation in hours.</span>
</span><span id="EPR-188"><a href="#EPR-188"><span class="linenos">188</span></a>
</span><span id="EPR-189"><a href="#EPR-189"><span class="linenos">189</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-190"><a href="#EPR-190"><span class="linenos">190</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-191"><a href="#EPR-191"><span class="linenos">191</span></a><span class="sd">                int: The waiting‑time truncation in hours (tau &gt;= 1).</span>
</span><span id="EPR-192"><a href="#EPR-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-193"><a href="#EPR-193"><span class="linenos">193</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span>
</span><span id="EPR-194"><a href="#EPR-194"><span class="linenos">194</span></a>
</span><span id="EPR-195"><a href="#EPR-195"><span class="linenos">195</span></a>    <span class="nd">@property</span>
</span><span id="EPR-196"><a href="#EPR-196"><span class="linenos">196</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">min_waiting_time_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR-197"><a href="#EPR-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-198"><a href="#EPR-198"><span class="linenos">198</span></a><span class="sd">        Minimum waiting time in hours.</span>
</span><span id="EPR-199"><a href="#EPR-199"><span class="linenos">199</span></a>
</span><span id="EPR-200"><a href="#EPR-200"><span class="linenos">200</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-201"><a href="#EPR-201"><span class="linenos">201</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-202"><a href="#EPR-202"><span class="linenos">202</span></a><span class="sd">                float: The minimum waiting time in hours (min_waiting_time_hours &gt;= 0).</span>
</span><span id="EPR-203"><a href="#EPR-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-204"><a href="#EPR-204"><span class="linenos">204</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span>
</span><span id="EPR-205"><a href="#EPR-205"><span class="linenos">205</span></a>
</span><span id="EPR-206"><a href="#EPR-206"><span class="linenos">206</span></a>    <span class="nd">@property</span>
</span><span id="EPR-207"><a href="#EPR-207"><span class="linenos">207</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="EPR-208"><a href="#EPR-208"><span class="linenos">208</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-209"><a href="#EPR-209"><span class="linenos">209</span></a><span class="sd">        The raw trajectory list. Each entry is a list of: [iter, agent_id, timestamp, location].</span>
</span><span id="EPR-210"><a href="#EPR-210"><span class="linenos">210</span></a>
</span><span id="EPR-211"><a href="#EPR-211"><span class="linenos">211</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-212"><a href="#EPR-212"><span class="linenos">212</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-213"><a href="#EPR-213"><span class="linenos">213</span></a><span class="sd">                list[list]: The raw trajectory data.</span>
</span><span id="EPR-214"><a href="#EPR-214"><span class="linenos">214</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-215"><a href="#EPR-215"><span class="linenos">215</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span>
</span><span id="EPR-216"><a href="#EPR-216"><span class="linenos">216</span></a>
</span><span id="EPR-217"><a href="#EPR-217"><span class="linenos">217</span></a>    <span class="nd">@property</span>
</span><span id="EPR-218"><a href="#EPR-218"><span class="linenos">218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trajectories_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-219"><a href="#EPR-219"><span class="linenos">219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-220"><a href="#EPR-220"><span class="linenos">220</span></a><span class="sd">        The trajectory data as a pandas DataFrame with columns: iter, agent_id, timestamp, location.</span>
</span><span id="EPR-221"><a href="#EPR-221"><span class="linenos">221</span></a>
</span><span id="EPR-222"><a href="#EPR-222"><span class="linenos">222</span></a><span class="sd">        Getter:</span>
</span><span id="EPR-223"><a href="#EPR-223"><span class="linenos">223</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR-224"><a href="#EPR-224"><span class="linenos">224</span></a><span class="sd">                pd.DataFrame | None: The trajectory DataFrame, or None if not yet converted.</span>
</span><span id="EPR-225"><a href="#EPR-225"><span class="linenos">225</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-226"><a href="#EPR-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span>
</span><span id="EPR-227"><a href="#EPR-227"><span class="linenos">227</span></a>
</span><span id="EPR-228"><a href="#EPR-228"><span class="linenos">228</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trajectories_to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-229"><a href="#EPR-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-230"><a href="#EPR-230"><span class="linenos">230</span></a><span class="sd">        Convert the trajectory list to a pandas DataFrame. Stores the result in `self._trajectories_df`.</span>
</span><span id="EPR-231"><a href="#EPR-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-232"><a href="#EPR-232"><span class="linenos">232</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EPR-233"><a href="#EPR-233"><span class="linenos">233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">,</span>
</span><span id="EPR-234"><a href="#EPR-234"><span class="linenos">234</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">]</span>
</span><span id="EPR-235"><a href="#EPR-235"><span class="linenos">235</span></a>        <span class="p">)</span>
</span><span id="EPR-236"><a href="#EPR-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="o">=</span> <span class="n">df</span>
</span><span id="EPR-237"><a href="#EPR-237"><span class="linenos">237</span></a>
</span><span id="EPR-238"><a href="#EPR-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trajectories_to_geodataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="EPR-239"><a href="#EPR-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-240"><a href="#EPR-240"><span class="linenos">240</span></a><span class="sd">        Convert the trajectory DataFrame to a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="EPR-241"><a href="#EPR-241"><span class="linenos">241</span></a><span class="sd">        Requires that the tessellation is set and that the trajectories DataFrame is available.</span>
</span><span id="EPR-242"><a href="#EPR-242"><span class="linenos">242</span></a>
</span><span id="EPR-243"><a href="#EPR-243"><span class="linenos">243</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-244"><a href="#EPR-244"><span class="linenos">244</span></a><span class="sd">            gpd.GeoDataFrame: The trajectory data as a GeoDataFrame with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="EPR-245"><a href="#EPR-245"><span class="linenos">245</span></a><span class="sd">        Raises:</span>
</span><span id="EPR-246"><a href="#EPR-246"><span class="linenos">246</span></a><span class="sd">            ValueError: If the tessellation is not set or if the trajectories DataFrame is not available.</span>
</span><span id="EPR-247"><a href="#EPR-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-248"><a href="#EPR-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-249"><a href="#EPR-249"><span class="linenos">249</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tessellation is not set. Cannot convert trajectories to GeoDataFrame.&quot;</span><span class="p">)</span>
</span><span id="EPR-250"><a href="#EPR-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
</span><span id="EPR-251"><a href="#EPR-251"><span class="linenos">251</span></a>            <span class="n">projected_tessellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
</span><span id="EPR-252"><a href="#EPR-252"><span class="linenos">252</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EPR-253"><a href="#EPR-253"><span class="linenos">253</span></a>            <span class="n">projected_tessellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span>
</span><span id="EPR-254"><a href="#EPR-254"><span class="linenos">254</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">projected_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
</span><span id="EPR-255"><a href="#EPR-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="EPR-256"><a href="#EPR-256"><span class="linenos">256</span></a>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</span><span id="EPR-257"><a href="#EPR-257"><span class="linenos">257</span></a>        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
</span><span id="EPR-258"><a href="#EPR-258"><span class="linenos">258</span></a>        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span>
</span><span id="EPR-259"><a href="#EPR-259"><span class="linenos">259</span></a>
</span><span id="EPR-260"><a href="#EPR-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="n">gdf</span><span class="p">[[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span>
</span><span id="EPR-261"><a href="#EPR-261"><span class="linenos">261</span></a>
</span><span id="EPR-262"><a href="#EPR-262"><span class="linenos">262</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-263"><a href="#EPR-263"><span class="linenos">263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-264"><a href="#EPR-264"><span class="linenos">264</span></a><span class="sd">        Expand the trajectory to hourly steps between start_date and end_date.</span>
</span><span id="EPR-265"><a href="#EPR-265"><span class="linenos">265</span></a><span class="sd">        Fills in missing hours by forward-filling the last known location.</span>
</span><span id="EPR-266"><a href="#EPR-266"><span class="linenos">266</span></a>
</span><span id="EPR-267"><a href="#EPR-267"><span class="linenos">267</span></a><span class="sd">        Args:</span>
</span><span id="EPR-268"><a href="#EPR-268"><span class="linenos">268</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="EPR-269"><a href="#EPR-269"><span class="linenos">269</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="EPR-270"><a href="#EPR-270"><span class="linenos">270</span></a><span class="sd">        Raises:</span>
</span><span id="EPR-271"><a href="#EPR-271"><span class="linenos">271</span></a><span class="sd">            ValueError: If the trajectories DataFrame is not available.</span>
</span><span id="EPR-272"><a href="#EPR-272"><span class="linenos">272</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-273"><a href="#EPR-273"><span class="linenos">273</span></a><span class="sd">            None: The method updates `self._trajectories_df` in place.</span>
</span><span id="EPR-274"><a href="#EPR-274"><span class="linenos">274</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-275"><a href="#EPR-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-276"><a href="#EPR-276"><span class="linenos">276</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trajectories DataFrame is not available. Cannot expand to hourly steps.&quot;</span><span class="p">)</span>
</span><span id="EPR-277"><a href="#EPR-277"><span class="linenos">277</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
</span><span id="EPR-278"><a href="#EPR-278"><span class="linenos">278</span></a>
</span><span id="EPR-279"><a href="#EPR-279"><span class="linenos">279</span></a>        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EPR-280"><a href="#EPR-280"><span class="linenos">280</span></a>
</span><span id="EPR-281"><a href="#EPR-281"><span class="linenos">281</span></a>        <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;agent_id&quot;</span><span class="p">):</span>
</span><span id="EPR-282"><a href="#EPR-282"><span class="linenos">282</span></a>            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)[[</span><span class="s2">&quot;location&quot;</span><span class="p">]]</span>
</span><span id="EPR-283"><a href="#EPR-283"><span class="linenos">283</span></a>
</span><span id="EPR-284"><a href="#EPR-284"><span class="linenos">284</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span><span id="EPR-285"><a href="#EPR-285"><span class="linenos">285</span></a>
</span><span id="EPR-286"><a href="#EPR-286"><span class="linenos">286</span></a>            <span class="n">all_hours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="EPR-287"><a href="#EPR-287"><span class="linenos">287</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">all_hours</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>
</span><span id="EPR-288"><a href="#EPR-288"><span class="linenos">288</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">})</span>
</span><span id="EPR-289"><a href="#EPR-289"><span class="linenos">289</span></a>
</span><span id="EPR-290"><a href="#EPR-290"><span class="linenos">290</span></a>            <span class="n">resampled</span><span class="p">[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>
</span><span id="EPR-291"><a href="#EPR-291"><span class="linenos">291</span></a>            <span class="n">resampled</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resampled</span><span class="p">))</span>
</span><span id="EPR-292"><a href="#EPR-292"><span class="linenos">292</span></a>            <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resampled</span><span class="p">)</span>
</span><span id="EPR-293"><a href="#EPR-293"><span class="linenos">293</span></a>
</span><span id="EPR-294"><a href="#EPR-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EPR-295"><a href="#EPR-295"><span class="linenos">295</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EPR-296"><a href="#EPR-296"><span class="linenos">296</span></a>            <span class="k">if</span> <span class="n">expanded</span> <span class="k">else</span>
</span><span id="EPR-297"><a href="#EPR-297"><span class="linenos">297</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;iter&quot;</span><span class="p">])</span>
</span><span id="EPR-298"><a href="#EPR-298"><span class="linenos">298</span></a>        <span class="p">)</span>
</span><span id="EPR-299"><a href="#EPR-299"><span class="linenos">299</span></a>
</span><span id="EPR-300"><a href="#EPR-300"><span class="linenos">300</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_wait_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR-301"><a href="#EPR-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-302"><a href="#EPR-302"><span class="linenos">302</span></a><span class="sd">        Draw a single waiting time (in hours) from a truncated power law.</span>
</span><span id="EPR-303"><a href="#EPR-303"><span class="linenos">303</span></a>
</span><span id="EPR-304"><a href="#EPR-304"><span class="linenos">304</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-305"><a href="#EPR-305"><span class="linenos">305</span></a><span class="sd">            float: A sampled waiting time in hours.</span>
</span><span id="EPR-306"><a href="#EPR-306"><span class="linenos">306</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-307"><a href="#EPR-307"><span class="linenos">307</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">powerlaw</span><span class="o">.</span><span class="n">Truncated_Power_Law</span><span class="p">(</span>
</span><span id="EPR-308"><a href="#EPR-308"><span class="linenos">308</span></a>            <span class="n">xmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">]</span>
</span><span id="EPR-309"><a href="#EPR-309"><span class="linenos">309</span></a>        <span class="p">)</span>
</span><span id="EPR-310"><a href="#EPR-310"><span class="linenos">310</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">generate_random</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="EPR-311"><a href="#EPR-311"><span class="linenos">311</span></a>
</span><span id="EPR-312"><a href="#EPR-312"><span class="linenos">312</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_wait_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
</span><span id="EPR-313"><a href="#EPR-313"><span class="linenos">313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-314"><a href="#EPR-314"><span class="linenos">314</span></a><span class="sd">        Return waiting time as ``datetime.timedelta``. Uses `_sample_wait_hours()` internally.</span>
</span><span id="EPR-315"><a href="#EPR-315"><span class="linenos">315</span></a>
</span><span id="EPR-316"><a href="#EPR-316"><span class="linenos">316</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-317"><a href="#EPR-317"><span class="linenos">317</span></a><span class="sd">            timedelta: A sampled waiting time as a timedelta object.</span>
</span><span id="EPR-318"><a href="#EPR-318"><span class="linenos">318</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-319"><a href="#EPR-319"><span class="linenos">319</span></a>        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_wait_hours</span><span class="p">())</span>
</span><span id="EPR-320"><a href="#EPR-320"><span class="linenos">320</span></a>
</span><span id="EPR-321"><a href="#EPR-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_preferential_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR-322"><a href="#EPR-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-323"><a href="#EPR-323"><span class="linenos">323</span></a><span class="sd">        Select a *visited* cell according to visitation frequencies. Excludes the current location.</span>
</span><span id="EPR-324"><a href="#EPR-324"><span class="linenos">324</span></a>
</span><span id="EPR-325"><a href="#EPR-325"><span class="linenos">325</span></a><span class="sd">        Args:</span>
</span><span id="EPR-326"><a href="#EPR-326"><span class="linenos">326</span></a><span class="sd">            current_loc (int): The agent&#39;s current location index.</span>
</span><span id="EPR-327"><a href="#EPR-327"><span class="linenos">327</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-328"><a href="#EPR-328"><span class="linenos">328</span></a><span class="sd">            int: The selected location index.</span>
</span><span id="EPR-329"><a href="#EPR-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-330"><a href="#EPR-330"><span class="linenos">330</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="o">.</span><span class="n">visited_locations</span>
</span><span id="EPR-331"><a href="#EPR-331"><span class="linenos">331</span></a>        <span class="n">locs</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">visited</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">current_loc</span><span class="p">))</span>
</span><span id="EPR-332"><a href="#EPR-332"><span class="linenos">332</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="EPR-333"><a href="#EPR-333"><span class="linenos">333</span></a>        <span class="n">probs</span> <span class="o">/=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="EPR-334"><a href="#EPR-334"><span class="linenos">334</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
</span><span id="EPR-335"><a href="#EPR-335"><span class="linenos">335</span></a>
</span><span id="EPR-336"><a href="#EPR-336"><span class="linenos">336</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_explore_new_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR-337"><a href="#EPR-337"><span class="linenos">337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-338"><a href="#EPR-338"><span class="linenos">338</span></a><span class="sd">        Pick a *new* location using (cached) OD probabilities. If the OD row for the current location is not yet</span>
</span><span id="EPR-339"><a href="#EPR-339"><span class="linenos">339</span></a><span class="sd">        computed, it will be calculated on‑demand. Excludes the current location from possible destinations. If no other</span>
</span><span id="EPR-340"><a href="#EPR-340"><span class="linenos">340</span></a><span class="sd">        locations are available (e.g., only one cell in tessellation), returns the current location.</span>
</span><span id="EPR-341"><a href="#EPR-341"><span class="linenos">341</span></a>
</span><span id="EPR-342"><a href="#EPR-342"><span class="linenos">342</span></a><span class="sd">        Args:</span>
</span><span id="EPR-343"><a href="#EPR-343"><span class="linenos">343</span></a><span class="sd">            current_loc (int): The agent&#39;s current location index.</span>
</span><span id="EPR-344"><a href="#EPR-344"><span class="linenos">344</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-345"><a href="#EPR-345"><span class="linenos">345</span></a><span class="sd">            int: The selected new location index. If no new location is available, returns `current_loc`.</span>
</span><span id="EPR-346"><a href="#EPR-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-347"><a href="#EPR-347"><span class="linenos">347</span></a>        <span class="c1"># Retrieve or lazily compute probability vector for this origin.</span>
</span><span id="EPR-348"><a href="#EPR-348"><span class="linenos">348</span></a>        <span class="n">od_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="o">.</span><span class="n">getrowview</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="EPR-349"><a href="#EPR-349"><span class="linenos">349</span></a>        <span class="k">if</span> <span class="n">od_row</span><span class="o">.</span><span class="n">nnz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EPR-350"><a href="#EPR-350"><span class="linenos">350</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">compute_od_row</span><span class="p">(</span><span class="n">current_loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span><span class="p">,</span>
</span><span id="EPR-351"><a href="#EPR-351"><span class="linenos">351</span></a>                                   <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
</span><span id="EPR-352"><a href="#EPR-352"><span class="linenos">352</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="p">[</span><span class="n">current_loc</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">probs</span>
</span><span id="EPR-353"><a href="#EPR-353"><span class="linenos">353</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EPR-354"><a href="#EPR-354"><span class="linenos">354</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">od_row</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="EPR-355"><a href="#EPR-355"><span class="linenos">355</span></a>
</span><span id="EPR-356"><a href="#EPR-356"><span class="linenos">356</span></a>        <span class="n">destinations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">))</span>
</span><span id="EPR-357"><a href="#EPR-357"><span class="linenos">357</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
</span><span id="EPR-358"><a href="#EPR-358"><span class="linenos">358</span></a>
</span><span id="EPR-359"><a href="#EPR-359"><span class="linenos">359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_choose_next_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR-360"><a href="#EPR-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-361"><a href="#EPR-361"><span class="linenos">361</span></a><span class="sd">        Decide whether to *explore* or *return*, then pick the destination. The exploration probability decays with</span>
</span><span id="EPR-362"><a href="#EPR-362"><span class="linenos">362</span></a><span class="sd">        the number of unique visited locations. If exploring, a new location is chosen using the OD matrix;</span>
</span><span id="EPR-363"><a href="#EPR-363"><span class="linenos">363</span></a><span class="sd">        if returning, a previously visited location is selected based on visitation frequency. If no new locations</span>
</span><span id="EPR-364"><a href="#EPR-364"><span class="linenos">364</span></a><span class="sd">        are available, the agent will return to a visited location.</span>
</span><span id="EPR-365"><a href="#EPR-365"><span class="linenos">365</span></a>
</span><span id="EPR-366"><a href="#EPR-366"><span class="linenos">366</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-367"><a href="#EPR-367"><span class="linenos">367</span></a><span class="sd">            int: The selected next location index.</span>
</span><span id="EPR-368"><a href="#EPR-368"><span class="linenos">368</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-369"><a href="#EPR-369"><span class="linenos">369</span></a>        <span class="n">num_visited</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">)</span>
</span><span id="EPR-370"><a href="#EPR-370"><span class="linenos">370</span></a>        <span class="c1"># First step: explore from the starting cell</span>
</span><span id="EPR-371"><a href="#EPR-371"><span class="linenos">371</span></a>        <span class="k">if</span> <span class="n">num_visited</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EPR-372"><a href="#EPR-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explore_new_location</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">)</span>
</span><span id="EPR-373"><a href="#EPR-373"><span class="linenos">373</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span>
</span><span id="EPR-374"><a href="#EPR-374"><span class="linenos">374</span></a>
</span><span id="EPR-375"><a href="#EPR-375"><span class="linenos">375</span></a>        <span class="o">*</span><span class="n">_prev</span><span class="p">,</span> <span class="n">current_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="EPR-376"><a href="#EPR-376"><span class="linenos">376</span></a>
</span><span id="EPR-377"><a href="#EPR-377"><span class="linenos">377</span></a>        <span class="c1"># Exploration probability decays with #visited locations (Song et al.)</span>
</span><span id="EPR-378"><a href="#EPR-378"><span class="linenos">378</span></a>        <span class="n">p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
</span><span id="EPR-379"><a href="#EPR-379"><span class="linenos">379</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">num_visited</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">)</span>
</span><span id="EPR-380"><a href="#EPR-380"><span class="linenos">380</span></a>        <span class="n">explore_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_new</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">num_visited</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">num_visited</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="EPR-381"><a href="#EPR-381"><span class="linenos">381</span></a>
</span><span id="EPR-382"><a href="#EPR-382"><span class="linenos">382</span></a>        <span class="k">if</span> <span class="n">explore_flag</span><span class="p">:</span>
</span><span id="EPR-383"><a href="#EPR-383"><span class="linenos">383</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explore_new_location</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="EPR-384"><a href="#EPR-384"><span class="linenos">384</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_preferential_location</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="EPR-385"><a href="#EPR-385"><span class="linenos">385</span></a>
</span><span id="EPR-386"><a href="#EPR-386"><span class="linenos">386</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="EPR-387"><a href="#EPR-387"><span class="linenos">387</span></a>                                      <span class="n">tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EPR-388"><a href="#EPR-388"><span class="linenos">388</span></a>                                      <span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">od_matrix</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EPR-389"><a href="#EPR-389"><span class="linenos">389</span></a>                                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="EPR-390"><a href="#EPR-390"><span class="linenos">390</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-391"><a href="#EPR-391"><span class="linenos">391</span></a><span class="sd">        Simulate trajectories for *n_agents* between *start_date* and *end_date*. Each agent starts from a specified or</span>
</span><span id="EPR-392"><a href="#EPR-392"><span class="linenos">392</span></a><span class="sd">        random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity</span>
</span><span id="EPR-393"><a href="#EPR-393"><span class="linenos">393</span></a><span class="sd">        model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="EPR-394"><a href="#EPR-394"><span class="linenos">394</span></a>
</span><span id="EPR-395"><a href="#EPR-395"><span class="linenos">395</span></a><span class="sd">        Args:</span>
</span><span id="EPR-396"><a href="#EPR-396"><span class="linenos">396</span></a><span class="sd">            n_agents (int): Number of agents to simulate.</span>
</span><span id="EPR-397"><a href="#EPR-397"><span class="linenos">397</span></a><span class="sd">            start_date (datetime): Start date of the simulation period.</span>
</span><span id="EPR-398"><a href="#EPR-398"><span class="linenos">398</span></a><span class="sd">            end_date (datetime): End date of the simulation period.</span>
</span><span id="EPR-399"><a href="#EPR-399"><span class="linenos">399</span></a><span class="sd">            tessellation (gpd.GeoDataFrame): Spatial tessellation with a geometry column and an attractiveness column.</span>
</span><span id="EPR-400"><a href="#EPR-400"><span class="linenos">400</span></a><span class="sd">            gravity_model (Gravity | None): An optional Gravity model instance. If None, a default singly-constrained model is used.</span>
</span><span id="EPR-401"><a href="#EPR-401"><span class="linenos">401</span></a><span class="sd">            starting_cells (list[int] | None): Optional list of starting cell indices for agents. If provided, must have at least `n_agents` elements. If None, starting cells are chosen randomly.</span>
</span><span id="EPR-402"><a href="#EPR-402"><span class="linenos">402</span></a><span class="sd">            od_matrix (lil_matrix | None): Optional precomputed OD matrix. If None, it will be computed on‑demand.</span>
</span><span id="EPR-403"><a href="#EPR-403"><span class="linenos">403</span></a><span class="sd">            random_state (int | None): Optional random seed for reproducibility.</span>
</span><span id="EPR-404"><a href="#EPR-404"><span class="linenos">404</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-405"><a href="#EPR-405"><span class="linenos">405</span></a><span class="sd">            gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="EPR-406"><a href="#EPR-406"><span class="linenos">406</span></a><span class="sd">        Raises:</span>
</span><span id="EPR-407"><a href="#EPR-407"><span class="linenos">407</span></a><span class="sd">            ValueError: If `starting_cells` is provided but has fewer than `n_agents` elements.</span>
</span><span id="EPR-408"><a href="#EPR-408"><span class="linenos">408</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-409"><a href="#EPR-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_agents</span><span class="p">:</span>
</span><span id="EPR-410"><a href="#EPR-410"><span class="linenos">410</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;starting_cells&#39; must contain at least &#39;n_agents&#39; elements.&quot;</span><span class="p">)</span>
</span><span id="EPR-411"><a href="#EPR-411"><span class="linenos">411</span></a>
</span><span id="EPR-412"><a href="#EPR-412"><span class="linenos">412</span></a>        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-413"><a href="#EPR-413"><span class="linenos">413</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
</span><span id="EPR-414"><a href="#EPR-414"><span class="linenos">414</span></a>
</span><span id="EPR-415"><a href="#EPR-415"><span class="linenos">415</span></a>        <span class="c1"># Spatial context</span>
</span><span id="EPR-416"><a href="#EPR-416"><span class="linenos">416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="o">=</span> <span class="n">tessellation</span>
</span><span id="EPR-417"><a href="#EPR-417"><span class="linenos">417</span></a>        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">)</span>
</span><span id="EPR-418"><a href="#EPR-418"><span class="linenos">418</span></a>
</span><span id="EPR-419"><a href="#EPR-419"><span class="linenos">419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</span><span id="EPR-420"><a href="#EPR-420"><span class="linenos">420</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_geom_centroid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</span><span id="EPR-421"><a href="#EPR-421"><span class="linenos">421</span></a>
</span><span id="EPR-422"><a href="#EPR-422"><span class="linenos">422</span></a>        <span class="c1"># Gravity model (lazily created)</span>
</span><span id="EPR-423"><a href="#EPR-423"><span class="linenos">423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="n">gravity_model</span> <span class="ow">or</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;singly constrained&quot;</span><span class="p">)</span>
</span><span id="EPR-424"><a href="#EPR-424"><span class="linenos">424</span></a>
</span><span id="EPR-425"><a href="#EPR-425"><span class="linenos">425</span></a>        <span class="c1"># OD matrix initialisation</span>
</span><span id="EPR-426"><a href="#EPR-426"><span class="linenos">426</span></a>        <span class="k">if</span> <span class="n">od_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-427"><a href="#EPR-427"><span class="linenos">427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">))</span>
</span><span id="EPR-428"><a href="#EPR-428"><span class="linenos">428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EPR-429"><a href="#EPR-429"><span class="linenos">429</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EPR-430"><a href="#EPR-430"><span class="linenos">430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">od_matrix</span>
</span><span id="EPR-431"><a href="#EPR-431"><span class="linenos">431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="EPR-432"><a href="#EPR-432"><span class="linenos">432</span></a>
</span><span id="EPR-433"><a href="#EPR-433"><span class="linenos">433</span></a>        <span class="c1"># Simulate each agent separately</span>
</span><span id="EPR-434"><a href="#EPR-434"><span class="linenos">434</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trajectory generation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="EPR-435"><a href="#EPR-435"><span class="linenos">435</span></a>            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="EPR-436"><a href="#EPR-436"><span class="linenos">436</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EPR-437"><a href="#EPR-437"><span class="linenos">437</span></a>                    <span class="n">starting_cells</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
</span><span id="EPR-438"><a href="#EPR-438"><span class="linenos">438</span></a>                <span class="p">)</span>
</span><span id="EPR-439"><a href="#EPR-439"><span class="linenos">439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</span><span id="EPR-440"><a href="#EPR-440"><span class="linenos">440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="EPR-441"><a href="#EPR-441"><span class="linenos">441</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EPR-442"><a href="#EPR-442"><span class="linenos">442</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_dataframe</span><span class="p">()</span>
</span><span id="EPR-443"><a href="#EPR-443"><span class="linenos">443</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="EPR-444"><a href="#EPR-444"><span class="linenos">444</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_geodataframe</span><span class="p">()</span>
</span><span id="EPR-445"><a href="#EPR-445"><span class="linenos">445</span></a>
</span><span id="EPR-446"><a href="#EPR-446"><span class="linenos">446</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR-447"><a href="#EPR-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR-448"><a href="#EPR-448"><span class="linenos">448</span></a><span class="sd">        Run the event‑based simulation loop for a single agent. The agent starts at the specified starting cell and</span>
</span><span id="EPR-449"><a href="#EPR-449"><span class="linenos">449</span></a><span class="sd">        iteratively decides to explore new locations or return to previously visited ones, based on the EPR model&#39;s</span>
</span><span id="EPR-450"><a href="#EPR-450"><span class="linenos">450</span></a><span class="sd">        probabilities. The agent waits at each location for a time drawn from a truncated power law distribution before</span>
</span><span id="EPR-451"><a href="#EPR-451"><span class="linenos">451</span></a><span class="sd">        moving again. The trajectory is recorded in `self._trajectories`.</span>
</span><span id="EPR-452"><a href="#EPR-452"><span class="linenos">452</span></a>
</span><span id="EPR-453"><a href="#EPR-453"><span class="linenos">453</span></a><span class="sd">        Args:</span>
</span><span id="EPR-454"><a href="#EPR-454"><span class="linenos">454</span></a><span class="sd">            agent (Agent): The agent to simulate.</span>
</span><span id="EPR-455"><a href="#EPR-455"><span class="linenos">455</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="EPR-456"><a href="#EPR-456"><span class="linenos">456</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="EPR-457"><a href="#EPR-457"><span class="linenos">457</span></a><span class="sd">        Returns:</span>
</span><span id="EPR-458"><a href="#EPR-458"><span class="linenos">458</span></a><span class="sd">            None: The method updates `self._trajectories` in place.</span>
</span><span id="EPR-459"><a href="#EPR-459"><span class="linenos">459</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR-460"><a href="#EPR-460"><span class="linenos">460</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_date</span>
</span><span id="EPR-461"><a href="#EPR-461"><span class="linenos">461</span></a>        <span class="n">iter_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="EPR-462"><a href="#EPR-462"><span class="linenos">462</span></a>
</span><span id="EPR-463"><a href="#EPR-463"><span class="linenos">463</span></a>        <span class="c1"># First record — agent starts at *start* timestamp</span>
</span><span id="EPR-464"><a href="#EPR-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">])</span>
</span><span id="EPR-465"><a href="#EPR-465"><span class="linenos">465</span></a>        <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="EPR-466"><a href="#EPR-466"><span class="linenos">466</span></a>
</span><span id="EPR-467"><a href="#EPR-467"><span class="linenos">467</span></a>        <span class="c1"># Iterate until *end_date*</span>
</span><span id="EPR-468"><a href="#EPR-468"><span class="linenos">468</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="EPR-469"><a href="#EPR-469"><span class="linenos">469</span></a>            <span class="n">current_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_wait_delta</span><span class="p">()</span>
</span><span id="EPR-470"><a href="#EPR-470"><span class="linenos">470</span></a>            <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="n">end_date</span><span class="p">:</span>
</span><span id="EPR-471"><a href="#EPR-471"><span class="linenos">471</span></a>                <span class="k">break</span>
</span><span id="EPR-472"><a href="#EPR-472"><span class="linenos">472</span></a>
</span><span id="EPR-473"><a href="#EPR-473"><span class="linenos">473</span></a>            <span class="n">iter_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="EPR-474"><a href="#EPR-474"><span class="linenos">474</span></a>            <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_next_location</span><span class="p">()</span>
</span><span id="EPR-475"><a href="#EPR-475"><span class="linenos">475</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="n">next_loc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="EPR-476"><a href="#EPR-476"><span class="linenos">476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">])</span>
</span><span id="EPR-477"><a href="#EPR-477"><span class="linenos">477</span></a>
</span><span id="EPR-478"><a href="#EPR-478"><span class="linenos">478</span></a>    <span class="n">pick_preferential_location</span> <span class="o">=</span> <span class="n">_pick_preferential_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="EPR-479"><a href="#EPR-479"><span class="linenos">479</span></a>    <span class="n">explore_new_location</span> <span class="o">=</span> <span class="n">_explore_new_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="EPR-480"><a href="#EPR-480"><span class="linenos">480</span></a>    <span class="n">choose_next_location</span> <span class="o">=</span> <span class="n">_choose_next_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="EPR-481"><a href="#EPR-481"><span class="linenos">481</span></a>    <span class="n">simulate_agent_trajectory</span> <span class="o">=</span> <span class="n">_simulate_agent_trajectory</span>  <span class="c1"># Expose for docs</span>
</span></pre></div>


            <div class="docstring"><p>Exploration &amp; Preferential Return (EPR) mobility model.</p>

<p>Implements the mechanism described in <em>Song et al., 2010</em> with an optional
on‑demand gravity‑based OD matrix.</p>
</div>


                            <div id="EPR.__init__" class="classattr">
                                        <input id="EPR.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EPR</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config</span><span class="p">:</span> <span class="n"><a href="#EPRConfig">EPRConfig</a></span></span>)</span>

                <label class="view-source-button" for="EPR.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.__init__-114"><a href="#EPR.__init__-114"><span class="linenos">114</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EPRConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.__init__-115"><a href="#EPR.__init__-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.__init__-116"><a href="#EPR.__init__-116"><span class="linenos">116</span></a><span class="sd">        Initialize the EPR model with the given configuration.</span>
</span><span id="EPR.__init__-117"><a href="#EPR.__init__-117"><span class="linenos">117</span></a>
</span><span id="EPR.__init__-118"><a href="#EPR.__init__-118"><span class="linenos">118</span></a><span class="sd">        Args:</span>
</span><span id="EPR.__init__-119"><a href="#EPR.__init__-119"><span class="linenos">119</span></a><span class="sd">            config (EPRConfig): Configuration parameters for the EPR model.</span>
</span><span id="EPR.__init__-120"><a href="#EPR.__init__-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.__init__-121"><a href="#EPR.__init__-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span id="EPR.__init__-122"><a href="#EPR.__init__-122"><span class="linenos">122</span></a>
</span><span id="EPR.__init__-123"><a href="#EPR.__init__-123"><span class="linenos">123</span></a>        <span class="c1"># Hyper-parameters</span>
</span><span id="EPR.__init__-124"><a href="#EPR.__init__-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">rho</span>
</span><span id="EPR.__init__-125"><a href="#EPR.__init__-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">gamma</span>
</span><span id="EPR.__init__-126"><a href="#EPR.__init__-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">beta</span>
</span><span id="EPR.__init__-127"><a href="#EPR.__init__-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tau</span>
</span><span id="EPR.__init__-128"><a href="#EPR.__init__-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">min_waiting_time_minutes</span> <span class="o">/</span> <span class="mf">60.0</span>
</span><span id="EPR.__init__-129"><a href="#EPR.__init__-129"><span class="linenos">129</span></a>
</span><span id="EPR.__init__-130"><a href="#EPR.__init__-130"><span class="linenos">130</span></a>        <span class="c1"># Spatial context</span>
</span><span id="EPR.__init__-131"><a href="#EPR.__init__-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_with_attractiveness_raster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">simulation_with_attractiveness_raster</span>
</span><span id="EPR.__init__-132"><a href="#EPR.__init__-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">attractiveness_raster_path</span>
</span><span id="EPR.__init__-133"><a href="#EPR.__init__-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-134"><a href="#EPR.__init__-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-135"><a href="#EPR.__init__-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-136"><a href="#EPR.__init__-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">tessellation_attractiveness_column</span>
</span><span id="EPR.__init__-137"><a href="#EPR.__init__-137"><span class="linenos">137</span></a>
</span><span id="EPR.__init__-138"><a href="#EPR.__init__-138"><span class="linenos">138</span></a>        <span class="c1"># OD matrix (lazy)</span>
</span><span id="EPR.__init__-139"><a href="#EPR.__init__-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-140"><a href="#EPR.__init__-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EPR.__init__-141"><a href="#EPR.__init__-141"><span class="linenos">141</span></a>
</span><span id="EPR.__init__-142"><a href="#EPR.__init__-142"><span class="linenos">142</span></a>        <span class="c1"># Agent state (updated per‑agent iteration)</span>
</span><span id="EPR.__init__-143"><a href="#EPR.__init__-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-144"><a href="#EPR.__init__-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">:</span> <span class="n">Agent</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-145"><a href="#EPR.__init__-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EPR.__init__-146"><a href="#EPR.__init__-146"><span class="linenos">146</span></a>
</span><span id="EPR.__init__-147"><a href="#EPR.__init__-147"><span class="linenos">147</span></a>        <span class="c1"># Output trajectory buffer: [iter, agent_id, timestamp, location]</span>
</span><span id="EPR.__init__-148"><a href="#EPR.__init__-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EPR.__init__-149"><a href="#EPR.__init__-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the EPR model with the given configuration.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>config (EPRConfig):</strong>  Configuration parameters for the EPR model.</li>
</ul>
</div>


                            </div>
                            <div id="EPR.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#EPR.name"></a>
    
    

                            </div>
                            <div id="EPR.rho" class="classattr">
                                        <input id="EPR.rho-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">rho</span><span class="annotation">: float</span>

                <label class="view-source-button" for="EPR.rho-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.rho"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.rho-151"><a href="#EPR.rho-151"><span class="linenos">151</span></a>    <span class="nd">@property</span>
</span><span id="EPR.rho-152"><a href="#EPR.rho-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rho</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR.rho-153"><a href="#EPR.rho-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.rho-154"><a href="#EPR.rho-154"><span class="linenos">154</span></a><span class="sd">        Base exploration probability.</span>
</span><span id="EPR.rho-155"><a href="#EPR.rho-155"><span class="linenos">155</span></a>
</span><span id="EPR.rho-156"><a href="#EPR.rho-156"><span class="linenos">156</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.rho-157"><a href="#EPR.rho-157"><span class="linenos">157</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.rho-158"><a href="#EPR.rho-158"><span class="linenos">158</span></a><span class="sd">                float: The base exploration probability (0 &lt;= rho &lt;= 1).</span>
</span><span id="EPR.rho-159"><a href="#EPR.rho-159"><span class="linenos">159</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.rho-160"><a href="#EPR.rho-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span>
</span></pre></div>


            <div class="docstring"><p>Base exploration probability.</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      float: The base exploration probability (0 &lt;= rho &lt;= 1).</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.gamma" class="classattr">
                                        <input id="EPR.gamma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">gamma</span><span class="annotation">: float</span>

                <label class="view-source-button" for="EPR.gamma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.gamma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.gamma-162"><a href="#EPR.gamma-162"><span class="linenos">162</span></a>    <span class="nd">@property</span>
</span><span id="EPR.gamma-163"><a href="#EPR.gamma-163"><span class="linenos">163</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gamma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR.gamma-164"><a href="#EPR.gamma-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.gamma-165"><a href="#EPR.gamma-165"><span class="linenos">165</span></a><span class="sd">        Exploration decay rate.</span>
</span><span id="EPR.gamma-166"><a href="#EPR.gamma-166"><span class="linenos">166</span></a>
</span><span id="EPR.gamma-167"><a href="#EPR.gamma-167"><span class="linenos">167</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.gamma-168"><a href="#EPR.gamma-168"><span class="linenos">168</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.gamma-169"><a href="#EPR.gamma-169"><span class="linenos">169</span></a><span class="sd">                float: The exploration decay rate (gamma &gt;= 0).</span>
</span><span id="EPR.gamma-170"><a href="#EPR.gamma-170"><span class="linenos">170</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.gamma-171"><a href="#EPR.gamma-171"><span class="linenos">171</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span>
</span></pre></div>


            <div class="docstring"><p>Exploration decay rate.</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      float: The exploration decay rate (gamma &gt;= 0).</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.beta" class="classattr">
                                        <input id="EPR.beta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">beta</span><span class="annotation">: float</span>

                <label class="view-source-button" for="EPR.beta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.beta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.beta-173"><a href="#EPR.beta-173"><span class="linenos">173</span></a>    <span class="nd">@property</span>
</span><span id="EPR.beta-174"><a href="#EPR.beta-174"><span class="linenos">174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR.beta-175"><a href="#EPR.beta-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.beta-176"><a href="#EPR.beta-176"><span class="linenos">176</span></a><span class="sd">        Waiting‑time exponent.</span>
</span><span id="EPR.beta-177"><a href="#EPR.beta-177"><span class="linenos">177</span></a>
</span><span id="EPR.beta-178"><a href="#EPR.beta-178"><span class="linenos">178</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.beta-179"><a href="#EPR.beta-179"><span class="linenos">179</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.beta-180"><a href="#EPR.beta-180"><span class="linenos">180</span></a><span class="sd">                float: The waiting‑time exponent (beta &gt;= 0).</span>
</span><span id="EPR.beta-181"><a href="#EPR.beta-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.beta-182"><a href="#EPR.beta-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span>
</span></pre></div>


            <div class="docstring"><p>Waiting‑time exponent.</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      float: The waiting‑time exponent (beta &gt;= 0).</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.tau" class="classattr">
                                        <input id="EPR.tau-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">tau</span><span class="annotation">: int</span>

                <label class="view-source-button" for="EPR.tau-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.tau"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.tau-184"><a href="#EPR.tau-184"><span class="linenos">184</span></a>    <span class="nd">@property</span>
</span><span id="EPR.tau-185"><a href="#EPR.tau-185"><span class="linenos">185</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tau</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR.tau-186"><a href="#EPR.tau-186"><span class="linenos">186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.tau-187"><a href="#EPR.tau-187"><span class="linenos">187</span></a><span class="sd">        Waiting‑time truncation in hours.</span>
</span><span id="EPR.tau-188"><a href="#EPR.tau-188"><span class="linenos">188</span></a>
</span><span id="EPR.tau-189"><a href="#EPR.tau-189"><span class="linenos">189</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.tau-190"><a href="#EPR.tau-190"><span class="linenos">190</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.tau-191"><a href="#EPR.tau-191"><span class="linenos">191</span></a><span class="sd">                int: The waiting‑time truncation in hours (tau &gt;= 1).</span>
</span><span id="EPR.tau-192"><a href="#EPR.tau-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.tau-193"><a href="#EPR.tau-193"><span class="linenos">193</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau</span>
</span></pre></div>


            <div class="docstring"><p>Waiting‑time truncation in hours.</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      int: The waiting‑time truncation in hours (tau &gt;= 1).</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.min_waiting_time_hours" class="classattr">
                                        <input id="EPR.min_waiting_time_hours-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">min_waiting_time_hours</span><span class="annotation">: float</span>

                <label class="view-source-button" for="EPR.min_waiting_time_hours-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.min_waiting_time_hours"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.min_waiting_time_hours-195"><a href="#EPR.min_waiting_time_hours-195"><span class="linenos">195</span></a>    <span class="nd">@property</span>
</span><span id="EPR.min_waiting_time_hours-196"><a href="#EPR.min_waiting_time_hours-196"><span class="linenos">196</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">min_waiting_time_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="EPR.min_waiting_time_hours-197"><a href="#EPR.min_waiting_time_hours-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.min_waiting_time_hours-198"><a href="#EPR.min_waiting_time_hours-198"><span class="linenos">198</span></a><span class="sd">        Minimum waiting time in hours.</span>
</span><span id="EPR.min_waiting_time_hours-199"><a href="#EPR.min_waiting_time_hours-199"><span class="linenos">199</span></a>
</span><span id="EPR.min_waiting_time_hours-200"><a href="#EPR.min_waiting_time_hours-200"><span class="linenos">200</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.min_waiting_time_hours-201"><a href="#EPR.min_waiting_time_hours-201"><span class="linenos">201</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.min_waiting_time_hours-202"><a href="#EPR.min_waiting_time_hours-202"><span class="linenos">202</span></a><span class="sd">                float: The minimum waiting time in hours (min_waiting_time_hours &gt;= 0).</span>
</span><span id="EPR.min_waiting_time_hours-203"><a href="#EPR.min_waiting_time_hours-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.min_waiting_time_hours-204"><a href="#EPR.min_waiting_time_hours-204"><span class="linenos">204</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_waiting_time_hours</span>
</span></pre></div>


            <div class="docstring"><p>Minimum waiting time in hours.</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      float: The minimum waiting time in hours (min_waiting_time_hours &gt;= 0).</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.trajectories" class="classattr">
                                        <input id="EPR.trajectories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">trajectories</span><span class="annotation">: list[list]</span>

                <label class="view-source-button" for="EPR.trajectories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.trajectories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.trajectories-206"><a href="#EPR.trajectories-206"><span class="linenos">206</span></a>    <span class="nd">@property</span>
</span><span id="EPR.trajectories-207"><a href="#EPR.trajectories-207"><span class="linenos">207</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="EPR.trajectories-208"><a href="#EPR.trajectories-208"><span class="linenos">208</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.trajectories-209"><a href="#EPR.trajectories-209"><span class="linenos">209</span></a><span class="sd">        The raw trajectory list. Each entry is a list of: [iter, agent_id, timestamp, location].</span>
</span><span id="EPR.trajectories-210"><a href="#EPR.trajectories-210"><span class="linenos">210</span></a>
</span><span id="EPR.trajectories-211"><a href="#EPR.trajectories-211"><span class="linenos">211</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.trajectories-212"><a href="#EPR.trajectories-212"><span class="linenos">212</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.trajectories-213"><a href="#EPR.trajectories-213"><span class="linenos">213</span></a><span class="sd">                list[list]: The raw trajectory data.</span>
</span><span id="EPR.trajectories-214"><a href="#EPR.trajectories-214"><span class="linenos">214</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.trajectories-215"><a href="#EPR.trajectories-215"><span class="linenos">215</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span>
</span></pre></div>


            <div class="docstring"><p>The raw trajectory list. Each entry is a list of: [iter, agent_id, timestamp, location].</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      list[list]: The raw trajectory data.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.trajectories_df" class="classattr">
                                        <input id="EPR.trajectories_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">trajectories_df</span><span class="annotation">: pandas.core.frame.DataFrame | None</span>

                <label class="view-source-button" for="EPR.trajectories_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.trajectories_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.trajectories_df-217"><a href="#EPR.trajectories_df-217"><span class="linenos">217</span></a>    <span class="nd">@property</span>
</span><span id="EPR.trajectories_df-218"><a href="#EPR.trajectories_df-218"><span class="linenos">218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trajectories_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.trajectories_df-219"><a href="#EPR.trajectories_df-219"><span class="linenos">219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.trajectories_df-220"><a href="#EPR.trajectories_df-220"><span class="linenos">220</span></a><span class="sd">        The trajectory data as a pandas DataFrame with columns: iter, agent_id, timestamp, location.</span>
</span><span id="EPR.trajectories_df-221"><a href="#EPR.trajectories_df-221"><span class="linenos">221</span></a>
</span><span id="EPR.trajectories_df-222"><a href="#EPR.trajectories_df-222"><span class="linenos">222</span></a><span class="sd">        Getter:</span>
</span><span id="EPR.trajectories_df-223"><a href="#EPR.trajectories_df-223"><span class="linenos">223</span></a><span class="sd">            **Returns:**</span>
</span><span id="EPR.trajectories_df-224"><a href="#EPR.trajectories_df-224"><span class="linenos">224</span></a><span class="sd">                pd.DataFrame | None: The trajectory DataFrame, or None if not yet converted.</span>
</span><span id="EPR.trajectories_df-225"><a href="#EPR.trajectories_df-225"><span class="linenos">225</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.trajectories_df-226"><a href="#EPR.trajectories_df-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span>
</span></pre></div>


            <div class="docstring"><p>The trajectory data as a pandas DataFrame with columns: iter, agent_id, timestamp, location.</p>

<h6 id="getter">Getter:</h6>

<blockquote>
  <p><strong>Returns:</strong>
      pd.DataFrame | None: The trajectory DataFrame, or None if not yet converted.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.convert_trajectories_to_dataframe" class="classattr">
                                        <input id="EPR.convert_trajectories_to_dataframe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_trajectories_to_dataframe</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EPR.convert_trajectories_to_dataframe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.convert_trajectories_to_dataframe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.convert_trajectories_to_dataframe-228"><a href="#EPR.convert_trajectories_to_dataframe-228"><span class="linenos">228</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trajectories_to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.convert_trajectories_to_dataframe-229"><a href="#EPR.convert_trajectories_to_dataframe-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.convert_trajectories_to_dataframe-230"><a href="#EPR.convert_trajectories_to_dataframe-230"><span class="linenos">230</span></a><span class="sd">        Convert the trajectory list to a pandas DataFrame. Stores the result in `self._trajectories_df`.</span>
</span><span id="EPR.convert_trajectories_to_dataframe-231"><a href="#EPR.convert_trajectories_to_dataframe-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.convert_trajectories_to_dataframe-232"><a href="#EPR.convert_trajectories_to_dataframe-232"><span class="linenos">232</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="EPR.convert_trajectories_to_dataframe-233"><a href="#EPR.convert_trajectories_to_dataframe-233"><span class="linenos">233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">,</span>
</span><span id="EPR.convert_trajectories_to_dataframe-234"><a href="#EPR.convert_trajectories_to_dataframe-234"><span class="linenos">234</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">]</span>
</span><span id="EPR.convert_trajectories_to_dataframe-235"><a href="#EPR.convert_trajectories_to_dataframe-235"><span class="linenos">235</span></a>        <span class="p">)</span>
</span><span id="EPR.convert_trajectories_to_dataframe-236"><a href="#EPR.convert_trajectories_to_dataframe-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="o">=</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Convert the trajectory list to a pandas DataFrame. Stores the result in <code>self._trajectories_df</code>.</p>
</div>


                            </div>
                            <div id="EPR.convert_trajectories_to_geodataframe" class="classattr">
                                        <input id="EPR.convert_trajectories_to_geodataframe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_trajectories_to_geodataframe</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">geopandas</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span>:</span></span>

                <label class="view-source-button" for="EPR.convert_trajectories_to_geodataframe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.convert_trajectories_to_geodataframe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.convert_trajectories_to_geodataframe-238"><a href="#EPR.convert_trajectories_to_geodataframe-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_trajectories_to_geodataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-239"><a href="#EPR.convert_trajectories_to_geodataframe-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-240"><a href="#EPR.convert_trajectories_to_geodataframe-240"><span class="linenos">240</span></a><span class="sd">        Convert the trajectory DataFrame to a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-241"><a href="#EPR.convert_trajectories_to_geodataframe-241"><span class="linenos">241</span></a><span class="sd">        Requires that the tessellation is set and that the trajectories DataFrame is available.</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-242"><a href="#EPR.convert_trajectories_to_geodataframe-242"><span class="linenos">242</span></a>
</span><span id="EPR.convert_trajectories_to_geodataframe-243"><a href="#EPR.convert_trajectories_to_geodataframe-243"><span class="linenos">243</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-244"><a href="#EPR.convert_trajectories_to_geodataframe-244"><span class="linenos">244</span></a><span class="sd">            gpd.GeoDataFrame: The trajectory data as a GeoDataFrame with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-245"><a href="#EPR.convert_trajectories_to_geodataframe-245"><span class="linenos">245</span></a><span class="sd">        Raises:</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-246"><a href="#EPR.convert_trajectories_to_geodataframe-246"><span class="linenos">246</span></a><span class="sd">            ValueError: If the tessellation is not set or if the trajectories DataFrame is not available.</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-247"><a href="#EPR.convert_trajectories_to_geodataframe-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-248"><a href="#EPR.convert_trajectories_to_geodataframe-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-249"><a href="#EPR.convert_trajectories_to_geodataframe-249"><span class="linenos">249</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tessellation is not set. Cannot convert trajectories to GeoDataFrame.&quot;</span><span class="p">)</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-250"><a href="#EPR.convert_trajectories_to_geodataframe-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-251"><a href="#EPR.convert_trajectories_to_geodataframe-251"><span class="linenos">251</span></a>            <span class="n">projected_tessellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-252"><a href="#EPR.convert_trajectories_to_geodataframe-252"><span class="linenos">252</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-253"><a href="#EPR.convert_trajectories_to_geodataframe-253"><span class="linenos">253</span></a>            <span class="n">projected_tessellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-254"><a href="#EPR.convert_trajectories_to_geodataframe-254"><span class="linenos">254</span></a>        <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">projected_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-255"><a href="#EPR.convert_trajectories_to_geodataframe-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-256"><a href="#EPR.convert_trajectories_to_geodataframe-256"><span class="linenos">256</span></a>        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-257"><a href="#EPR.convert_trajectories_to_geodataframe-257"><span class="linenos">257</span></a>        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-258"><a href="#EPR.convert_trajectories_to_geodataframe-258"><span class="linenos">258</span></a>        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span>
</span><span id="EPR.convert_trajectories_to_geodataframe-259"><a href="#EPR.convert_trajectories_to_geodataframe-259"><span class="linenos">259</span></a>
</span><span id="EPR.convert_trajectories_to_geodataframe-260"><a href="#EPR.convert_trajectories_to_geodataframe-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="n">gdf</span><span class="p">[[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span>
</span></pre></div>


            <div class="docstring"><p>Convert the trajectory DataFrame to a GeoDataFrame with point geometries at cell centroids.
Requires that the tessellation is set and that the trajectories DataFrame is available.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>gpd.GeoDataFrame: The trajectory data as a GeoDataFrame with columns: agent_id, timestamp, lat, lon, geometry.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If the tessellation is not set or if the trajectories DataFrame is not available.</li>
</ul>
</div>


                            </div>
                            <div id="EPR.expand_trajectory_to_hourly_steps" class="classattr">
                                        <input id="EPR.expand_trajectory_to_hourly_steps-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">expand_trajectory_to_hourly_steps</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>, </span><span class="param"><span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EPR.expand_trajectory_to_hourly_steps-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.expand_trajectory_to_hourly_steps"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.expand_trajectory_to_hourly_steps-262"><a href="#EPR.expand_trajectory_to_hourly_steps-262"><span class="linenos">262</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-263"><a href="#EPR.expand_trajectory_to_hourly_steps-263"><span class="linenos">263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-264"><a href="#EPR.expand_trajectory_to_hourly_steps-264"><span class="linenos">264</span></a><span class="sd">        Expand the trajectory to hourly steps between start_date and end_date.</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-265"><a href="#EPR.expand_trajectory_to_hourly_steps-265"><span class="linenos">265</span></a><span class="sd">        Fills in missing hours by forward-filling the last known location.</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-266"><a href="#EPR.expand_trajectory_to_hourly_steps-266"><span class="linenos">266</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-267"><a href="#EPR.expand_trajectory_to_hourly_steps-267"><span class="linenos">267</span></a><span class="sd">        Args:</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-268"><a href="#EPR.expand_trajectory_to_hourly_steps-268"><span class="linenos">268</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-269"><a href="#EPR.expand_trajectory_to_hourly_steps-269"><span class="linenos">269</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-270"><a href="#EPR.expand_trajectory_to_hourly_steps-270"><span class="linenos">270</span></a><span class="sd">        Raises:</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-271"><a href="#EPR.expand_trajectory_to_hourly_steps-271"><span class="linenos">271</span></a><span class="sd">            ValueError: If the trajectories DataFrame is not available.</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-272"><a href="#EPR.expand_trajectory_to_hourly_steps-272"><span class="linenos">272</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-273"><a href="#EPR.expand_trajectory_to_hourly_steps-273"><span class="linenos">273</span></a><span class="sd">            None: The method updates `self._trajectories_df` in place.</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-274"><a href="#EPR.expand_trajectory_to_hourly_steps-274"><span class="linenos">274</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-275"><a href="#EPR.expand_trajectory_to_hourly_steps-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-276"><a href="#EPR.expand_trajectory_to_hourly_steps-276"><span class="linenos">276</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trajectories DataFrame is not available. Cannot expand to hourly steps.&quot;</span><span class="p">)</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-277"><a href="#EPR.expand_trajectory_to_hourly_steps-277"><span class="linenos">277</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-278"><a href="#EPR.expand_trajectory_to_hourly_steps-278"><span class="linenos">278</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-279"><a href="#EPR.expand_trajectory_to_hourly_steps-279"><span class="linenos">279</span></a>        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-280"><a href="#EPR.expand_trajectory_to_hourly_steps-280"><span class="linenos">280</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-281"><a href="#EPR.expand_trajectory_to_hourly_steps-281"><span class="linenos">281</span></a>        <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;agent_id&quot;</span><span class="p">):</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-282"><a href="#EPR.expand_trajectory_to_hourly_steps-282"><span class="linenos">282</span></a>            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)[[</span><span class="s2">&quot;location&quot;</span><span class="p">]]</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-283"><a href="#EPR.expand_trajectory_to_hourly_steps-283"><span class="linenos">283</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-284"><a href="#EPR.expand_trajectory_to_hourly_steps-284"><span class="linenos">284</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-285"><a href="#EPR.expand_trajectory_to_hourly_steps-285"><span class="linenos">285</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-286"><a href="#EPR.expand_trajectory_to_hourly_steps-286"><span class="linenos">286</span></a>            <span class="n">all_hours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-287"><a href="#EPR.expand_trajectory_to_hourly_steps-287"><span class="linenos">287</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">all_hours</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-288"><a href="#EPR.expand_trajectory_to_hourly_steps-288"><span class="linenos">288</span></a>            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">})</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-289"><a href="#EPR.expand_trajectory_to_hourly_steps-289"><span class="linenos">289</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-290"><a href="#EPR.expand_trajectory_to_hourly_steps-290"><span class="linenos">290</span></a>            <span class="n">resampled</span><span class="p">[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-291"><a href="#EPR.expand_trajectory_to_hourly_steps-291"><span class="linenos">291</span></a>            <span class="n">resampled</span><span class="p">[</span><span class="s2">&quot;iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resampled</span><span class="p">))</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-292"><a href="#EPR.expand_trajectory_to_hourly_steps-292"><span class="linenos">292</span></a>            <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resampled</span><span class="p">)</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-293"><a href="#EPR.expand_trajectory_to_hourly_steps-293"><span class="linenos">293</span></a>
</span><span id="EPR.expand_trajectory_to_hourly_steps-294"><a href="#EPR.expand_trajectory_to_hourly_steps-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-295"><a href="#EPR.expand_trajectory_to_hourly_steps-295"><span class="linenos">295</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-296"><a href="#EPR.expand_trajectory_to_hourly_steps-296"><span class="linenos">296</span></a>            <span class="k">if</span> <span class="n">expanded</span> <span class="k">else</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-297"><a href="#EPR.expand_trajectory_to_hourly_steps-297"><span class="linenos">297</span></a>            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;iter&quot;</span><span class="p">])</span>
</span><span id="EPR.expand_trajectory_to_hourly_steps-298"><a href="#EPR.expand_trajectory_to_hourly_steps-298"><span class="linenos">298</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Expand the trajectory to hourly steps between start_date and end_date.
Fills in missing hours by forward-filling the last known location.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>start_date (datetime):</strong>  The start date of the simulation period.</li>
<li><strong>end_date (datetime):</strong>  The end date of the simulation period.</li>
</ul>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If the trajectories DataFrame is not available.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: The method updates <code>self._trajectories_df</code> in place.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.generate_synthetic_trajectory" class="classattr">
                                        <input id="EPR.generate_synthetic_trajectory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_synthetic_trajectory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">tessellation</span><span class="p">:</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span>,</span><span class="param">	<span class="n">gravity_model</span><span class="p">:</span> <span class="n"><a href="gravity.html#Gravity">src.gravity.Gravity</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">od_matrix</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">_lil</span><span class="o">.</span><span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">geopandas</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span>:</span></span>

                <label class="view-source-button" for="EPR.generate_synthetic_trajectory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.generate_synthetic_trajectory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.generate_synthetic_trajectory-386"><a href="#EPR.generate_synthetic_trajectory-386"><span class="linenos">386</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="EPR.generate_synthetic_trajectory-387"><a href="#EPR.generate_synthetic_trajectory-387"><span class="linenos">387</span></a>                                      <span class="n">tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EPR.generate_synthetic_trajectory-388"><a href="#EPR.generate_synthetic_trajectory-388"><span class="linenos">388</span></a>                                      <span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">od_matrix</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="EPR.generate_synthetic_trajectory-389"><a href="#EPR.generate_synthetic_trajectory-389"><span class="linenos">389</span></a>                                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="EPR.generate_synthetic_trajectory-390"><a href="#EPR.generate_synthetic_trajectory-390"><span class="linenos">390</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.generate_synthetic_trajectory-391"><a href="#EPR.generate_synthetic_trajectory-391"><span class="linenos">391</span></a><span class="sd">        Simulate trajectories for *n_agents* between *start_date* and *end_date*. Each agent starts from a specified or</span>
</span><span id="EPR.generate_synthetic_trajectory-392"><a href="#EPR.generate_synthetic_trajectory-392"><span class="linenos">392</span></a><span class="sd">        random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity</span>
</span><span id="EPR.generate_synthetic_trajectory-393"><a href="#EPR.generate_synthetic_trajectory-393"><span class="linenos">393</span></a><span class="sd">        model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="EPR.generate_synthetic_trajectory-394"><a href="#EPR.generate_synthetic_trajectory-394"><span class="linenos">394</span></a>
</span><span id="EPR.generate_synthetic_trajectory-395"><a href="#EPR.generate_synthetic_trajectory-395"><span class="linenos">395</span></a><span class="sd">        Args:</span>
</span><span id="EPR.generate_synthetic_trajectory-396"><a href="#EPR.generate_synthetic_trajectory-396"><span class="linenos">396</span></a><span class="sd">            n_agents (int): Number of agents to simulate.</span>
</span><span id="EPR.generate_synthetic_trajectory-397"><a href="#EPR.generate_synthetic_trajectory-397"><span class="linenos">397</span></a><span class="sd">            start_date (datetime): Start date of the simulation period.</span>
</span><span id="EPR.generate_synthetic_trajectory-398"><a href="#EPR.generate_synthetic_trajectory-398"><span class="linenos">398</span></a><span class="sd">            end_date (datetime): End date of the simulation period.</span>
</span><span id="EPR.generate_synthetic_trajectory-399"><a href="#EPR.generate_synthetic_trajectory-399"><span class="linenos">399</span></a><span class="sd">            tessellation (gpd.GeoDataFrame): Spatial tessellation with a geometry column and an attractiveness column.</span>
</span><span id="EPR.generate_synthetic_trajectory-400"><a href="#EPR.generate_synthetic_trajectory-400"><span class="linenos">400</span></a><span class="sd">            gravity_model (Gravity | None): An optional Gravity model instance. If None, a default singly-constrained model is used.</span>
</span><span id="EPR.generate_synthetic_trajectory-401"><a href="#EPR.generate_synthetic_trajectory-401"><span class="linenos">401</span></a><span class="sd">            starting_cells (list[int] | None): Optional list of starting cell indices for agents. If provided, must have at least `n_agents` elements. If None, starting cells are chosen randomly.</span>
</span><span id="EPR.generate_synthetic_trajectory-402"><a href="#EPR.generate_synthetic_trajectory-402"><span class="linenos">402</span></a><span class="sd">            od_matrix (lil_matrix | None): Optional precomputed OD matrix. If None, it will be computed on‑demand.</span>
</span><span id="EPR.generate_synthetic_trajectory-403"><a href="#EPR.generate_synthetic_trajectory-403"><span class="linenos">403</span></a><span class="sd">            random_state (int | None): Optional random seed for reproducibility.</span>
</span><span id="EPR.generate_synthetic_trajectory-404"><a href="#EPR.generate_synthetic_trajectory-404"><span class="linenos">404</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.generate_synthetic_trajectory-405"><a href="#EPR.generate_synthetic_trajectory-405"><span class="linenos">405</span></a><span class="sd">            gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="EPR.generate_synthetic_trajectory-406"><a href="#EPR.generate_synthetic_trajectory-406"><span class="linenos">406</span></a><span class="sd">        Raises:</span>
</span><span id="EPR.generate_synthetic_trajectory-407"><a href="#EPR.generate_synthetic_trajectory-407"><span class="linenos">407</span></a><span class="sd">            ValueError: If `starting_cells` is provided but has fewer than `n_agents` elements.</span>
</span><span id="EPR.generate_synthetic_trajectory-408"><a href="#EPR.generate_synthetic_trajectory-408"><span class="linenos">408</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.generate_synthetic_trajectory-409"><a href="#EPR.generate_synthetic_trajectory-409"><span class="linenos">409</span></a>        <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_agents</span><span class="p">:</span>
</span><span id="EPR.generate_synthetic_trajectory-410"><a href="#EPR.generate_synthetic_trajectory-410"><span class="linenos">410</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;starting_cells&#39; must contain at least &#39;n_agents&#39; elements.&quot;</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-411"><a href="#EPR.generate_synthetic_trajectory-411"><span class="linenos">411</span></a>
</span><span id="EPR.generate_synthetic_trajectory-412"><a href="#EPR.generate_synthetic_trajectory-412"><span class="linenos">412</span></a>        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.generate_synthetic_trajectory-413"><a href="#EPR.generate_synthetic_trajectory-413"><span class="linenos">413</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-414"><a href="#EPR.generate_synthetic_trajectory-414"><span class="linenos">414</span></a>
</span><span id="EPR.generate_synthetic_trajectory-415"><a href="#EPR.generate_synthetic_trajectory-415"><span class="linenos">415</span></a>        <span class="c1"># Spatial context</span>
</span><span id="EPR.generate_synthetic_trajectory-416"><a href="#EPR.generate_synthetic_trajectory-416"><span class="linenos">416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="o">=</span> <span class="n">tessellation</span>
</span><span id="EPR.generate_synthetic_trajectory-417"><a href="#EPR.generate_synthetic_trajectory-417"><span class="linenos">417</span></a>        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-418"><a href="#EPR.generate_synthetic_trajectory-418"><span class="linenos">418</span></a>
</span><span id="EPR.generate_synthetic_trajectory-419"><a href="#EPR.generate_synthetic_trajectory-419"><span class="linenos">419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</span><span id="EPR.generate_synthetic_trajectory-420"><a href="#EPR.generate_synthetic_trajectory-420"><span class="linenos">420</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_geom_centroid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</span><span id="EPR.generate_synthetic_trajectory-421"><a href="#EPR.generate_synthetic_trajectory-421"><span class="linenos">421</span></a>
</span><span id="EPR.generate_synthetic_trajectory-422"><a href="#EPR.generate_synthetic_trajectory-422"><span class="linenos">422</span></a>        <span class="c1"># Gravity model (lazily created)</span>
</span><span id="EPR.generate_synthetic_trajectory-423"><a href="#EPR.generate_synthetic_trajectory-423"><span class="linenos">423</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="n">gravity_model</span> <span class="ow">or</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;singly constrained&quot;</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-424"><a href="#EPR.generate_synthetic_trajectory-424"><span class="linenos">424</span></a>
</span><span id="EPR.generate_synthetic_trajectory-425"><a href="#EPR.generate_synthetic_trajectory-425"><span class="linenos">425</span></a>        <span class="c1"># OD matrix initialisation</span>
</span><span id="EPR.generate_synthetic_trajectory-426"><a href="#EPR.generate_synthetic_trajectory-426"><span class="linenos">426</span></a>        <span class="k">if</span> <span class="n">od_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.generate_synthetic_trajectory-427"><a href="#EPR.generate_synthetic_trajectory-427"><span class="linenos">427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">))</span>
</span><span id="EPR.generate_synthetic_trajectory-428"><a href="#EPR.generate_synthetic_trajectory-428"><span class="linenos">428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EPR.generate_synthetic_trajectory-429"><a href="#EPR.generate_synthetic_trajectory-429"><span class="linenos">429</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EPR.generate_synthetic_trajectory-430"><a href="#EPR.generate_synthetic_trajectory-430"><span class="linenos">430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">od_matrix</span>
</span><span id="EPR.generate_synthetic_trajectory-431"><a href="#EPR.generate_synthetic_trajectory-431"><span class="linenos">431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="EPR.generate_synthetic_trajectory-432"><a href="#EPR.generate_synthetic_trajectory-432"><span class="linenos">432</span></a>
</span><span id="EPR.generate_synthetic_trajectory-433"><a href="#EPR.generate_synthetic_trajectory-433"><span class="linenos">433</span></a>        <span class="c1"># Simulate each agent separately</span>
</span><span id="EPR.generate_synthetic_trajectory-434"><a href="#EPR.generate_synthetic_trajectory-434"><span class="linenos">434</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trajectory generation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="EPR.generate_synthetic_trajectory-435"><a href="#EPR.generate_synthetic_trajectory-435"><span class="linenos">435</span></a>            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="EPR.generate_synthetic_trajectory-436"><a href="#EPR.generate_synthetic_trajectory-436"><span class="linenos">436</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EPR.generate_synthetic_trajectory-437"><a href="#EPR.generate_synthetic_trajectory-437"><span class="linenos">437</span></a>                    <span class="n">starting_cells</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-438"><a href="#EPR.generate_synthetic_trajectory-438"><span class="linenos">438</span></a>                <span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-439"><a href="#EPR.generate_synthetic_trajectory-439"><span class="linenos">439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-440"><a href="#EPR.generate_synthetic_trajectory-440"><span class="linenos">440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-441"><a href="#EPR.generate_synthetic_trajectory-441"><span class="linenos">441</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-442"><a href="#EPR.generate_synthetic_trajectory-442"><span class="linenos">442</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_dataframe</span><span class="p">()</span>
</span><span id="EPR.generate_synthetic_trajectory-443"><a href="#EPR.generate_synthetic_trajectory-443"><span class="linenos">443</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="EPR.generate_synthetic_trajectory-444"><a href="#EPR.generate_synthetic_trajectory-444"><span class="linenos">444</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_geodataframe</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Simulate trajectories for <em>n_agents</em> between <em>start_date</em> and <em>end_date</em>. Each agent starts from a specified or
random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity
model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>n_agents (int):</strong>  Number of agents to simulate.</li>
<li><strong>start_date (datetime):</strong>  Start date of the simulation period.</li>
<li><strong>end_date (datetime):</strong>  End date of the simulation period.</li>
<li><strong>tessellation (gpd.GeoDataFrame):</strong>  Spatial tessellation with a geometry column and an attractiveness column.</li>
<li><strong>gravity_model (Gravity | None):</strong>  An optional Gravity model instance. If None, a default singly-constrained model is used.</li>
<li><strong>starting_cells (list[int] | None):</strong>  Optional list of starting cell indices for agents. If provided, must have at least <code>n_agents</code> elements. If None, starting cells are chosen randomly.</li>
<li><strong>od_matrix (lil_matrix | None):</strong>  Optional precomputed OD matrix. If None, it will be computed on‑demand.</li>
<li><strong>random_state (int | None):</strong>  Optional random seed for reproducibility.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If <code>starting_cells</code> is provided but has fewer than <code>n_agents</code> elements.</li>
</ul>
</div>


                            </div>
                            <div id="EPR.pick_preferential_location" class="classattr">
                                        <input id="EPR.pick_preferential_location-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pick_preferential_location</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="EPR.pick_preferential_location-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.pick_preferential_location"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.pick_preferential_location-321"><a href="#EPR.pick_preferential_location-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_preferential_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR.pick_preferential_location-322"><a href="#EPR.pick_preferential_location-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.pick_preferential_location-323"><a href="#EPR.pick_preferential_location-323"><span class="linenos">323</span></a><span class="sd">        Select a *visited* cell according to visitation frequencies. Excludes the current location.</span>
</span><span id="EPR.pick_preferential_location-324"><a href="#EPR.pick_preferential_location-324"><span class="linenos">324</span></a>
</span><span id="EPR.pick_preferential_location-325"><a href="#EPR.pick_preferential_location-325"><span class="linenos">325</span></a><span class="sd">        Args:</span>
</span><span id="EPR.pick_preferential_location-326"><a href="#EPR.pick_preferential_location-326"><span class="linenos">326</span></a><span class="sd">            current_loc (int): The agent&#39;s current location index.</span>
</span><span id="EPR.pick_preferential_location-327"><a href="#EPR.pick_preferential_location-327"><span class="linenos">327</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.pick_preferential_location-328"><a href="#EPR.pick_preferential_location-328"><span class="linenos">328</span></a><span class="sd">            int: The selected location index.</span>
</span><span id="EPR.pick_preferential_location-329"><a href="#EPR.pick_preferential_location-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.pick_preferential_location-330"><a href="#EPR.pick_preferential_location-330"><span class="linenos">330</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="o">.</span><span class="n">visited_locations</span>
</span><span id="EPR.pick_preferential_location-331"><a href="#EPR.pick_preferential_location-331"><span class="linenos">331</span></a>        <span class="n">locs</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">cnt</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">visited</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">current_loc</span><span class="p">))</span>
</span><span id="EPR.pick_preferential_location-332"><a href="#EPR.pick_preferential_location-332"><span class="linenos">332</span></a>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="EPR.pick_preferential_location-333"><a href="#EPR.pick_preferential_location-333"><span class="linenos">333</span></a>        <span class="n">probs</span> <span class="o">/=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="EPR.pick_preferential_location-334"><a href="#EPR.pick_preferential_location-334"><span class="linenos">334</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Select a <em>visited</em> cell according to visitation frequencies. Excludes the current location.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>current_loc (int):</strong>  The agent's current location index.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The selected location index.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.explore_new_location" class="classattr">
                                        <input id="EPR.explore_new_location-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">explore_new_location</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="EPR.explore_new_location-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.explore_new_location"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.explore_new_location-336"><a href="#EPR.explore_new_location-336"><span class="linenos">336</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_explore_new_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR.explore_new_location-337"><a href="#EPR.explore_new_location-337"><span class="linenos">337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.explore_new_location-338"><a href="#EPR.explore_new_location-338"><span class="linenos">338</span></a><span class="sd">        Pick a *new* location using (cached) OD probabilities. If the OD row for the current location is not yet</span>
</span><span id="EPR.explore_new_location-339"><a href="#EPR.explore_new_location-339"><span class="linenos">339</span></a><span class="sd">        computed, it will be calculated on‑demand. Excludes the current location from possible destinations. If no other</span>
</span><span id="EPR.explore_new_location-340"><a href="#EPR.explore_new_location-340"><span class="linenos">340</span></a><span class="sd">        locations are available (e.g., only one cell in tessellation), returns the current location.</span>
</span><span id="EPR.explore_new_location-341"><a href="#EPR.explore_new_location-341"><span class="linenos">341</span></a>
</span><span id="EPR.explore_new_location-342"><a href="#EPR.explore_new_location-342"><span class="linenos">342</span></a><span class="sd">        Args:</span>
</span><span id="EPR.explore_new_location-343"><a href="#EPR.explore_new_location-343"><span class="linenos">343</span></a><span class="sd">            current_loc (int): The agent&#39;s current location index.</span>
</span><span id="EPR.explore_new_location-344"><a href="#EPR.explore_new_location-344"><span class="linenos">344</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.explore_new_location-345"><a href="#EPR.explore_new_location-345"><span class="linenos">345</span></a><span class="sd">            int: The selected new location index. If no new location is available, returns `current_loc`.</span>
</span><span id="EPR.explore_new_location-346"><a href="#EPR.explore_new_location-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.explore_new_location-347"><a href="#EPR.explore_new_location-347"><span class="linenos">347</span></a>        <span class="c1"># Retrieve or lazily compute probability vector for this origin.</span>
</span><span id="EPR.explore_new_location-348"><a href="#EPR.explore_new_location-348"><span class="linenos">348</span></a>        <span class="n">od_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="o">.</span><span class="n">getrowview</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="EPR.explore_new_location-349"><a href="#EPR.explore_new_location-349"><span class="linenos">349</span></a>        <span class="k">if</span> <span class="n">od_row</span><span class="o">.</span><span class="n">nnz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EPR.explore_new_location-350"><a href="#EPR.explore_new_location-350"><span class="linenos">350</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">compute_od_row</span><span class="p">(</span><span class="n">current_loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span><span class="p">,</span>
</span><span id="EPR.explore_new_location-351"><a href="#EPR.explore_new_location-351"><span class="linenos">351</span></a>                                   <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
</span><span id="EPR.explore_new_location-352"><a href="#EPR.explore_new_location-352"><span class="linenos">352</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="p">[</span><span class="n">current_loc</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">probs</span>
</span><span id="EPR.explore_new_location-353"><a href="#EPR.explore_new_location-353"><span class="linenos">353</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EPR.explore_new_location-354"><a href="#EPR.explore_new_location-354"><span class="linenos">354</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">od_row</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="EPR.explore_new_location-355"><a href="#EPR.explore_new_location-355"><span class="linenos">355</span></a>
</span><span id="EPR.explore_new_location-356"><a href="#EPR.explore_new_location-356"><span class="linenos">356</span></a>        <span class="n">destinations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span><span class="p">))</span>
</span><span id="EPR.explore_new_location-357"><a href="#EPR.explore_new_location-357"><span class="linenos">357</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Pick a <em>new</em> location using (cached) OD probabilities. If the OD row for the current location is not yet
computed, it will be calculated on‑demand. Excludes the current location from possible destinations. If no other
locations are available (e.g., only one cell in tessellation), returns the current location.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>current_loc (int):</strong>  The agent's current location index.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The selected new location index. If no new location is available, returns <code>current_loc</code>.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.choose_next_location" class="classattr">
                                        <input id="EPR.choose_next_location-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">choose_next_location</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="EPR.choose_next_location-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.choose_next_location"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.choose_next_location-359"><a href="#EPR.choose_next_location-359"><span class="linenos">359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_choose_next_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="EPR.choose_next_location-360"><a href="#EPR.choose_next_location-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.choose_next_location-361"><a href="#EPR.choose_next_location-361"><span class="linenos">361</span></a><span class="sd">        Decide whether to *explore* or *return*, then pick the destination. The exploration probability decays with</span>
</span><span id="EPR.choose_next_location-362"><a href="#EPR.choose_next_location-362"><span class="linenos">362</span></a><span class="sd">        the number of unique visited locations. If exploring, a new location is chosen using the OD matrix;</span>
</span><span id="EPR.choose_next_location-363"><a href="#EPR.choose_next_location-363"><span class="linenos">363</span></a><span class="sd">        if returning, a previously visited location is selected based on visitation frequency. If no new locations</span>
</span><span id="EPR.choose_next_location-364"><a href="#EPR.choose_next_location-364"><span class="linenos">364</span></a><span class="sd">        are available, the agent will return to a visited location.</span>
</span><span id="EPR.choose_next_location-365"><a href="#EPR.choose_next_location-365"><span class="linenos">365</span></a>
</span><span id="EPR.choose_next_location-366"><a href="#EPR.choose_next_location-366"><span class="linenos">366</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.choose_next_location-367"><a href="#EPR.choose_next_location-367"><span class="linenos">367</span></a><span class="sd">            int: The selected next location index.</span>
</span><span id="EPR.choose_next_location-368"><a href="#EPR.choose_next_location-368"><span class="linenos">368</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.choose_next_location-369"><a href="#EPR.choose_next_location-369"><span class="linenos">369</span></a>        <span class="n">num_visited</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">)</span>
</span><span id="EPR.choose_next_location-370"><a href="#EPR.choose_next_location-370"><span class="linenos">370</span></a>        <span class="c1"># First step: explore from the starting cell</span>
</span><span id="EPR.choose_next_location-371"><a href="#EPR.choose_next_location-371"><span class="linenos">371</span></a>        <span class="k">if</span> <span class="n">num_visited</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="EPR.choose_next_location-372"><a href="#EPR.choose_next_location-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explore_new_location</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">)</span>
</span><span id="EPR.choose_next_location-373"><a href="#EPR.choose_next_location-373"><span class="linenos">373</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span>
</span><span id="EPR.choose_next_location-374"><a href="#EPR.choose_next_location-374"><span class="linenos">374</span></a>
</span><span id="EPR.choose_next_location-375"><a href="#EPR.choose_next_location-375"><span class="linenos">375</span></a>        <span class="o">*</span><span class="n">_prev</span><span class="p">,</span> <span class="n">current_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="EPR.choose_next_location-376"><a href="#EPR.choose_next_location-376"><span class="linenos">376</span></a>
</span><span id="EPR.choose_next_location-377"><a href="#EPR.choose_next_location-377"><span class="linenos">377</span></a>        <span class="c1"># Exploration probability decays with #visited locations (Song et al.)</span>
</span><span id="EPR.choose_next_location-378"><a href="#EPR.choose_next_location-378"><span class="linenos">378</span></a>        <span class="n">p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
</span><span id="EPR.choose_next_location-379"><a href="#EPR.choose_next_location-379"><span class="linenos">379</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">num_visited</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">)</span>
</span><span id="EPR.choose_next_location-380"><a href="#EPR.choose_next_location-380"><span class="linenos">380</span></a>        <span class="n">explore_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_new</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">num_visited</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_od</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">num_visited</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="EPR.choose_next_location-381"><a href="#EPR.choose_next_location-381"><span class="linenos">381</span></a>
</span><span id="EPR.choose_next_location-382"><a href="#EPR.choose_next_location-382"><span class="linenos">382</span></a>        <span class="k">if</span> <span class="n">explore_flag</span><span class="p">:</span>
</span><span id="EPR.choose_next_location-383"><a href="#EPR.choose_next_location-383"><span class="linenos">383</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_explore_new_location</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span><span id="EPR.choose_next_location-384"><a href="#EPR.choose_next_location-384"><span class="linenos">384</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_preferential_location</span><span class="p">(</span><span class="n">current_loc</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Decide whether to <em>explore</em> or <em>return</em>, then pick the destination. The exploration probability decays with
the number of unique visited locations. If exploring, a new location is chosen using the OD matrix;
if returning, a previously visited location is selected based on visitation frequency. If no new locations
are available, the agent will return to a visited location.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The selected next location index.</p>
</blockquote>
</div>


                            </div>
                            <div id="EPR.simulate_agent_trajectory" class="classattr">
                                        <input id="EPR.simulate_agent_trajectory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">simulate_agent_trajectory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">agent</span><span class="p">:</span> <span class="n"><a href="agent.html#Agent">src.agent.Agent</a></span>,</span><span class="param">	<span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="EPR.simulate_agent_trajectory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EPR.simulate_agent_trajectory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EPR.simulate_agent_trajectory-446"><a href="#EPR.simulate_agent_trajectory-446"><span class="linenos">446</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EPR.simulate_agent_trajectory-447"><a href="#EPR.simulate_agent_trajectory-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EPR.simulate_agent_trajectory-448"><a href="#EPR.simulate_agent_trajectory-448"><span class="linenos">448</span></a><span class="sd">        Run the event‑based simulation loop for a single agent. The agent starts at the specified starting cell and</span>
</span><span id="EPR.simulate_agent_trajectory-449"><a href="#EPR.simulate_agent_trajectory-449"><span class="linenos">449</span></a><span class="sd">        iteratively decides to explore new locations or return to previously visited ones, based on the EPR model&#39;s</span>
</span><span id="EPR.simulate_agent_trajectory-450"><a href="#EPR.simulate_agent_trajectory-450"><span class="linenos">450</span></a><span class="sd">        probabilities. The agent waits at each location for a time drawn from a truncated power law distribution before</span>
</span><span id="EPR.simulate_agent_trajectory-451"><a href="#EPR.simulate_agent_trajectory-451"><span class="linenos">451</span></a><span class="sd">        moving again. The trajectory is recorded in `self._trajectories`.</span>
</span><span id="EPR.simulate_agent_trajectory-452"><a href="#EPR.simulate_agent_trajectory-452"><span class="linenos">452</span></a>
</span><span id="EPR.simulate_agent_trajectory-453"><a href="#EPR.simulate_agent_trajectory-453"><span class="linenos">453</span></a><span class="sd">        Args:</span>
</span><span id="EPR.simulate_agent_trajectory-454"><a href="#EPR.simulate_agent_trajectory-454"><span class="linenos">454</span></a><span class="sd">            agent (Agent): The agent to simulate.</span>
</span><span id="EPR.simulate_agent_trajectory-455"><a href="#EPR.simulate_agent_trajectory-455"><span class="linenos">455</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="EPR.simulate_agent_trajectory-456"><a href="#EPR.simulate_agent_trajectory-456"><span class="linenos">456</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="EPR.simulate_agent_trajectory-457"><a href="#EPR.simulate_agent_trajectory-457"><span class="linenos">457</span></a><span class="sd">        Returns:</span>
</span><span id="EPR.simulate_agent_trajectory-458"><a href="#EPR.simulate_agent_trajectory-458"><span class="linenos">458</span></a><span class="sd">            None: The method updates `self._trajectories` in place.</span>
</span><span id="EPR.simulate_agent_trajectory-459"><a href="#EPR.simulate_agent_trajectory-459"><span class="linenos">459</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EPR.simulate_agent_trajectory-460"><a href="#EPR.simulate_agent_trajectory-460"><span class="linenos">460</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_date</span>
</span><span id="EPR.simulate_agent_trajectory-461"><a href="#EPR.simulate_agent_trajectory-461"><span class="linenos">461</span></a>        <span class="n">iter_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="EPR.simulate_agent_trajectory-462"><a href="#EPR.simulate_agent_trajectory-462"><span class="linenos">462</span></a>
</span><span id="EPR.simulate_agent_trajectory-463"><a href="#EPR.simulate_agent_trajectory-463"><span class="linenos">463</span></a>        <span class="c1"># First record — agent starts at *start* timestamp</span>
</span><span id="EPR.simulate_agent_trajectory-464"><a href="#EPR.simulate_agent_trajectory-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">])</span>
</span><span id="EPR.simulate_agent_trajectory-465"><a href="#EPR.simulate_agent_trajectory-465"><span class="linenos">465</span></a>        <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="EPR.simulate_agent_trajectory-466"><a href="#EPR.simulate_agent_trajectory-466"><span class="linenos">466</span></a>
</span><span id="EPR.simulate_agent_trajectory-467"><a href="#EPR.simulate_agent_trajectory-467"><span class="linenos">467</span></a>        <span class="c1"># Iterate until *end_date*</span>
</span><span id="EPR.simulate_agent_trajectory-468"><a href="#EPR.simulate_agent_trajectory-468"><span class="linenos">468</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="EPR.simulate_agent_trajectory-469"><a href="#EPR.simulate_agent_trajectory-469"><span class="linenos">469</span></a>            <span class="n">current_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_wait_delta</span><span class="p">()</span>
</span><span id="EPR.simulate_agent_trajectory-470"><a href="#EPR.simulate_agent_trajectory-470"><span class="linenos">470</span></a>            <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="n">end_date</span><span class="p">:</span>
</span><span id="EPR.simulate_agent_trajectory-471"><a href="#EPR.simulate_agent_trajectory-471"><span class="linenos">471</span></a>                <span class="k">break</span>
</span><span id="EPR.simulate_agent_trajectory-472"><a href="#EPR.simulate_agent_trajectory-472"><span class="linenos">472</span></a>
</span><span id="EPR.simulate_agent_trajectory-473"><a href="#EPR.simulate_agent_trajectory-473"><span class="linenos">473</span></a>            <span class="n">iter_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="EPR.simulate_agent_trajectory-474"><a href="#EPR.simulate_agent_trajectory-474"><span class="linenos">474</span></a>            <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_next_location</span><span class="p">()</span>
</span><span id="EPR.simulate_agent_trajectory-475"><a href="#EPR.simulate_agent_trajectory-475"><span class="linenos">475</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="n">next_loc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="EPR.simulate_agent_trajectory-476"><a href="#EPR.simulate_agent_trajectory-476"><span class="linenos">476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Run the event‑based simulation loop for a single agent. The agent starts at the specified starting cell and
iteratively decides to explore new locations or return to previously visited ones, based on the EPR model's
probabilities. The agent waits at each location for a time drawn from a truncated power law distribution before
moving again. The trajectory is recorded in <code>self._trajectories</code>.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>agent (Agent):</strong>  The agent to simulate.</li>
<li><strong>start_date (datetime):</strong>  The start date of the simulation period.</li>
<li><strong>end_date (datetime):</strong>  The end date of the simulation period.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: The method updates <code>self._trajectories</code> in place.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Ditras">
                            <input id="Ditras-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Ditras</span><wbr>(<span class="base"><a href="#EPR">EPR</a></span>):

                <label class="view-source-button" for="Ditras-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Ditras"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Ditras-485"><a href="#Ditras-485"><span class="linenos">485</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Ditras</span><span class="p">(</span><span class="n">EPR</span><span class="p">):</span>
</span><span id="Ditras-486"><a href="#Ditras-486"><span class="linenos">486</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras-487"><a href="#Ditras-487"><span class="linenos">487</span></a><span class="sd">    Ditras model, inheriting from EPR. Uses a Markov chain for diary generation. Overrides the trajectory generation method to</span>
</span><span id="Ditras-488"><a href="#Ditras-488"><span class="linenos">488</span></a><span class="sd">    incorporate diary-based location choices. Requires a MarkovChain instance for diary generation.</span>
</span><span id="Ditras-489"><a href="#Ditras-489"><span class="linenos">489</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Ditras-490"><a href="#Ditras-490"><span class="linenos">490</span></a>
</span><span id="Ditras-491"><a href="#Ditras-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EPRConfig</span><span class="p">,</span> <span class="n">diary_generator</span><span class="p">:</span> <span class="n">MarkovChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras-492"><a href="#Ditras-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras-493"><a href="#Ditras-493"><span class="linenos">493</span></a><span class="sd">        Initialize the Ditras model with the given configuration and diary generator. Inherits from EPR.</span>
</span><span id="Ditras-494"><a href="#Ditras-494"><span class="linenos">494</span></a>
</span><span id="Ditras-495"><a href="#Ditras-495"><span class="linenos">495</span></a><span class="sd">        Args:</span>
</span><span id="Ditras-496"><a href="#Ditras-496"><span class="linenos">496</span></a><span class="sd">            config (EPRConfig): Configuration parameters for the EPR model.</span>
</span><span id="Ditras-497"><a href="#Ditras-497"><span class="linenos">497</span></a><span class="sd">            diary_generator (MarkovChain): An instance of MarkovChain for generating activity diaries.</span>
</span><span id="Ditras-498"><a href="#Ditras-498"><span class="linenos">498</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Ditras-499"><a href="#Ditras-499"><span class="linenos">499</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="Ditras-500"><a href="#Ditras-500"><span class="linenos">500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_diary_generator</span> <span class="o">=</span> <span class="n">diary_generator</span>
</span><span id="Ditras-501"><a href="#Ditras-501"><span class="linenos">501</span></a>
</span><span id="Ditras-502"><a href="#Ditras-502"><span class="linenos">502</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="Ditras-503"><a href="#Ditras-503"><span class="linenos">503</span></a>                                      <span class="n">tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Ditras-504"><a href="#Ditras-504"><span class="linenos">504</span></a>                                      <span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">od_matrix</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Ditras-505"><a href="#Ditras-505"><span class="linenos">505</span></a>                                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="Ditras-506"><a href="#Ditras-506"><span class="linenos">506</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras-507"><a href="#Ditras-507"><span class="linenos">507</span></a><span class="sd">        Simulate trajectories for *n_agents* between *start_date* and *end_date*. Each agent starts from a specified or</span>
</span><span id="Ditras-508"><a href="#Ditras-508"><span class="linenos">508</span></a><span class="sd">        random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity</span>
</span><span id="Ditras-509"><a href="#Ditras-509"><span class="linenos">509</span></a><span class="sd">        model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="Ditras-510"><a href="#Ditras-510"><span class="linenos">510</span></a>
</span><span id="Ditras-511"><a href="#Ditras-511"><span class="linenos">511</span></a><span class="sd">        Args:</span>
</span><span id="Ditras-512"><a href="#Ditras-512"><span class="linenos">512</span></a><span class="sd">            n_agents (int): Number of agents to simulate.</span>
</span><span id="Ditras-513"><a href="#Ditras-513"><span class="linenos">513</span></a><span class="sd">            start_date (datetime): Start date of the simulation period.</span>
</span><span id="Ditras-514"><a href="#Ditras-514"><span class="linenos">514</span></a><span class="sd">            end_date (datetime): End date of the simulation period.</span>
</span><span id="Ditras-515"><a href="#Ditras-515"><span class="linenos">515</span></a><span class="sd">            tessellation (gpd.GeoDataFrame): Spatial tessellation with a geometry column and an attractiveness column.</span>
</span><span id="Ditras-516"><a href="#Ditras-516"><span class="linenos">516</span></a><span class="sd">            gravity_model (Gravity | None): An optional Gravity model instance. If None, a default singly-constrained model is used.</span>
</span><span id="Ditras-517"><a href="#Ditras-517"><span class="linenos">517</span></a><span class="sd">            starting_cells (list[int] | None): Optional list of starting cell indices for agents. If provided, must have at least `n_agents` elements. If None, starting cells are chosen randomly.</span>
</span><span id="Ditras-518"><a href="#Ditras-518"><span class="linenos">518</span></a><span class="sd">            od_matrix (lil_matrix | None): Optional precomputed OD matrix. If None, it will be computed on‑demand.</span>
</span><span id="Ditras-519"><a href="#Ditras-519"><span class="linenos">519</span></a><span class="sd">            random_state (int | None): Optional random seed for reproducibility.</span>
</span><span id="Ditras-520"><a href="#Ditras-520"><span class="linenos">520</span></a><span class="sd">        Returns:</span>
</span><span id="Ditras-521"><a href="#Ditras-521"><span class="linenos">521</span></a><span class="sd">            gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="Ditras-522"><a href="#Ditras-522"><span class="linenos">522</span></a><span class="sd">        Raises:</span>
</span><span id="Ditras-523"><a href="#Ditras-523"><span class="linenos">523</span></a><span class="sd">            ValueError: If `starting_cells` is provided but has fewer than `n_agents` elements.</span>
</span><span id="Ditras-524"><a href="#Ditras-524"><span class="linenos">524</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Ditras-525"><a href="#Ditras-525"><span class="linenos">525</span></a>        <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_agents</span><span class="p">:</span>
</span><span id="Ditras-526"><a href="#Ditras-526"><span class="linenos">526</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;starting_cells&#39; must contain at least &#39;n_agents&#39; elements.&quot;</span><span class="p">)</span>
</span><span id="Ditras-527"><a href="#Ditras-527"><span class="linenos">527</span></a>
</span><span id="Ditras-528"><a href="#Ditras-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras-529"><a href="#Ditras-529"><span class="linenos">529</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
</span><span id="Ditras-530"><a href="#Ditras-530"><span class="linenos">530</span></a>
</span><span id="Ditras-531"><a href="#Ditras-531"><span class="linenos">531</span></a>        <span class="c1"># Spatial context</span>
</span><span id="Ditras-532"><a href="#Ditras-532"><span class="linenos">532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="o">=</span> <span class="n">tessellation</span>
</span><span id="Ditras-533"><a href="#Ditras-533"><span class="linenos">533</span></a>        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">)</span>
</span><span id="Ditras-534"><a href="#Ditras-534"><span class="linenos">534</span></a>
</span><span id="Ditras-535"><a href="#Ditras-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_with_attractiveness_raster</span><span class="p">:</span>
</span><span id="Ditras-536"><a href="#Ditras-536"><span class="linenos">536</span></a>            <span class="n">raster</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">)</span>
</span><span id="Ditras-537"><a href="#Ditras-537"><span class="linenos">537</span></a>            <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">tessellation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">nodata</span><span class="o">=</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
</span><span id="Ditras-538"><a href="#Ditras-538"><span class="linenos">538</span></a>            <span class="n">mean_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
</span><span id="Ditras-539"><a href="#Ditras-539"><span class="linenos">539</span></a>            <span class="n">tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mean_values</span>
</span><span id="Ditras-540"><a href="#Ditras-540"><span class="linenos">540</span></a>
</span><span id="Ditras-541"><a href="#Ditras-541"><span class="linenos">541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</span><span id="Ditras-542"><a href="#Ditras-542"><span class="linenos">542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_geom_centroid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</span><span id="Ditras-543"><a href="#Ditras-543"><span class="linenos">543</span></a>
</span><span id="Ditras-544"><a href="#Ditras-544"><span class="linenos">544</span></a>        <span class="c1"># Gravity model (lazily created)</span>
</span><span id="Ditras-545"><a href="#Ditras-545"><span class="linenos">545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="n">gravity_model</span> <span class="ow">or</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;singly constrained&quot;</span><span class="p">)</span>
</span><span id="Ditras-546"><a href="#Ditras-546"><span class="linenos">546</span></a>
</span><span id="Ditras-547"><a href="#Ditras-547"><span class="linenos">547</span></a>        <span class="c1"># OD matrix initialisation</span>
</span><span id="Ditras-548"><a href="#Ditras-548"><span class="linenos">548</span></a>        <span class="k">if</span> <span class="n">od_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras-549"><a href="#Ditras-549"><span class="linenos">549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">))</span>
</span><span id="Ditras-550"><a href="#Ditras-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Ditras-551"><a href="#Ditras-551"><span class="linenos">551</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Ditras-552"><a href="#Ditras-552"><span class="linenos">552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">od_matrix</span>
</span><span id="Ditras-553"><a href="#Ditras-553"><span class="linenos">553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Ditras-554"><a href="#Ditras-554"><span class="linenos">554</span></a>
</span><span id="Ditras-555"><a href="#Ditras-555"><span class="linenos">555</span></a>        <span class="c1"># Simulate each agent separately</span>
</span><span id="Ditras-556"><a href="#Ditras-556"><span class="linenos">556</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trajectory generation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="Ditras-557"><a href="#Ditras-557"><span class="linenos">557</span></a>            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Ditras-558"><a href="#Ditras-558"><span class="linenos">558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Ditras-559"><a href="#Ditras-559"><span class="linenos">559</span></a>                    <span class="n">starting_cells</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
</span><span id="Ditras-560"><a href="#Ditras-560"><span class="linenos">560</span></a>                <span class="p">)</span>
</span><span id="Ditras-561"><a href="#Ditras-561"><span class="linenos">561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</span><span id="Ditras-562"><a href="#Ditras-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="Ditras-563"><a href="#Ditras-563"><span class="linenos">563</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Ditras-564"><a href="#Ditras-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_dataframe</span><span class="p">()</span>
</span><span id="Ditras-565"><a href="#Ditras-565"><span class="linenos">565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="Ditras-566"><a href="#Ditras-566"><span class="linenos">566</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_geodataframe</span><span class="p">()</span>
</span><span id="Ditras-567"><a href="#Ditras-567"><span class="linenos">567</span></a>
</span><span id="Ditras-568"><a href="#Ditras-568"><span class="linenos">568</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras-569"><a href="#Ditras-569"><span class="linenos">569</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras-570"><a href="#Ditras-570"><span class="linenos">570</span></a><span class="sd">        Run the event‑based simulation loop for a single agent.</span>
</span><span id="Ditras-571"><a href="#Ditras-571"><span class="linenos">571</span></a><span class="sd">        The agent starts at the specified starting cell and follows an activity diary generated by a Markov chain.</span>
</span><span id="Ditras-572"><a href="#Ditras-572"><span class="linenos">572</span></a><span class="sd">        The trajectory is recorded in `self._trajectories`.</span>
</span><span id="Ditras-573"><a href="#Ditras-573"><span class="linenos">573</span></a><span class="sd">        Args:</span>
</span><span id="Ditras-574"><a href="#Ditras-574"><span class="linenos">574</span></a><span class="sd">            agent (Agent): The agent to simulate.</span>
</span><span id="Ditras-575"><a href="#Ditras-575"><span class="linenos">575</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="Ditras-576"><a href="#Ditras-576"><span class="linenos">576</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="Ditras-577"><a href="#Ditras-577"><span class="linenos">577</span></a><span class="sd">        Returns:</span>
</span><span id="Ditras-578"><a href="#Ditras-578"><span class="linenos">578</span></a><span class="sd">            None: The method updates `self._trajectories` in place.</span>
</span><span id="Ditras-579"><a href="#Ditras-579"><span class="linenos">579</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Ditras-580"><a href="#Ditras-580"><span class="linenos">580</span></a>
</span><span id="Ditras-581"><a href="#Ditras-581"><span class="linenos">581</span></a>        <span class="n">n_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="Ditras-582"><a href="#Ditras-582"><span class="linenos">582</span></a>        <span class="n">iter_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Ditras-583"><a href="#Ditras-583"><span class="linenos">583</span></a>
</span><span id="Ditras-584"><a href="#Ditras-584"><span class="linenos">584</span></a>        <span class="n">diary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diary_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">duration_hours</span><span class="o">=</span><span class="n">n_hours</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
</span><span id="Ditras-585"><a href="#Ditras-585"><span class="linenos">585</span></a>                                                  <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="Ditras-586"><a href="#Ditras-586"><span class="linenos">586</span></a>
</span><span id="Ditras-587"><a href="#Ditras-587"><span class="linenos">587</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">diary_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="Ditras-588"><a href="#Ditras-588"><span class="linenos">588</span></a>            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">abstract_location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Ditras-589"><a href="#Ditras-589"><span class="linenos">589</span></a>                <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span>
</span><span id="Ditras-590"><a href="#Ditras-590"><span class="linenos">590</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Ditras-591"><a href="#Ditras-591"><span class="linenos">591</span></a>                <span class="n">iter_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Ditras-592"><a href="#Ditras-592"><span class="linenos">592</span></a>                <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_next_location</span><span class="p">()</span>
</span><span id="Ditras-593"><a href="#Ditras-593"><span class="linenos">593</span></a>
</span><span id="Ditras-594"><a href="#Ditras-594"><span class="linenos">594</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="n">next_loc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Ditras-595"><a href="#Ditras-595"><span class="linenos">595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">])</span>
</span><span id="Ditras-596"><a href="#Ditras-596"><span class="linenos">596</span></a>
</span><span id="Ditras-597"><a href="#Ditras-597"><span class="linenos">597</span></a>    <span class="n">simulate_agent_trajectory</span> <span class="o">=</span> <span class="n">_simulate_agent_trajectory</span>  <span class="c1"># Expose for docs</span>
</span></pre></div>


            <div class="docstring"><p>Ditras model, inheriting from EPR. Uses a Markov chain for diary generation. Overrides the trajectory generation method to
incorporate diary-based location choices. Requires a MarkovChain instance for diary generation.</p>
</div>


                            <div id="Ditras.__init__" class="classattr">
                                        <input id="Ditras.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Ditras</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n"><a href="#EPRConfig">EPRConfig</a></span>,</span><span class="param">	<span class="n">diary_generator</span><span class="p">:</span> <span class="n"><a href="markov_chain.html#MarkovChain">src.markov_chain.MarkovChain</a></span></span>)</span>

                <label class="view-source-button" for="Ditras.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Ditras.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Ditras.__init__-491"><a href="#Ditras.__init__-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">EPRConfig</span><span class="p">,</span> <span class="n">diary_generator</span><span class="p">:</span> <span class="n">MarkovChain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras.__init__-492"><a href="#Ditras.__init__-492"><span class="linenos">492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras.__init__-493"><a href="#Ditras.__init__-493"><span class="linenos">493</span></a><span class="sd">        Initialize the Ditras model with the given configuration and diary generator. Inherits from EPR.</span>
</span><span id="Ditras.__init__-494"><a href="#Ditras.__init__-494"><span class="linenos">494</span></a>
</span><span id="Ditras.__init__-495"><a href="#Ditras.__init__-495"><span class="linenos">495</span></a><span class="sd">        Args:</span>
</span><span id="Ditras.__init__-496"><a href="#Ditras.__init__-496"><span class="linenos">496</span></a><span class="sd">            config (EPRConfig): Configuration parameters for the EPR model.</span>
</span><span id="Ditras.__init__-497"><a href="#Ditras.__init__-497"><span class="linenos">497</span></a><span class="sd">            diary_generator (MarkovChain): An instance of MarkovChain for generating activity diaries.</span>
</span><span id="Ditras.__init__-498"><a href="#Ditras.__init__-498"><span class="linenos">498</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Ditras.__init__-499"><a href="#Ditras.__init__-499"><span class="linenos">499</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="Ditras.__init__-500"><a href="#Ditras.__init__-500"><span class="linenos">500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_diary_generator</span> <span class="o">=</span> <span class="n">diary_generator</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Ditras model with the given configuration and diary generator. Inherits from EPR.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>config (EPRConfig):</strong>  Configuration parameters for the EPR model.</li>
<li><strong>diary_generator (MarkovChain):</strong>  An instance of MarkovChain for generating activity diaries.</li>
</ul>
</div>


                            </div>
                            <div id="Ditras.generate_synthetic_trajectory" class="classattr">
                                        <input id="Ditras.generate_synthetic_trajectory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_synthetic_trajectory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">tessellation</span><span class="p">:</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span>,</span><span class="param">	<span class="n">gravity_model</span><span class="p">:</span> <span class="n"><a href="gravity.html#Gravity">src.gravity.Gravity</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">od_matrix</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">_lil</span><span class="o">.</span><span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">geopandas</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span>:</span></span>

                <label class="view-source-button" for="Ditras.generate_synthetic_trajectory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Ditras.generate_synthetic_trajectory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Ditras.generate_synthetic_trajectory-502"><a href="#Ditras.generate_synthetic_trajectory-502"><span class="linenos">502</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
</span><span id="Ditras.generate_synthetic_trajectory-503"><a href="#Ditras.generate_synthetic_trajectory-503"><span class="linenos">503</span></a>                                      <span class="n">tessellation</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">gravity_model</span><span class="p">:</span> <span class="n">Gravity</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Ditras.generate_synthetic_trajectory-504"><a href="#Ditras.generate_synthetic_trajectory-504"><span class="linenos">504</span></a>                                      <span class="n">starting_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">od_matrix</span><span class="p">:</span> <span class="n">lil_matrix</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Ditras.generate_synthetic_trajectory-505"><a href="#Ditras.generate_synthetic_trajectory-505"><span class="linenos">505</span></a>                                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-506"><a href="#Ditras.generate_synthetic_trajectory-506"><span class="linenos">506</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras.generate_synthetic_trajectory-507"><a href="#Ditras.generate_synthetic_trajectory-507"><span class="linenos">507</span></a><span class="sd">        Simulate trajectories for *n_agents* between *start_date* and *end_date*. Each agent starts from a specified or</span>
</span><span id="Ditras.generate_synthetic_trajectory-508"><a href="#Ditras.generate_synthetic_trajectory-508"><span class="linenos">508</span></a><span class="sd">        random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity</span>
</span><span id="Ditras.generate_synthetic_trajectory-509"><a href="#Ditras.generate_synthetic_trajectory-509"><span class="linenos">509</span></a><span class="sd">        model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</span>
</span><span id="Ditras.generate_synthetic_trajectory-510"><a href="#Ditras.generate_synthetic_trajectory-510"><span class="linenos">510</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-511"><a href="#Ditras.generate_synthetic_trajectory-511"><span class="linenos">511</span></a><span class="sd">        Args:</span>
</span><span id="Ditras.generate_synthetic_trajectory-512"><a href="#Ditras.generate_synthetic_trajectory-512"><span class="linenos">512</span></a><span class="sd">            n_agents (int): Number of agents to simulate.</span>
</span><span id="Ditras.generate_synthetic_trajectory-513"><a href="#Ditras.generate_synthetic_trajectory-513"><span class="linenos">513</span></a><span class="sd">            start_date (datetime): Start date of the simulation period.</span>
</span><span id="Ditras.generate_synthetic_trajectory-514"><a href="#Ditras.generate_synthetic_trajectory-514"><span class="linenos">514</span></a><span class="sd">            end_date (datetime): End date of the simulation period.</span>
</span><span id="Ditras.generate_synthetic_trajectory-515"><a href="#Ditras.generate_synthetic_trajectory-515"><span class="linenos">515</span></a><span class="sd">            tessellation (gpd.GeoDataFrame): Spatial tessellation with a geometry column and an attractiveness column.</span>
</span><span id="Ditras.generate_synthetic_trajectory-516"><a href="#Ditras.generate_synthetic_trajectory-516"><span class="linenos">516</span></a><span class="sd">            gravity_model (Gravity | None): An optional Gravity model instance. If None, a default singly-constrained model is used.</span>
</span><span id="Ditras.generate_synthetic_trajectory-517"><a href="#Ditras.generate_synthetic_trajectory-517"><span class="linenos">517</span></a><span class="sd">            starting_cells (list[int] | None): Optional list of starting cell indices for agents. If provided, must have at least `n_agents` elements. If None, starting cells are chosen randomly.</span>
</span><span id="Ditras.generate_synthetic_trajectory-518"><a href="#Ditras.generate_synthetic_trajectory-518"><span class="linenos">518</span></a><span class="sd">            od_matrix (lil_matrix | None): Optional precomputed OD matrix. If None, it will be computed on‑demand.</span>
</span><span id="Ditras.generate_synthetic_trajectory-519"><a href="#Ditras.generate_synthetic_trajectory-519"><span class="linenos">519</span></a><span class="sd">            random_state (int | None): Optional random seed for reproducibility.</span>
</span><span id="Ditras.generate_synthetic_trajectory-520"><a href="#Ditras.generate_synthetic_trajectory-520"><span class="linenos">520</span></a><span class="sd">        Returns:</span>
</span><span id="Ditras.generate_synthetic_trajectory-521"><a href="#Ditras.generate_synthetic_trajectory-521"><span class="linenos">521</span></a><span class="sd">            gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</span>
</span><span id="Ditras.generate_synthetic_trajectory-522"><a href="#Ditras.generate_synthetic_trajectory-522"><span class="linenos">522</span></a><span class="sd">        Raises:</span>
</span><span id="Ditras.generate_synthetic_trajectory-523"><a href="#Ditras.generate_synthetic_trajectory-523"><span class="linenos">523</span></a><span class="sd">            ValueError: If `starting_cells` is provided but has fewer than `n_agents` elements.</span>
</span><span id="Ditras.generate_synthetic_trajectory-524"><a href="#Ditras.generate_synthetic_trajectory-524"><span class="linenos">524</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Ditras.generate_synthetic_trajectory-525"><a href="#Ditras.generate_synthetic_trajectory-525"><span class="linenos">525</span></a>        <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_cells</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_agents</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-526"><a href="#Ditras.generate_synthetic_trajectory-526"><span class="linenos">526</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;starting_cells&#39; must contain at least &#39;n_agents&#39; elements.&quot;</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-527"><a href="#Ditras.generate_synthetic_trajectory-527"><span class="linenos">527</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-528"><a href="#Ditras.generate_synthetic_trajectory-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-529"><a href="#Ditras.generate_synthetic_trajectory-529"><span class="linenos">529</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-530"><a href="#Ditras.generate_synthetic_trajectory-530"><span class="linenos">530</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-531"><a href="#Ditras.generate_synthetic_trajectory-531"><span class="linenos">531</span></a>        <span class="c1"># Spatial context</span>
</span><span id="Ditras.generate_synthetic_trajectory-532"><a href="#Ditras.generate_synthetic_trajectory-532"><span class="linenos">532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span> <span class="o">=</span> <span class="n">tessellation</span>
</span><span id="Ditras.generate_synthetic_trajectory-533"><a href="#Ditras.generate_synthetic_trajectory-533"><span class="linenos">533</span></a>        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-534"><a href="#Ditras.generate_synthetic_trajectory-534"><span class="linenos">534</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-535"><a href="#Ditras.generate_synthetic_trajectory-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_with_attractiveness_raster</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-536"><a href="#Ditras.generate_synthetic_trajectory-536"><span class="linenos">536</span></a>            <span class="n">raster</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-537"><a href="#Ditras.generate_synthetic_trajectory-537"><span class="linenos">537</span></a>            <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">tessellation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attractiveness_raster_path</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">nodata</span><span class="o">=</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-538"><a href="#Ditras.generate_synthetic_trajectory-538"><span class="linenos">538</span></a>            <span class="n">mean_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
</span><span id="Ditras.generate_synthetic_trajectory-539"><a href="#Ditras.generate_synthetic_trajectory-539"><span class="linenos">539</span></a>            <span class="n">tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mean_values</span>
</span><span id="Ditras.generate_synthetic_trajectory-540"><a href="#Ditras.generate_synthetic_trajectory-540"><span class="linenos">540</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-541"><a href="#Ditras.generate_synthetic_trajectory-541"><span class="linenos">541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_relevances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tessellation_attractiveness_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</span><span id="Ditras.generate_synthetic_trajectory-542"><a href="#Ditras.generate_synthetic_trajectory-542"><span class="linenos">542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tessellation</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_geom_centroid</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>
</span><span id="Ditras.generate_synthetic_trajectory-543"><a href="#Ditras.generate_synthetic_trajectory-543"><span class="linenos">543</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-544"><a href="#Ditras.generate_synthetic_trajectory-544"><span class="linenos">544</span></a>        <span class="c1"># Gravity model (lazily created)</span>
</span><span id="Ditras.generate_synthetic_trajectory-545"><a href="#Ditras.generate_synthetic_trajectory-545"><span class="linenos">545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="n">gravity_model</span> <span class="ow">or</span> <span class="n">Gravity</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;singly constrained&quot;</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-546"><a href="#Ditras.generate_synthetic_trajectory-546"><span class="linenos">546</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-547"><a href="#Ditras.generate_synthetic_trajectory-547"><span class="linenos">547</span></a>        <span class="c1"># OD matrix initialisation</span>
</span><span id="Ditras.generate_synthetic_trajectory-548"><a href="#Ditras.generate_synthetic_trajectory-548"><span class="linenos">548</span></a>        <span class="k">if</span> <span class="n">od_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-549"><a href="#Ditras.generate_synthetic_trajectory-549"><span class="linenos">549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">))</span>
</span><span id="Ditras.generate_synthetic_trajectory-550"><a href="#Ditras.generate_synthetic_trajectory-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Ditras.generate_synthetic_trajectory-551"><a href="#Ditras.generate_synthetic_trajectory-551"><span class="linenos">551</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-552"><a href="#Ditras.generate_synthetic_trajectory-552"><span class="linenos">552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od</span> <span class="o">=</span> <span class="n">od_matrix</span>
</span><span id="Ditras.generate_synthetic_trajectory-553"><a href="#Ditras.generate_synthetic_trajectory-553"><span class="linenos">553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_od_is_sparse</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Ditras.generate_synthetic_trajectory-554"><a href="#Ditras.generate_synthetic_trajectory-554"><span class="linenos">554</span></a>
</span><span id="Ditras.generate_synthetic_trajectory-555"><a href="#Ditras.generate_synthetic_trajectory-555"><span class="linenos">555</span></a>        <span class="c1"># Simulate each agent separately</span>
</span><span id="Ditras.generate_synthetic_trajectory-556"><a href="#Ditras.generate_synthetic_trajectory-556"><span class="linenos">556</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Trajectory generation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="Ditras.generate_synthetic_trajectory-557"><a href="#Ditras.generate_synthetic_trajectory-557"><span class="linenos">557</span></a>            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Ditras.generate_synthetic_trajectory-558"><a href="#Ditras.generate_synthetic_trajectory-558"><span class="linenos">558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Ditras.generate_synthetic_trajectory-559"><a href="#Ditras.generate_synthetic_trajectory-559"><span class="linenos">559</span></a>                    <span class="n">starting_cells</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">starting_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-560"><a href="#Ditras.generate_synthetic_trajectory-560"><span class="linenos">560</span></a>                <span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-561"><a href="#Ditras.generate_synthetic_trajectory-561"><span class="linenos">561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-562"><a href="#Ditras.generate_synthetic_trajectory-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-563"><a href="#Ditras.generate_synthetic_trajectory-563"><span class="linenos">563</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-564"><a href="#Ditras.generate_synthetic_trajectory-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_dataframe</span><span class="p">()</span>
</span><span id="Ditras.generate_synthetic_trajectory-565"><a href="#Ditras.generate_synthetic_trajectory-565"><span class="linenos">565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">expand_trajectory_to_hourly_steps</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</span><span id="Ditras.generate_synthetic_trajectory-566"><a href="#Ditras.generate_synthetic_trajectory-566"><span class="linenos">566</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_trajectories_to_geodataframe</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Simulate trajectories for <em>n_agents</em> between <em>start_date</em> and <em>end_date</em>. Each agent starts from a specified or
random cell in the tessellation. The OD matrix is computed on‑demand using the provided or default gravity
model. The resulting trajectories are returned as a GeoDataFrame with point geometries at cell centroids.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>n_agents (int):</strong>  Number of agents to simulate.</li>
<li><strong>start_date (datetime):</strong>  Start date of the simulation period.</li>
<li><strong>end_date (datetime):</strong>  End date of the simulation period.</li>
<li><strong>tessellation (gpd.GeoDataFrame):</strong>  Spatial tessellation with a geometry column and an attractiveness column.</li>
<li><strong>gravity_model (Gravity | None):</strong>  An optional Gravity model instance. If None, a default singly-constrained model is used.</li>
<li><strong>starting_cells (list[int] | None):</strong>  Optional list of starting cell indices for agents. If provided, must have at least <code>n_agents</code> elements. If None, starting cells are chosen randomly.</li>
<li><strong>od_matrix (lil_matrix | None):</strong>  Optional precomputed OD matrix. If None, it will be computed on‑demand.</li>
<li><strong>random_state (int | None):</strong>  Optional random seed for reproducibility.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>gpd.GeoDataFrame: The simulated trajectories with columns: agent_id, timestamp, lat, lon, geometry.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If <code>starting_cells</code> is provided but has fewer than <code>n_agents</code> elements.</li>
</ul>
</div>


                            </div>
                            <div id="Ditras.simulate_agent_trajectory" class="classattr">
                                        <input id="Ditras.simulate_agent_trajectory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">simulate_agent_trajectory</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">agent</span><span class="p">:</span> <span class="n"><a href="agent.html#Agent">src.agent.Agent</a></span>,</span><span class="param">	<span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>,</span><span class="param">	<span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Ditras.simulate_agent_trajectory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Ditras.simulate_agent_trajectory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Ditras.simulate_agent_trajectory-568"><a href="#Ditras.simulate_agent_trajectory-568"><span class="linenos">568</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_agent_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Ditras.simulate_agent_trajectory-569"><a href="#Ditras.simulate_agent_trajectory-569"><span class="linenos">569</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Ditras.simulate_agent_trajectory-570"><a href="#Ditras.simulate_agent_trajectory-570"><span class="linenos">570</span></a><span class="sd">        Run the event‑based simulation loop for a single agent.</span>
</span><span id="Ditras.simulate_agent_trajectory-571"><a href="#Ditras.simulate_agent_trajectory-571"><span class="linenos">571</span></a><span class="sd">        The agent starts at the specified starting cell and follows an activity diary generated by a Markov chain.</span>
</span><span id="Ditras.simulate_agent_trajectory-572"><a href="#Ditras.simulate_agent_trajectory-572"><span class="linenos">572</span></a><span class="sd">        The trajectory is recorded in `self._trajectories`.</span>
</span><span id="Ditras.simulate_agent_trajectory-573"><a href="#Ditras.simulate_agent_trajectory-573"><span class="linenos">573</span></a><span class="sd">        Args:</span>
</span><span id="Ditras.simulate_agent_trajectory-574"><a href="#Ditras.simulate_agent_trajectory-574"><span class="linenos">574</span></a><span class="sd">            agent (Agent): The agent to simulate.</span>
</span><span id="Ditras.simulate_agent_trajectory-575"><a href="#Ditras.simulate_agent_trajectory-575"><span class="linenos">575</span></a><span class="sd">            start_date (datetime): The start date of the simulation period.</span>
</span><span id="Ditras.simulate_agent_trajectory-576"><a href="#Ditras.simulate_agent_trajectory-576"><span class="linenos">576</span></a><span class="sd">            end_date (datetime): The end date of the simulation period.</span>
</span><span id="Ditras.simulate_agent_trajectory-577"><a href="#Ditras.simulate_agent_trajectory-577"><span class="linenos">577</span></a><span class="sd">        Returns:</span>
</span><span id="Ditras.simulate_agent_trajectory-578"><a href="#Ditras.simulate_agent_trajectory-578"><span class="linenos">578</span></a><span class="sd">            None: The method updates `self._trajectories` in place.</span>
</span><span id="Ditras.simulate_agent_trajectory-579"><a href="#Ditras.simulate_agent_trajectory-579"><span class="linenos">579</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Ditras.simulate_agent_trajectory-580"><a href="#Ditras.simulate_agent_trajectory-580"><span class="linenos">580</span></a>
</span><span id="Ditras.simulate_agent_trajectory-581"><a href="#Ditras.simulate_agent_trajectory-581"><span class="linenos">581</span></a>        <span class="n">n_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="Ditras.simulate_agent_trajectory-582"><a href="#Ditras.simulate_agent_trajectory-582"><span class="linenos">582</span></a>        <span class="n">iter_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Ditras.simulate_agent_trajectory-583"><a href="#Ditras.simulate_agent_trajectory-583"><span class="linenos">583</span></a>
</span><span id="Ditras.simulate_agent_trajectory-584"><a href="#Ditras.simulate_agent_trajectory-584"><span class="linenos">584</span></a>        <span class="n">diary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diary_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">duration_hours</span><span class="o">=</span><span class="n">n_hours</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
</span><span id="Ditras.simulate_agent_trajectory-585"><a href="#Ditras.simulate_agent_trajectory-585"><span class="linenos">585</span></a>                                                  <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="Ditras.simulate_agent_trajectory-586"><a href="#Ditras.simulate_agent_trajectory-586"><span class="linenos">586</span></a>
</span><span id="Ditras.simulate_agent_trajectory-587"><a href="#Ditras.simulate_agent_trajectory-587"><span class="linenos">587</span></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">diary_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="Ditras.simulate_agent_trajectory-588"><a href="#Ditras.simulate_agent_trajectory-588"><span class="linenos">588</span></a>            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">abstract_location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Ditras.simulate_agent_trajectory-589"><a href="#Ditras.simulate_agent_trajectory-589"><span class="linenos">589</span></a>                <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_start_cell</span>
</span><span id="Ditras.simulate_agent_trajectory-590"><a href="#Ditras.simulate_agent_trajectory-590"><span class="linenos">590</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Ditras.simulate_agent_trajectory-591"><a href="#Ditras.simulate_agent_trajectory-591"><span class="linenos">591</span></a>                <span class="n">iter_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Ditras.simulate_agent_trajectory-592"><a href="#Ditras.simulate_agent_trajectory-592"><span class="linenos">592</span></a>                <span class="n">next_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_next_location</span><span class="p">()</span>
</span><span id="Ditras.simulate_agent_trajectory-593"><a href="#Ditras.simulate_agent_trajectory-593"><span class="linenos">593</span></a>
</span><span id="Ditras.simulate_agent_trajectory-594"><a href="#Ditras.simulate_agent_trajectory-594"><span class="linenos">594</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">visited_locations</span><span class="p">[</span><span class="n">next_loc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Ditras.simulate_agent_trajectory-595"><a href="#Ditras.simulate_agent_trajectory-595"><span class="linenos">595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">iter_idx</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Run the event‑based simulation loop for a single agent.
The agent starts at the specified starting cell and follows an activity diary generated by a Markov chain.
The trajectory is recorded in <code>self._trajectories</code>.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>agent (Agent):</strong>  The agent to simulate.</li>
<li><strong>start_date (datetime):</strong>  The start date of the simulation period.</li>
<li><strong>end_date (datetime):</strong>  The end date of the simulation period.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: The method updates <code>self._trajectories</code> in place.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#EPR">EPR</a></dt>
                                <dd id="Ditras.name" class="variable"><a href="#EPR.name">name</a></dd>
                <dd id="Ditras.rho" class="variable"><a href="#EPR.rho">rho</a></dd>
                <dd id="Ditras.gamma" class="variable"><a href="#EPR.gamma">gamma</a></dd>
                <dd id="Ditras.beta" class="variable"><a href="#EPR.beta">beta</a></dd>
                <dd id="Ditras.tau" class="variable"><a href="#EPR.tau">tau</a></dd>
                <dd id="Ditras.min_waiting_time_hours" class="variable"><a href="#EPR.min_waiting_time_hours">min_waiting_time_hours</a></dd>
                <dd id="Ditras.trajectories" class="variable"><a href="#EPR.trajectories">trajectories</a></dd>
                <dd id="Ditras.trajectories_df" class="variable"><a href="#EPR.trajectories_df">trajectories_df</a></dd>
                <dd id="Ditras.convert_trajectories_to_dataframe" class="function"><a href="#EPR.convert_trajectories_to_dataframe">convert_trajectories_to_dataframe</a></dd>
                <dd id="Ditras.convert_trajectories_to_geodataframe" class="function"><a href="#EPR.convert_trajectories_to_geodataframe">convert_trajectories_to_geodataframe</a></dd>
                <dd id="Ditras.expand_trajectory_to_hourly_steps" class="function"><a href="#EPR.expand_trajectory_to_hourly_steps">expand_trajectory_to_hourly_steps</a></dd>
                <dd id="Ditras.pick_preferential_location" class="function"><a href="#EPR.pick_preferential_location">pick_preferential_location</a></dd>
                <dd id="Ditras.explore_new_location" class="function"><a href="#EPR.explore_new_location">explore_new_location</a></dd>
                <dd id="Ditras.choose_next_location" class="function"><a href="#EPR.choose_next_location">choose_next_location</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>