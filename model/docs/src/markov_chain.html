<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>src.markov_chain API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../src.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;src</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MarkovChainConfig">MarkovChainConfig</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#MarkovChainConfig.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChainConfig.chain_length">chain_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChainConfig.time_slot">time_slot</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChainConfig.label_column">label_column</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChainConfig.validate_chain_length">validate_chain_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChainConfig.model_config">model_config</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MarkovChain">MarkovChain</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MarkovChain.__init__">MarkovChain</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChain.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChain.chain_length">chain_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChain.time_slot">time_slot</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChain.label_column">label_column</a>
                        </li>
                        <li>
                                <a class="variable" href="#MarkovChain.chain">chain</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.fit">fit</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.generate">generate</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.initialize_empty_chain">initialize_empty_chain</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.group_by_time_slot">group_by_time_slot</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.compute_location_stats">compute_location_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.most_frequent_location">most_frequent_location</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.get_time_shift">get_time_shift</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.process_individual">process_individual</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.compute_tau">compute_tau</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.handle_home_transition">handle_home_transition</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.handle_non_home_transition">handle_non_home_transition</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.update_chain">update_chain</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.normalize_chain">normalize_chain</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.choose_weighted">choose_weighted</a>
                        </li>
                        <li>
                                <a class="function" href="#MarkovChain.states_to_diary">states_to_diary</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../src.html">src</a><wbr>.markov_chain    </h1>

                
                        <input id="mod-markov_chain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-markov_chain-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">humobi.structures.trajectory</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrajectoriesFrame</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MarkovChainConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    Configuration for the Markov Chain model. Includes parameters for chain length, time slot granularity, and label</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    column name.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    Attributes:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        name (str): Name of the Markov chain model.</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">        chain_length (int): Length of the Markov chain (24, 168, or 336).</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        time_slot (str): Time slot granularity, e.g. &#39;1h&#39;.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">        label_column (str): Name of the column with location labels.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;Markov Chain&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name of the Markov chain model&quot;</span><span class="p">)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>    <span class="n">chain_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Length of the Markov chain (24, 168, or 336)&quot;</span><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="n">time_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Time slot granularity, e.g. &#39;1h&#39;&quot;</span><span class="p">)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">label_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name of the column with location labels&quot;</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;chain_length&quot;</span><span class="p">)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_chain_length</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        Validate that chain_length is one of the accepted values: 24, 168, or 336.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">        Args:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">            value (int): The chain length to validate.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">        Returns:</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">            int: The validated chain length.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        Raises:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">            ValueError: If chain_length is not one of the accepted values.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">336</span><span class="p">]:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chain_length must be one of: 24, 168, or 336&quot;</span><span class="p">)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="k">return</span> <span class="n">value</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MarkovChain</span><span class="p">:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    A Markov Chain model for simulating individual mobility patterns based on historical trajectory data.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    The model uses a state space defined by time slots and abstract location types (home and non-typical locations).</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MarkovChainConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        Initialize the Markov Chain model with the given configuration.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">        Args:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">            config (MarkovChainConfig): Configuration parameters for the Markov Chain model.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slot</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">time_slot</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_column</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">label_column</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>            <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_empty_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">        Initialize an empty Markov chain with all possible states and zero transition probabilities.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">        The state space consists of tuples (h, r) where h is the hour in the chain (0 to chain_length-1) and r is the</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        location type (0 for non-typical, 1 for home).</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        The transition probabilities are stored in a nested defaultdict structure.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="k">for</span> <span class="n">state1</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="k">for</span> <span class="n">state2</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">state1</span><span class="p">][</span><span class="n">state2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_group_by_time_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        Group trajectory data into specified time slots, concatenating location labels within each slot.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        This method resamples the trajectory data based on the configured time slot and aggregates location labels by</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">        joining them with commas. Empty slots are represented as NaN.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        Args:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">            trajectory (TrajectoriesFrame): The trajectory data to be grouped.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">        Returns:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">            pd.Series: A series indexed by time slots with concatenated location labels.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="n">series</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="n">grouped</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_slot</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="k">return</span> <span class="n">grouped</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_location_stats</span><span class="p">(</span><span class="n">grouped_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        Compute frequency and rank of locations from the grouped series.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        This method analyzes the concatenated location labels in each time slot to determine how often each location</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        appears and assigns ranks based on frequency.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        Args:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">            grouped_series (pd.Series): A series with concatenated location labels per time slot.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        Returns:</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">            tuple[dict, dict]: A tuple containing two dictionaries: one for location frequencies and another for location ranks.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">freq</span><span class="p">:</span> <span class="n">Counter</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">grouped_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="n">freq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="n">ranks</span> <span class="o">=</span> <span class="p">{</span><span class="n">loc</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">())}</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">ranks</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_most_frequent_location</span><span class="p">(</span><span class="n">slot_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">freq_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        Determine the most frequent location from a comma-separated string of locations.</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        If there&#39;s a tie in frequency, the location with the highest overall frequency in freq_map is chosen.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        Args:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">            slot_string (str): A comma-separated string of location labels.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">            freq_map (dict): A dictionary mapping locations to their overall frequencies.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">        Returns:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">            str | float: The most frequent location label, or NaN if input is invalid.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">slot_string</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="n">locations</span> <span class="o">=</span> <span class="n">slot_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="n">location_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="k">return</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span> <span class="n">freq_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="n">location_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_time_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        Calculate the time shift based on the date and chain length. This determines the starting hour in the Markov</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        chain corresponding to the given date.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        Args:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            date (pd.Timestamp): The date and time to calculate the shift for.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        Returns:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            int: The calculated time shift (hour) in the Markov chain.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        Raises:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">            ValueError: If chain_length is not one of the supported values (24, 168, 336).</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="n">date_midnight</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">start_of_week</span><span class="p">(</span><span class="n">weeks_back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="c1"># Returns the start of the week shifted back by n_weeks weeks (default is 1 week)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">return</span> <span class="n">date_midnight</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">date_midnight</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">weeks_back</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">hour</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">168</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">start_of_week</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">336</span><span class="p">:</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="n">is_even_week</span> <span class="o">=</span> <span class="n">date_midnight</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">start_of_week</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_even_week</span> <span class="k">else</span> <span class="n">start_of_week</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported chain_length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_individual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">        Process an individual&#39;s trajectory data to create a series of abstract locations per time slot.</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">        This method groups the user&#39;s trajectory data by time slots, computes location statistics, and fills in</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">        missing values by forward and backward filling. The resulting series maps each time slot to an abstract</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        location rank.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        Args:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">            user_data (TrajectoriesFrame): The trajectory data for a single user.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Returns:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            pd.Series: A series indexed by time slots with abstract location ranks.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="n">grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by_time_slot</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="n">freq_map</span><span class="p">,</span> <span class="n">rank_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_location_stats</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">abstract_series</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_most_frequent_location</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq_map</span><span class="p">))</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="n">abstract_series</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="n">abstract_series</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">abstract_series</span> <span class="o">=</span> <span class="n">abstract_series</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rank_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="k">return</span> <span class="n">abstract_series</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">        Compute the duration (tau) of consecutive occurrences of target_loc in the series starting from start_idx.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        Returns the count of consecutive occurrences and the index where the sequence ends.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        Args:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">            series (pd.Series): The series to analyze.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">            start_idx (int): The starting index to check for consecutive occurrences.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">            target_loc (int): The location label to count consecutively.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        Returns:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">            Tuple[int, int]: A tuple containing the count of consecutive occurrences (tau) and the index where the sequence ends.</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># start with 1 to count the current location</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="n">j</span> <span class="o">=</span> <span class="n">start_idx</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_loc</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="n">tau</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">return</span> <span class="n">tau</span><span class="p">,</span> <span class="n">j</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_home_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">        Handle transitions when the current location is &#39;home&#39; (1). Updates the Markov chain based on the next location.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        Args:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">            slot (int): The current index in the series.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">            h (int): The current hour in the Markov chain.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">            next_h (int): The next hour in the Markov chain.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">            next_loc (int): The next location label.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            n (int): The total length of the series.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        Returns:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">            int: The updated index in the series after handling the transition.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="n">next_loc</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">home</span><span class="p">)][(</span><span class="n">next_h</span><span class="p">,</span> <span class="n">home</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="n">tau</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="n">h_tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">home</span><span class="p">)][(</span><span class="n">h_tau</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">slot</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_non_home_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                                    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">        Handle transitions when the current location is &#39;non-typical&#39; (not home). Updates the Markov chain based on the</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        next location.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        Args:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">            slot (int): The current index in the series.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">            h (int): The current hour in the Markov chain.</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">            next_h (int): The next hour in the Markov chain.</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">            next_loc (int): The next location label.</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            n (int): The total length of the series.</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">        Returns:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">            int: The updated index in the series after handling the transition.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="n">next_loc</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)][(</span><span class="n">next_h</span><span class="p">,</span> <span class="n">home</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="k">if</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="n">tau</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="n">h_tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)][(</span><span class="n">h_tau</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="k">return</span> <span class="n">slot</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        Update the Markov chain with transitions from the given series of abstract locations, applying a time shift.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        The method iterates through the series, handling transitions based on whether the current location is &#39;home&#39; or</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        &#39;non-typical&#39;, and updates the transition counts in the Markov chain accordingly.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        Args:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">            shift (int): The time shift to apply to the series.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        Returns:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">            None</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="k">while</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="n">next_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">current</span><span class="p">,</span> <span class="n">next_loc</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_home_transition</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">next_h</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_non_home_transition</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">next_h</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="n">slot</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">        Normalize the transition counts in the Markov chain to probabilities.</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">        This method iterates through each origin state in the Markov chain and normalizes the transition counts to</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="sd">        probabilities by dividing each count by the total count of transitions from that state. If a state has no</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        outgoing transitions, its probabilities remain zero.</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        Returns:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">            None</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="k">for</span> <span class="n">origin</span><span class="p">,</span> <span class="n">transitions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                    <span class="n">transitions</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        Fit the Markov chain model to the provided trajectory data.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        The method initializes an empty Markov chain, processes each user&#39;s trajectory data to extract abstract location</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">        series, applies the appropriate time shift, updates the Markov chain with transitions, and finally normalizes</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        the transition counts to probabilities.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">        Args:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">            trajectory (TrajectoriesFrame): The trajectory data to fit the model to.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">        Returns:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">            None</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_empty_chain</span><span class="p">()</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting Markov Chain&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="n">user_data</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">uloc</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_individual</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_shift</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_chain</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_chain</span><span class="p">()</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_choose_weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">        Choose an index based on the provided weights using a weighted random selection. The method computes</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        the cumulative sum of the weights and selects an index where a random number falls within the cumulative</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        distribution.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        Args:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">            weights (list[float]): A list of weights for each index.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">        Returns:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">            int: The selected index based on the weights.</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()))</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        Generate a synthetic trajectory for a specified duration starting from a given date using the fitted</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        Markov chain. The method simulates the trajectory by transitioning through states in the Markov chain based</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">        on the learned transition probabilities. The generated trajectory is returned as a DataFrame with timestamps</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        and abstract location labels.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">        Args:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">            duration_hours (int): The total duration of the generated trajectory in hours.</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">            start_date (pd.Timestamp): The starting date and time for the generated trajectory.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">            seed (Optional[int]): An optional random seed for reproducibility.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        Returns:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">            pd.DataFrame: A DataFrame containing the generated trajectory with columns &#39;datetime&#39; and &#39;abstract_location&#39;.</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_shift</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="n">prev_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_state</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="n">step</span><span class="p">,</span> <span class="n">hours_generated</span> <span class="o">=</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">while</span> <span class="n">hours_generated</span> <span class="o">&lt;</span> <span class="n">duration_hours</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">prev_state</span><span class="p">]</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">next_state</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="p">((</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                <span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="bp">self</span><span class="o">.</span><span class="n">_choose_weighted</span><span class="p">(</span><span class="n">probs</span><span class="p">)]</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="n">step</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="n">hours_generated</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">next_state</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">diary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states_to_diary</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">,</span> <span class="n">start_date</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">diary</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract_location&#39;</span><span class="p">])</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_states_to_diary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        Convert a list of states into a diary format with timestamps and location labels.</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        This method processes the list of states generated by the Markov chain to create a diary that records the</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        timestamp and corresponding location label for each hour. Consecutive entries with the same location are</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        merged to simplify the diary.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">        Args:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">            states (list[tuple]): A list of states represented as tuples (hour, location).</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">            max_length (int): The maximum length of the diary in hours.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">            start_time (pd.Timestamp): The starting timestamp for the diary.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        Returns:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">            List[Tuple[pd.Timestamp, int]]: A list of tuples containing timestamps and location labels.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_time</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="n">prev_state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="n">location_counter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="n">log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">current_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="n">h</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="n">h_prev</span><span class="p">,</span> <span class="n">loc_prev</span> <span class="o">=</span> <span class="n">prev_state</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                <span class="n">location_counter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">h_prev</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hours</span><span class="p">):</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_time</span><span class="p">,</span> <span class="n">location_counter</span><span class="p">))</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="n">location_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="c1"># Simplify log by merging consecutive entries with same location</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="n">simplified</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="n">last_location</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">log</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">last_location</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="n">simplified</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                <span class="n">last_location</span> <span class="o">=</span> <span class="n">loc</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="k">return</span> <span class="n">simplified</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>    <span class="n">initialize_empty_chain</span> <span class="o">=</span> <span class="n">_initialize_empty_chain</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>    <span class="n">group_by_time_slot</span> <span class="o">=</span> <span class="n">_group_by_time_slot</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="n">compute_location_stats</span> <span class="o">=</span> <span class="n">_compute_location_stats</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>    <span class="n">most_frequent_location</span> <span class="o">=</span> <span class="n">_most_frequent_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="n">get_time_shift</span> <span class="o">=</span> <span class="n">_get_time_shift</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>    <span class="n">process_individual</span> <span class="o">=</span> <span class="n">_process_individual</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>    <span class="n">compute_tau</span> <span class="o">=</span> <span class="n">_compute_tau</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>    <span class="n">handle_home_transition</span> <span class="o">=</span> <span class="n">_handle_home_transition</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="n">handle_non_home_transition</span> <span class="o">=</span> <span class="n">_handle_non_home_transition</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    <span class="n">update_chain</span> <span class="o">=</span> <span class="n">_update_chain</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>    <span class="n">normalize_chain</span> <span class="o">=</span> <span class="n">_normalize_chain</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="n">choose_weighted</span> <span class="o">=</span> <span class="n">_choose_weighted</span>  <span class="c1"># Expose for docs</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>    <span class="n">states_to_diary</span> <span class="o">=</span> <span class="n">_states_to_diary</span>  <span class="c1"># Expose for docs</span>
</span></pre></div>


            </section>
                <section id="MarkovChainConfig">
                            <input id="MarkovChainConfig-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MarkovChainConfig</span><wbr>(<span class="base">pydantic.main.BaseModel</span>):

                <label class="view-source-button" for="MarkovChainConfig-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChainConfig"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChainConfig-13"><a href="#MarkovChainConfig-13"><span class="linenos">13</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MarkovChainConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="MarkovChainConfig-14"><a href="#MarkovChainConfig-14"><span class="linenos">14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChainConfig-15"><a href="#MarkovChainConfig-15"><span class="linenos">15</span></a><span class="sd">    Configuration for the Markov Chain model. Includes parameters for chain length, time slot granularity, and label</span>
</span><span id="MarkovChainConfig-16"><a href="#MarkovChainConfig-16"><span class="linenos">16</span></a><span class="sd">    column name.</span>
</span><span id="MarkovChainConfig-17"><a href="#MarkovChainConfig-17"><span class="linenos">17</span></a>
</span><span id="MarkovChainConfig-18"><a href="#MarkovChainConfig-18"><span class="linenos">18</span></a><span class="sd">    Attributes:</span>
</span><span id="MarkovChainConfig-19"><a href="#MarkovChainConfig-19"><span class="linenos">19</span></a><span class="sd">        name (str): Name of the Markov chain model.</span>
</span><span id="MarkovChainConfig-20"><a href="#MarkovChainConfig-20"><span class="linenos">20</span></a><span class="sd">        chain_length (int): Length of the Markov chain (24, 168, or 336).</span>
</span><span id="MarkovChainConfig-21"><a href="#MarkovChainConfig-21"><span class="linenos">21</span></a><span class="sd">        time_slot (str): Time slot granularity, e.g. &#39;1h&#39;.</span>
</span><span id="MarkovChainConfig-22"><a href="#MarkovChainConfig-22"><span class="linenos">22</span></a><span class="sd">        label_column (str): Name of the column with location labels.</span>
</span><span id="MarkovChainConfig-23"><a href="#MarkovChainConfig-23"><span class="linenos">23</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MarkovChainConfig-24"><a href="#MarkovChainConfig-24"><span class="linenos">24</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;Markov Chain&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name of the Markov chain model&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig-25"><a href="#MarkovChainConfig-25"><span class="linenos">25</span></a>    <span class="n">chain_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Length of the Markov chain (24, 168, or 336)&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig-26"><a href="#MarkovChainConfig-26"><span class="linenos">26</span></a>    <span class="n">time_slot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Time slot granularity, e.g. &#39;1h&#39;&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig-27"><a href="#MarkovChainConfig-27"><span class="linenos">27</span></a>    <span class="n">label_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name of the column with location labels&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig-28"><a href="#MarkovChainConfig-28"><span class="linenos">28</span></a>
</span><span id="MarkovChainConfig-29"><a href="#MarkovChainConfig-29"><span class="linenos">29</span></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;chain_length&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig-30"><a href="#MarkovChainConfig-30"><span class="linenos">30</span></a>    <span class="nd">@classmethod</span>
</span><span id="MarkovChainConfig-31"><a href="#MarkovChainConfig-31"><span class="linenos">31</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_chain_length</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChainConfig-32"><a href="#MarkovChainConfig-32"><span class="linenos">32</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChainConfig-33"><a href="#MarkovChainConfig-33"><span class="linenos">33</span></a><span class="sd">        Validate that chain_length is one of the accepted values: 24, 168, or 336.</span>
</span><span id="MarkovChainConfig-34"><a href="#MarkovChainConfig-34"><span class="linenos">34</span></a>
</span><span id="MarkovChainConfig-35"><a href="#MarkovChainConfig-35"><span class="linenos">35</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChainConfig-36"><a href="#MarkovChainConfig-36"><span class="linenos">36</span></a><span class="sd">            value (int): The chain length to validate.</span>
</span><span id="MarkovChainConfig-37"><a href="#MarkovChainConfig-37"><span class="linenos">37</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChainConfig-38"><a href="#MarkovChainConfig-38"><span class="linenos">38</span></a><span class="sd">            int: The validated chain length.</span>
</span><span id="MarkovChainConfig-39"><a href="#MarkovChainConfig-39"><span class="linenos">39</span></a><span class="sd">        Raises:</span>
</span><span id="MarkovChainConfig-40"><a href="#MarkovChainConfig-40"><span class="linenos">40</span></a><span class="sd">            ValueError: If chain_length is not one of the accepted values.</span>
</span><span id="MarkovChainConfig-41"><a href="#MarkovChainConfig-41"><span class="linenos">41</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChainConfig-42"><a href="#MarkovChainConfig-42"><span class="linenos">42</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">336</span><span class="p">]:</span>
</span><span id="MarkovChainConfig-43"><a href="#MarkovChainConfig-43"><span class="linenos">43</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chain_length must be one of: 24, 168, or 336&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig-44"><a href="#MarkovChainConfig-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="n">value</span>
</span></pre></div>


            <div class="docstring"><p>Configuration for the Markov Chain model. Includes parameters for chain length, time slot granularity, and label
column name.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>name (str):</strong>  Name of the Markov chain model.</li>
<li><strong>chain_length (int):</strong>  Length of the Markov chain (24, 168, or 336).</li>
<li><strong>time_slot (str):</strong>  Time slot granularity, e.g. '1h'.</li>
<li><strong>label_column (str):</strong>  Name of the column with location labels.</li>
</ul>
</div>


                            <div id="MarkovChainConfig.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#MarkovChainConfig.name"></a>
    
    

                            </div>
                            <div id="MarkovChainConfig.chain_length" class="classattr">
                                <div class="attr variable">
            <span class="name">chain_length</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#MarkovChainConfig.chain_length"></a>
    
    

                            </div>
                            <div id="MarkovChainConfig.time_slot" class="classattr">
                                <div class="attr variable">
            <span class="name">time_slot</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#MarkovChainConfig.time_slot"></a>
    
    

                            </div>
                            <div id="MarkovChainConfig.label_column" class="classattr">
                                <div class="attr variable">
            <span class="name">label_column</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#MarkovChainConfig.label_column"></a>
    
    

                            </div>
                            <div id="MarkovChainConfig.validate_chain_length" class="classattr">
                                        <input id="MarkovChainConfig.validate_chain_length-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-field_validator">@field_validator(&#39;chain_length&#39;)</div>
        <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">validate_chain_length</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">value</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="MarkovChainConfig.validate_chain_length-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChainConfig.validate_chain_length"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChainConfig.validate_chain_length-29"><a href="#MarkovChainConfig.validate_chain_length-29"><span class="linenos">29</span></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;chain_length&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig.validate_chain_length-30"><a href="#MarkovChainConfig.validate_chain_length-30"><span class="linenos">30</span></a>    <span class="nd">@classmethod</span>
</span><span id="MarkovChainConfig.validate_chain_length-31"><a href="#MarkovChainConfig.validate_chain_length-31"><span class="linenos">31</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_chain_length</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChainConfig.validate_chain_length-32"><a href="#MarkovChainConfig.validate_chain_length-32"><span class="linenos">32</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChainConfig.validate_chain_length-33"><a href="#MarkovChainConfig.validate_chain_length-33"><span class="linenos">33</span></a><span class="sd">        Validate that chain_length is one of the accepted values: 24, 168, or 336.</span>
</span><span id="MarkovChainConfig.validate_chain_length-34"><a href="#MarkovChainConfig.validate_chain_length-34"><span class="linenos">34</span></a>
</span><span id="MarkovChainConfig.validate_chain_length-35"><a href="#MarkovChainConfig.validate_chain_length-35"><span class="linenos">35</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChainConfig.validate_chain_length-36"><a href="#MarkovChainConfig.validate_chain_length-36"><span class="linenos">36</span></a><span class="sd">            value (int): The chain length to validate.</span>
</span><span id="MarkovChainConfig.validate_chain_length-37"><a href="#MarkovChainConfig.validate_chain_length-37"><span class="linenos">37</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChainConfig.validate_chain_length-38"><a href="#MarkovChainConfig.validate_chain_length-38"><span class="linenos">38</span></a><span class="sd">            int: The validated chain length.</span>
</span><span id="MarkovChainConfig.validate_chain_length-39"><a href="#MarkovChainConfig.validate_chain_length-39"><span class="linenos">39</span></a><span class="sd">        Raises:</span>
</span><span id="MarkovChainConfig.validate_chain_length-40"><a href="#MarkovChainConfig.validate_chain_length-40"><span class="linenos">40</span></a><span class="sd">            ValueError: If chain_length is not one of the accepted values.</span>
</span><span id="MarkovChainConfig.validate_chain_length-41"><a href="#MarkovChainConfig.validate_chain_length-41"><span class="linenos">41</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChainConfig.validate_chain_length-42"><a href="#MarkovChainConfig.validate_chain_length-42"><span class="linenos">42</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">336</span><span class="p">]:</span>
</span><span id="MarkovChainConfig.validate_chain_length-43"><a href="#MarkovChainConfig.validate_chain_length-43"><span class="linenos">43</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chain_length must be one of: 24, 168, or 336&quot;</span><span class="p">)</span>
</span><span id="MarkovChainConfig.validate_chain_length-44"><a href="#MarkovChainConfig.validate_chain_length-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="n">value</span>
</span></pre></div>


            <div class="docstring"><p>Validate that chain_length is one of the accepted values: 24, 168, or 336.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>value (int):</strong>  The chain length to validate.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The validated chain length.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If chain_length is not one of the accepted values.</li>
</ul>
</div>


                            </div>
                            <div id="MarkovChainConfig.model_config" class="classattr">
                                <div class="attr variable">
            <span class="name">model_config</span><span class="annotation">: ClassVar[pydantic.config.ConfigDict]</span>        =
<span class="default_value">{}</span>

        
    </div>
    <a class="headerlink" href="#MarkovChainConfig.model_config"></a>
    
            <div class="docstring"><p>Configuration for the model, should be a dictionary conforming to [<code>ConfigDict</code>][pydantic.config.ConfigDict].</p>
</div>


                            </div>
                </section>
                <section id="MarkovChain">
                            <input id="MarkovChain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MarkovChain</span>:

                <label class="view-source-button" for="MarkovChain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain-47"><a href="#MarkovChain-47"><span class="linenos"> 47</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MarkovChain</span><span class="p">:</span>
</span><span id="MarkovChain-48"><a href="#MarkovChain-48"><span class="linenos"> 48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-49"><a href="#MarkovChain-49"><span class="linenos"> 49</span></a><span class="sd">    A Markov Chain model for simulating individual mobility patterns based on historical trajectory data.</span>
</span><span id="MarkovChain-50"><a href="#MarkovChain-50"><span class="linenos"> 50</span></a><span class="sd">    The model uses a state space defined by time slots and abstract location types (home and non-typical locations).</span>
</span><span id="MarkovChain-51"><a href="#MarkovChain-51"><span class="linenos"> 51</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MarkovChain-52"><a href="#MarkovChain-52"><span class="linenos"> 52</span></a>
</span><span id="MarkovChain-53"><a href="#MarkovChain-53"><span class="linenos"> 53</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MarkovChainConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain-54"><a href="#MarkovChain-54"><span class="linenos"> 54</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-55"><a href="#MarkovChain-55"><span class="linenos"> 55</span></a><span class="sd">        Initialize the Markov Chain model with the given configuration.</span>
</span><span id="MarkovChain-56"><a href="#MarkovChain-56"><span class="linenos"> 56</span></a>
</span><span id="MarkovChain-57"><a href="#MarkovChain-57"><span class="linenos"> 57</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-58"><a href="#MarkovChain-58"><span class="linenos"> 58</span></a><span class="sd">            config (MarkovChainConfig): Configuration parameters for the Markov Chain model.</span>
</span><span id="MarkovChain-59"><a href="#MarkovChain-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-60"><a href="#MarkovChain-60"><span class="linenos"> 60</span></a>
</span><span id="MarkovChain-61"><a href="#MarkovChain-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span id="MarkovChain-62"><a href="#MarkovChain-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-63"><a href="#MarkovChain-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slot</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">time_slot</span>
</span><span id="MarkovChain-64"><a href="#MarkovChain-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_column</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">label_column</span>
</span><span id="MarkovChain-65"><a href="#MarkovChain-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span id="MarkovChain-66"><a href="#MarkovChain-66"><span class="linenos"> 66</span></a>            <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="MarkovChain-67"><a href="#MarkovChain-67"><span class="linenos"> 67</span></a>
</span><span id="MarkovChain-68"><a href="#MarkovChain-68"><span class="linenos"> 68</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_empty_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain-69"><a href="#MarkovChain-69"><span class="linenos"> 69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-70"><a href="#MarkovChain-70"><span class="linenos"> 70</span></a><span class="sd">        Initialize an empty Markov chain with all possible states and zero transition probabilities.</span>
</span><span id="MarkovChain-71"><a href="#MarkovChain-71"><span class="linenos"> 71</span></a><span class="sd">        The state space consists of tuples (h, r) where h is the hour in the chain (0 to chain_length-1) and r is the</span>
</span><span id="MarkovChain-72"><a href="#MarkovChain-72"><span class="linenos"> 72</span></a><span class="sd">        location type (0 for non-typical, 1 for home).</span>
</span><span id="MarkovChain-73"><a href="#MarkovChain-73"><span class="linenos"> 73</span></a><span class="sd">        The transition probabilities are stored in a nested defaultdict structure.</span>
</span><span id="MarkovChain-74"><a href="#MarkovChain-74"><span class="linenos"> 74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-75"><a href="#MarkovChain-75"><span class="linenos"> 75</span></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="MarkovChain-76"><a href="#MarkovChain-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="MarkovChain-77"><a href="#MarkovChain-77"><span class="linenos"> 77</span></a>        <span class="k">for</span> <span class="n">state1</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="MarkovChain-78"><a href="#MarkovChain-78"><span class="linenos"> 78</span></a>            <span class="k">for</span> <span class="n">state2</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="MarkovChain-79"><a href="#MarkovChain-79"><span class="linenos"> 79</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">state1</span><span class="p">][</span><span class="n">state2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MarkovChain-80"><a href="#MarkovChain-80"><span class="linenos"> 80</span></a>
</span><span id="MarkovChain-81"><a href="#MarkovChain-81"><span class="linenos"> 81</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_group_by_time_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
</span><span id="MarkovChain-82"><a href="#MarkovChain-82"><span class="linenos"> 82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-83"><a href="#MarkovChain-83"><span class="linenos"> 83</span></a><span class="sd">        Group trajectory data into specified time slots, concatenating location labels within each slot.</span>
</span><span id="MarkovChain-84"><a href="#MarkovChain-84"><span class="linenos"> 84</span></a><span class="sd">        This method resamples the trajectory data based on the configured time slot and aggregates location labels by</span>
</span><span id="MarkovChain-85"><a href="#MarkovChain-85"><span class="linenos"> 85</span></a><span class="sd">        joining them with commas. Empty slots are represented as NaN.</span>
</span><span id="MarkovChain-86"><a href="#MarkovChain-86"><span class="linenos"> 86</span></a>
</span><span id="MarkovChain-87"><a href="#MarkovChain-87"><span class="linenos"> 87</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-88"><a href="#MarkovChain-88"><span class="linenos"> 88</span></a><span class="sd">            trajectory (TrajectoriesFrame): The trajectory data to be grouped.</span>
</span><span id="MarkovChain-89"><a href="#MarkovChain-89"><span class="linenos"> 89</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-90"><a href="#MarkovChain-90"><span class="linenos"> 90</span></a><span class="sd">            pd.Series: A series indexed by time slots with concatenated location labels.</span>
</span><span id="MarkovChain-91"><a href="#MarkovChain-91"><span class="linenos"> 91</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-92"><a href="#MarkovChain-92"><span class="linenos"> 92</span></a>        <span class="n">series</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="MarkovChain-93"><a href="#MarkovChain-93"><span class="linenos"> 93</span></a>        <span class="n">grouped</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_slot</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="MarkovChain-94"><a href="#MarkovChain-94"><span class="linenos"> 94</span></a>        <span class="k">return</span> <span class="n">grouped</span>
</span><span id="MarkovChain-95"><a href="#MarkovChain-95"><span class="linenos"> 95</span></a>
</span><span id="MarkovChain-96"><a href="#MarkovChain-96"><span class="linenos"> 96</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain-97"><a href="#MarkovChain-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_location_stats</span><span class="p">(</span><span class="n">grouped_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
</span><span id="MarkovChain-98"><a href="#MarkovChain-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-99"><a href="#MarkovChain-99"><span class="linenos"> 99</span></a><span class="sd">        Compute frequency and rank of locations from the grouped series.</span>
</span><span id="MarkovChain-100"><a href="#MarkovChain-100"><span class="linenos">100</span></a><span class="sd">        This method analyzes the concatenated location labels in each time slot to determine how often each location</span>
</span><span id="MarkovChain-101"><a href="#MarkovChain-101"><span class="linenos">101</span></a><span class="sd">        appears and assigns ranks based on frequency.</span>
</span><span id="MarkovChain-102"><a href="#MarkovChain-102"><span class="linenos">102</span></a>
</span><span id="MarkovChain-103"><a href="#MarkovChain-103"><span class="linenos">103</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-104"><a href="#MarkovChain-104"><span class="linenos">104</span></a><span class="sd">            grouped_series (pd.Series): A series with concatenated location labels per time slot.</span>
</span><span id="MarkovChain-105"><a href="#MarkovChain-105"><span class="linenos">105</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-106"><a href="#MarkovChain-106"><span class="linenos">106</span></a><span class="sd">            tuple[dict, dict]: A tuple containing two dictionaries: one for location frequencies and another for location ranks.</span>
</span><span id="MarkovChain-107"><a href="#MarkovChain-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-108"><a href="#MarkovChain-108"><span class="linenos">108</span></a>        <span class="n">freq</span><span class="p">:</span> <span class="n">Counter</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span><span id="MarkovChain-109"><a href="#MarkovChain-109"><span class="linenos">109</span></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">grouped_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>
</span><span id="MarkovChain-110"><a href="#MarkovChain-110"><span class="linenos">110</span></a>            <span class="n">freq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
</span><span id="MarkovChain-111"><a href="#MarkovChain-111"><span class="linenos">111</span></a>        <span class="n">ranks</span> <span class="o">=</span> <span class="p">{</span><span class="n">loc</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">())}</span>
</span><span id="MarkovChain-112"><a href="#MarkovChain-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">ranks</span>
</span><span id="MarkovChain-113"><a href="#MarkovChain-113"><span class="linenos">113</span></a>
</span><span id="MarkovChain-114"><a href="#MarkovChain-114"><span class="linenos">114</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain-115"><a href="#MarkovChain-115"><span class="linenos">115</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_most_frequent_location</span><span class="p">(</span><span class="n">slot_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">freq_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="MarkovChain-116"><a href="#MarkovChain-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-117"><a href="#MarkovChain-117"><span class="linenos">117</span></a><span class="sd">        Determine the most frequent location from a comma-separated string of locations.</span>
</span><span id="MarkovChain-118"><a href="#MarkovChain-118"><span class="linenos">118</span></a><span class="sd">        If there&#39;s a tie in frequency, the location with the highest overall frequency in freq_map is chosen.</span>
</span><span id="MarkovChain-119"><a href="#MarkovChain-119"><span class="linenos">119</span></a>
</span><span id="MarkovChain-120"><a href="#MarkovChain-120"><span class="linenos">120</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-121"><a href="#MarkovChain-121"><span class="linenos">121</span></a><span class="sd">            slot_string (str): A comma-separated string of location labels.</span>
</span><span id="MarkovChain-122"><a href="#MarkovChain-122"><span class="linenos">122</span></a><span class="sd">            freq_map (dict): A dictionary mapping locations to their overall frequencies.</span>
</span><span id="MarkovChain-123"><a href="#MarkovChain-123"><span class="linenos">123</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-124"><a href="#MarkovChain-124"><span class="linenos">124</span></a><span class="sd">            str | float: The most frequent location label, or NaN if input is invalid.</span>
</span><span id="MarkovChain-125"><a href="#MarkovChain-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-126"><a href="#MarkovChain-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">slot_string</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="MarkovChain-127"><a href="#MarkovChain-127"><span class="linenos">127</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="MarkovChain-128"><a href="#MarkovChain-128"><span class="linenos">128</span></a>
</span><span id="MarkovChain-129"><a href="#MarkovChain-129"><span class="linenos">129</span></a>        <span class="n">locations</span> <span class="o">=</span> <span class="n">slot_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="MarkovChain-130"><a href="#MarkovChain-130"><span class="linenos">130</span></a>        <span class="n">location_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
</span><span id="MarkovChain-131"><a href="#MarkovChain-131"><span class="linenos">131</span></a>
</span><span id="MarkovChain-132"><a href="#MarkovChain-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain-133"><a href="#MarkovChain-133"><span class="linenos">133</span></a>            <span class="k">return</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MarkovChain-134"><a href="#MarkovChain-134"><span class="linenos">134</span></a>
</span><span id="MarkovChain-135"><a href="#MarkovChain-135"><span class="linenos">135</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain-136"><a href="#MarkovChain-136"><span class="linenos">136</span></a>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span> <span class="n">freq_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="MarkovChain-137"><a href="#MarkovChain-137"><span class="linenos">137</span></a>
</span><span id="MarkovChain-138"><a href="#MarkovChain-138"><span class="linenos">138</span></a>        <span class="k">return</span> <span class="n">location_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MarkovChain-139"><a href="#MarkovChain-139"><span class="linenos">139</span></a>
</span><span id="MarkovChain-140"><a href="#MarkovChain-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_time_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain-141"><a href="#MarkovChain-141"><span class="linenos">141</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-142"><a href="#MarkovChain-142"><span class="linenos">142</span></a><span class="sd">        Calculate the time shift based on the date and chain length. This determines the starting hour in the Markov</span>
</span><span id="MarkovChain-143"><a href="#MarkovChain-143"><span class="linenos">143</span></a><span class="sd">        chain corresponding to the given date.</span>
</span><span id="MarkovChain-144"><a href="#MarkovChain-144"><span class="linenos">144</span></a>
</span><span id="MarkovChain-145"><a href="#MarkovChain-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-146"><a href="#MarkovChain-146"><span class="linenos">146</span></a><span class="sd">            date (pd.Timestamp): The date and time to calculate the shift for.</span>
</span><span id="MarkovChain-147"><a href="#MarkovChain-147"><span class="linenos">147</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-148"><a href="#MarkovChain-148"><span class="linenos">148</span></a><span class="sd">            int: The calculated time shift (hour) in the Markov chain.</span>
</span><span id="MarkovChain-149"><a href="#MarkovChain-149"><span class="linenos">149</span></a><span class="sd">        Raises:</span>
</span><span id="MarkovChain-150"><a href="#MarkovChain-150"><span class="linenos">150</span></a><span class="sd">            ValueError: If chain_length is not one of the supported values (24, 168, 336).</span>
</span><span id="MarkovChain-151"><a href="#MarkovChain-151"><span class="linenos">151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-152"><a href="#MarkovChain-152"><span class="linenos">152</span></a>        <span class="n">date_midnight</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MarkovChain-153"><a href="#MarkovChain-153"><span class="linenos">153</span></a>
</span><span id="MarkovChain-154"><a href="#MarkovChain-154"><span class="linenos">154</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">start_of_week</span><span class="p">(</span><span class="n">weeks_back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MarkovChain-155"><a href="#MarkovChain-155"><span class="linenos">155</span></a>            <span class="c1"># Returns the start of the week shifted back by n_weeks weeks (default is 1 week)</span>
</span><span id="MarkovChain-156"><a href="#MarkovChain-156"><span class="linenos">156</span></a>            <span class="k">return</span> <span class="n">date_midnight</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">date_midnight</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">weeks_back</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="MarkovChain-157"><a href="#MarkovChain-157"><span class="linenos">157</span></a>
</span><span id="MarkovChain-158"><a href="#MarkovChain-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
</span><span id="MarkovChain-159"><a href="#MarkovChain-159"><span class="linenos">159</span></a>            <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">hour</span>
</span><span id="MarkovChain-160"><a href="#MarkovChain-160"><span class="linenos">160</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">168</span><span class="p">:</span>
</span><span id="MarkovChain-161"><a href="#MarkovChain-161"><span class="linenos">161</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">start_of_week</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="MarkovChain-162"><a href="#MarkovChain-162"><span class="linenos">162</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">336</span><span class="p">:</span>
</span><span id="MarkovChain-163"><a href="#MarkovChain-163"><span class="linenos">163</span></a>            <span class="n">is_even_week</span> <span class="o">=</span> <span class="n">date_midnight</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MarkovChain-164"><a href="#MarkovChain-164"><span class="linenos">164</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">start_of_week</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_even_week</span> <span class="k">else</span> <span class="n">start_of_week</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="MarkovChain-165"><a href="#MarkovChain-165"><span class="linenos">165</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="MarkovChain-166"><a href="#MarkovChain-166"><span class="linenos">166</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-167"><a href="#MarkovChain-167"><span class="linenos">167</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported chain_length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MarkovChain-168"><a href="#MarkovChain-168"><span class="linenos">168</span></a>
</span><span id="MarkovChain-169"><a href="#MarkovChain-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_individual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
</span><span id="MarkovChain-170"><a href="#MarkovChain-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-171"><a href="#MarkovChain-171"><span class="linenos">171</span></a><span class="sd">        Process an individual&#39;s trajectory data to create a series of abstract locations per time slot.</span>
</span><span id="MarkovChain-172"><a href="#MarkovChain-172"><span class="linenos">172</span></a><span class="sd">        This method groups the user&#39;s trajectory data by time slots, computes location statistics, and fills in</span>
</span><span id="MarkovChain-173"><a href="#MarkovChain-173"><span class="linenos">173</span></a><span class="sd">        missing values by forward and backward filling. The resulting series maps each time slot to an abstract</span>
</span><span id="MarkovChain-174"><a href="#MarkovChain-174"><span class="linenos">174</span></a><span class="sd">        location rank.</span>
</span><span id="MarkovChain-175"><a href="#MarkovChain-175"><span class="linenos">175</span></a>
</span><span id="MarkovChain-176"><a href="#MarkovChain-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-177"><a href="#MarkovChain-177"><span class="linenos">177</span></a><span class="sd">            user_data (TrajectoriesFrame): The trajectory data for a single user.</span>
</span><span id="MarkovChain-178"><a href="#MarkovChain-178"><span class="linenos">178</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-179"><a href="#MarkovChain-179"><span class="linenos">179</span></a><span class="sd">            pd.Series: A series indexed by time slots with abstract location ranks.</span>
</span><span id="MarkovChain-180"><a href="#MarkovChain-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-181"><a href="#MarkovChain-181"><span class="linenos">181</span></a>        <span class="n">grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by_time_slot</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="MarkovChain-182"><a href="#MarkovChain-182"><span class="linenos">182</span></a>        <span class="n">freq_map</span><span class="p">,</span> <span class="n">rank_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_location_stats</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>
</span><span id="MarkovChain-183"><a href="#MarkovChain-183"><span class="linenos">183</span></a>        <span class="n">abstract_series</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_most_frequent_location</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq_map</span><span class="p">))</span>
</span><span id="MarkovChain-184"><a href="#MarkovChain-184"><span class="linenos">184</span></a>        <span class="n">abstract_series</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MarkovChain-185"><a href="#MarkovChain-185"><span class="linenos">185</span></a>        <span class="n">abstract_series</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MarkovChain-186"><a href="#MarkovChain-186"><span class="linenos">186</span></a>        <span class="n">abstract_series</span> <span class="o">=</span> <span class="n">abstract_series</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rank_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
</span><span id="MarkovChain-187"><a href="#MarkovChain-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="n">abstract_series</span>
</span><span id="MarkovChain-188"><a href="#MarkovChain-188"><span class="linenos">188</span></a>
</span><span id="MarkovChain-189"><a href="#MarkovChain-189"><span class="linenos">189</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain-190"><a href="#MarkovChain-190"><span class="linenos">190</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="MarkovChain-191"><a href="#MarkovChain-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-192"><a href="#MarkovChain-192"><span class="linenos">192</span></a><span class="sd">        Compute the duration (tau) of consecutive occurrences of target_loc in the series starting from start_idx.</span>
</span><span id="MarkovChain-193"><a href="#MarkovChain-193"><span class="linenos">193</span></a><span class="sd">        Returns the count of consecutive occurrences and the index where the sequence ends.</span>
</span><span id="MarkovChain-194"><a href="#MarkovChain-194"><span class="linenos">194</span></a>
</span><span id="MarkovChain-195"><a href="#MarkovChain-195"><span class="linenos">195</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-196"><a href="#MarkovChain-196"><span class="linenos">196</span></a><span class="sd">            series (pd.Series): The series to analyze.</span>
</span><span id="MarkovChain-197"><a href="#MarkovChain-197"><span class="linenos">197</span></a><span class="sd">            start_idx (int): The starting index to check for consecutive occurrences.</span>
</span><span id="MarkovChain-198"><a href="#MarkovChain-198"><span class="linenos">198</span></a><span class="sd">            target_loc (int): The location label to count consecutively.</span>
</span><span id="MarkovChain-199"><a href="#MarkovChain-199"><span class="linenos">199</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-200"><a href="#MarkovChain-200"><span class="linenos">200</span></a><span class="sd">            Tuple[int, int]: A tuple containing the count of consecutive occurrences (tau) and the index where the sequence ends.</span>
</span><span id="MarkovChain-201"><a href="#MarkovChain-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-202"><a href="#MarkovChain-202"><span class="linenos">202</span></a>
</span><span id="MarkovChain-203"><a href="#MarkovChain-203"><span class="linenos">203</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</span><span id="MarkovChain-204"><a href="#MarkovChain-204"><span class="linenos">204</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># start with 1 to count the current location</span>
</span><span id="MarkovChain-205"><a href="#MarkovChain-205"><span class="linenos">205</span></a>        <span class="n">j</span> <span class="o">=</span> <span class="n">start_idx</span>
</span><span id="MarkovChain-206"><a href="#MarkovChain-206"><span class="linenos">206</span></a>        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_loc</span><span class="p">:</span>
</span><span id="MarkovChain-207"><a href="#MarkovChain-207"><span class="linenos">207</span></a>            <span class="n">tau</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-208"><a href="#MarkovChain-208"><span class="linenos">208</span></a>            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-209"><a href="#MarkovChain-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="n">tau</span><span class="p">,</span> <span class="n">j</span>
</span><span id="MarkovChain-210"><a href="#MarkovChain-210"><span class="linenos">210</span></a>
</span><span id="MarkovChain-211"><a href="#MarkovChain-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_home_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain-212"><a href="#MarkovChain-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-213"><a href="#MarkovChain-213"><span class="linenos">213</span></a><span class="sd">        Handle transitions when the current location is &#39;home&#39; (1). Updates the Markov chain based on the next location.</span>
</span><span id="MarkovChain-214"><a href="#MarkovChain-214"><span class="linenos">214</span></a>
</span><span id="MarkovChain-215"><a href="#MarkovChain-215"><span class="linenos">215</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-216"><a href="#MarkovChain-216"><span class="linenos">216</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="MarkovChain-217"><a href="#MarkovChain-217"><span class="linenos">217</span></a><span class="sd">            slot (int): The current index in the series.</span>
</span><span id="MarkovChain-218"><a href="#MarkovChain-218"><span class="linenos">218</span></a><span class="sd">            h (int): The current hour in the Markov chain.</span>
</span><span id="MarkovChain-219"><a href="#MarkovChain-219"><span class="linenos">219</span></a><span class="sd">            next_h (int): The next hour in the Markov chain.</span>
</span><span id="MarkovChain-220"><a href="#MarkovChain-220"><span class="linenos">220</span></a><span class="sd">            next_loc (int): The next location label.</span>
</span><span id="MarkovChain-221"><a href="#MarkovChain-221"><span class="linenos">221</span></a><span class="sd">            n (int): The total length of the series.</span>
</span><span id="MarkovChain-222"><a href="#MarkovChain-222"><span class="linenos">222</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-223"><a href="#MarkovChain-223"><span class="linenos">223</span></a><span class="sd">            int: The updated index in the series after handling the transition.</span>
</span><span id="MarkovChain-224"><a href="#MarkovChain-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-225"><a href="#MarkovChain-225"><span class="linenos">225</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain-226"><a href="#MarkovChain-226"><span class="linenos">226</span></a>        <span class="k">if</span> <span class="n">next_loc</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="MarkovChain-227"><a href="#MarkovChain-227"><span class="linenos">227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">home</span><span class="p">)][(</span><span class="n">next_h</span><span class="p">,</span> <span class="n">home</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-228"><a href="#MarkovChain-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-229"><a href="#MarkovChain-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span><span id="MarkovChain-230"><a href="#MarkovChain-230"><span class="linenos">230</span></a>                <span class="n">tau</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">)</span>
</span><span id="MarkovChain-231"><a href="#MarkovChain-231"><span class="linenos">231</span></a>                <span class="n">h_tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-232"><a href="#MarkovChain-232"><span class="linenos">232</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">home</span><span class="p">)][(</span><span class="n">h_tau</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-233"><a href="#MarkovChain-233"><span class="linenos">233</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="MarkovChain-234"><a href="#MarkovChain-234"><span class="linenos">234</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-235"><a href="#MarkovChain-235"><span class="linenos">235</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="MarkovChain-236"><a href="#MarkovChain-236"><span class="linenos">236</span></a>
</span><span id="MarkovChain-237"><a href="#MarkovChain-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">slot</span>
</span><span id="MarkovChain-238"><a href="#MarkovChain-238"><span class="linenos">238</span></a>
</span><span id="MarkovChain-239"><a href="#MarkovChain-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_non_home_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MarkovChain-240"><a href="#MarkovChain-240"><span class="linenos">240</span></a>                                    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain-241"><a href="#MarkovChain-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-242"><a href="#MarkovChain-242"><span class="linenos">242</span></a><span class="sd">        Handle transitions when the current location is &#39;non-typical&#39; (not home). Updates the Markov chain based on the</span>
</span><span id="MarkovChain-243"><a href="#MarkovChain-243"><span class="linenos">243</span></a><span class="sd">        next location.</span>
</span><span id="MarkovChain-244"><a href="#MarkovChain-244"><span class="linenos">244</span></a>
</span><span id="MarkovChain-245"><a href="#MarkovChain-245"><span class="linenos">245</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-246"><a href="#MarkovChain-246"><span class="linenos">246</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="MarkovChain-247"><a href="#MarkovChain-247"><span class="linenos">247</span></a><span class="sd">            slot (int): The current index in the series.</span>
</span><span id="MarkovChain-248"><a href="#MarkovChain-248"><span class="linenos">248</span></a><span class="sd">            h (int): The current hour in the Markov chain.</span>
</span><span id="MarkovChain-249"><a href="#MarkovChain-249"><span class="linenos">249</span></a><span class="sd">            next_h (int): The next hour in the Markov chain.</span>
</span><span id="MarkovChain-250"><a href="#MarkovChain-250"><span class="linenos">250</span></a><span class="sd">            next_loc (int): The next location label.</span>
</span><span id="MarkovChain-251"><a href="#MarkovChain-251"><span class="linenos">251</span></a><span class="sd">            n (int): The total length of the series.</span>
</span><span id="MarkovChain-252"><a href="#MarkovChain-252"><span class="linenos">252</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-253"><a href="#MarkovChain-253"><span class="linenos">253</span></a><span class="sd">            int: The updated index in the series after handling the transition.</span>
</span><span id="MarkovChain-254"><a href="#MarkovChain-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-255"><a href="#MarkovChain-255"><span class="linenos">255</span></a>
</span><span id="MarkovChain-256"><a href="#MarkovChain-256"><span class="linenos">256</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain-257"><a href="#MarkovChain-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="n">next_loc</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="MarkovChain-258"><a href="#MarkovChain-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)][(</span><span class="n">next_h</span><span class="p">,</span> <span class="n">home</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-259"><a href="#MarkovChain-259"><span class="linenos">259</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-260"><a href="#MarkovChain-260"><span class="linenos">260</span></a>            <span class="k">if</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span><span id="MarkovChain-261"><a href="#MarkovChain-261"><span class="linenos">261</span></a>                <span class="n">tau</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">)</span>
</span><span id="MarkovChain-262"><a href="#MarkovChain-262"><span class="linenos">262</span></a>                <span class="n">h_tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-263"><a href="#MarkovChain-263"><span class="linenos">263</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)][(</span><span class="n">h_tau</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-264"><a href="#MarkovChain-264"><span class="linenos">264</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="MarkovChain-265"><a href="#MarkovChain-265"><span class="linenos">265</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-266"><a href="#MarkovChain-266"><span class="linenos">266</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="MarkovChain-267"><a href="#MarkovChain-267"><span class="linenos">267</span></a>        <span class="k">return</span> <span class="n">slot</span>
</span><span id="MarkovChain-268"><a href="#MarkovChain-268"><span class="linenos">268</span></a>
</span><span id="MarkovChain-269"><a href="#MarkovChain-269"><span class="linenos">269</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain-270"><a href="#MarkovChain-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-271"><a href="#MarkovChain-271"><span class="linenos">271</span></a><span class="sd">        Update the Markov chain with transitions from the given series of abstract locations, applying a time shift.</span>
</span><span id="MarkovChain-272"><a href="#MarkovChain-272"><span class="linenos">272</span></a><span class="sd">        The method iterates through the series, handling transitions based on whether the current location is &#39;home&#39; or</span>
</span><span id="MarkovChain-273"><a href="#MarkovChain-273"><span class="linenos">273</span></a><span class="sd">        &#39;non-typical&#39;, and updates the transition counts in the Markov chain accordingly.</span>
</span><span id="MarkovChain-274"><a href="#MarkovChain-274"><span class="linenos">274</span></a>
</span><span id="MarkovChain-275"><a href="#MarkovChain-275"><span class="linenos">275</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-276"><a href="#MarkovChain-276"><span class="linenos">276</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="MarkovChain-277"><a href="#MarkovChain-277"><span class="linenos">277</span></a><span class="sd">            shift (int): The time shift to apply to the series.</span>
</span><span id="MarkovChain-278"><a href="#MarkovChain-278"><span class="linenos">278</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-279"><a href="#MarkovChain-279"><span class="linenos">279</span></a><span class="sd">            None</span>
</span><span id="MarkovChain-280"><a href="#MarkovChain-280"><span class="linenos">280</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-281"><a href="#MarkovChain-281"><span class="linenos">281</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain-282"><a href="#MarkovChain-282"><span class="linenos">282</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</span><span id="MarkovChain-283"><a href="#MarkovChain-283"><span class="linenos">283</span></a>        <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MarkovChain-284"><a href="#MarkovChain-284"><span class="linenos">284</span></a>        <span class="k">while</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain-285"><a href="#MarkovChain-285"><span class="linenos">285</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-286"><a href="#MarkovChain-286"><span class="linenos">286</span></a>            <span class="n">next_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-287"><a href="#MarkovChain-287"><span class="linenos">287</span></a>            <span class="n">current</span><span class="p">,</span> <span class="n">next_loc</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MarkovChain-288"><a href="#MarkovChain-288"><span class="linenos">288</span></a>            <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="MarkovChain-289"><a href="#MarkovChain-289"><span class="linenos">289</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_home_transition</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">next_h</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="MarkovChain-290"><a href="#MarkovChain-290"><span class="linenos">290</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-291"><a href="#MarkovChain-291"><span class="linenos">291</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_non_home_transition</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">next_h</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="MarkovChain-292"><a href="#MarkovChain-292"><span class="linenos">292</span></a>            <span class="n">slot</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-293"><a href="#MarkovChain-293"><span class="linenos">293</span></a>
</span><span id="MarkovChain-294"><a href="#MarkovChain-294"><span class="linenos">294</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain-295"><a href="#MarkovChain-295"><span class="linenos">295</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-296"><a href="#MarkovChain-296"><span class="linenos">296</span></a><span class="sd">        Normalize the transition counts in the Markov chain to probabilities.</span>
</span><span id="MarkovChain-297"><a href="#MarkovChain-297"><span class="linenos">297</span></a><span class="sd">        This method iterates through each origin state in the Markov chain and normalizes the transition counts to</span>
</span><span id="MarkovChain-298"><a href="#MarkovChain-298"><span class="linenos">298</span></a><span class="sd">        probabilities by dividing each count by the total count of transitions from that state. If a state has no</span>
</span><span id="MarkovChain-299"><a href="#MarkovChain-299"><span class="linenos">299</span></a><span class="sd">        outgoing transitions, its probabilities remain zero.</span>
</span><span id="MarkovChain-300"><a href="#MarkovChain-300"><span class="linenos">300</span></a>
</span><span id="MarkovChain-301"><a href="#MarkovChain-301"><span class="linenos">301</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-302"><a href="#MarkovChain-302"><span class="linenos">302</span></a><span class="sd">            None</span>
</span><span id="MarkovChain-303"><a href="#MarkovChain-303"><span class="linenos">303</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-304"><a href="#MarkovChain-304"><span class="linenos">304</span></a>        <span class="k">for</span> <span class="n">origin</span><span class="p">,</span> <span class="n">transitions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MarkovChain-305"><a href="#MarkovChain-305"><span class="linenos">305</span></a>            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="MarkovChain-306"><a href="#MarkovChain-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MarkovChain-307"><a href="#MarkovChain-307"><span class="linenos">307</span></a>                <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
</span><span id="MarkovChain-308"><a href="#MarkovChain-308"><span class="linenos">308</span></a>                    <span class="n">transitions</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
</span><span id="MarkovChain-309"><a href="#MarkovChain-309"><span class="linenos">309</span></a>
</span><span id="MarkovChain-310"><a href="#MarkovChain-310"><span class="linenos">310</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain-311"><a href="#MarkovChain-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-312"><a href="#MarkovChain-312"><span class="linenos">312</span></a><span class="sd">        Fit the Markov chain model to the provided trajectory data.</span>
</span><span id="MarkovChain-313"><a href="#MarkovChain-313"><span class="linenos">313</span></a><span class="sd">        The method initializes an empty Markov chain, processes each user&#39;s trajectory data to extract abstract location</span>
</span><span id="MarkovChain-314"><a href="#MarkovChain-314"><span class="linenos">314</span></a><span class="sd">        series, applies the appropriate time shift, updates the Markov chain with transitions, and finally normalizes</span>
</span><span id="MarkovChain-315"><a href="#MarkovChain-315"><span class="linenos">315</span></a><span class="sd">        the transition counts to probabilities.</span>
</span><span id="MarkovChain-316"><a href="#MarkovChain-316"><span class="linenos">316</span></a>
</span><span id="MarkovChain-317"><a href="#MarkovChain-317"><span class="linenos">317</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-318"><a href="#MarkovChain-318"><span class="linenos">318</span></a><span class="sd">            trajectory (TrajectoriesFrame): The trajectory data to fit the model to.</span>
</span><span id="MarkovChain-319"><a href="#MarkovChain-319"><span class="linenos">319</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-320"><a href="#MarkovChain-320"><span class="linenos">320</span></a><span class="sd">            None</span>
</span><span id="MarkovChain-321"><a href="#MarkovChain-321"><span class="linenos">321</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-322"><a href="#MarkovChain-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_empty_chain</span><span class="p">()</span>
</span><span id="MarkovChain-323"><a href="#MarkovChain-323"><span class="linenos">323</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="MarkovChain-324"><a href="#MarkovChain-324"><span class="linenos">324</span></a>
</span><span id="MarkovChain-325"><a href="#MarkovChain-325"><span class="linenos">325</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting Markov Chain&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="MarkovChain-326"><a href="#MarkovChain-326"><span class="linenos">326</span></a>            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="MarkovChain-327"><a href="#MarkovChain-327"><span class="linenos">327</span></a>                <span class="n">user_data</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">uloc</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="MarkovChain-328"><a href="#MarkovChain-328"><span class="linenos">328</span></a>                <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_individual</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="MarkovChain-329"><a href="#MarkovChain-329"><span class="linenos">329</span></a>                <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_shift</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="MarkovChain-330"><a href="#MarkovChain-330"><span class="linenos">330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_chain</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>
</span><span id="MarkovChain-331"><a href="#MarkovChain-331"><span class="linenos">331</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain-332"><a href="#MarkovChain-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_chain</span><span class="p">()</span>
</span><span id="MarkovChain-333"><a href="#MarkovChain-333"><span class="linenos">333</span></a>
</span><span id="MarkovChain-334"><a href="#MarkovChain-334"><span class="linenos">334</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain-335"><a href="#MarkovChain-335"><span class="linenos">335</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_choose_weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain-336"><a href="#MarkovChain-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-337"><a href="#MarkovChain-337"><span class="linenos">337</span></a><span class="sd">        Choose an index based on the provided weights using a weighted random selection. The method computes</span>
</span><span id="MarkovChain-338"><a href="#MarkovChain-338"><span class="linenos">338</span></a><span class="sd">        the cumulative sum of the weights and selects an index where a random number falls within the cumulative</span>
</span><span id="MarkovChain-339"><a href="#MarkovChain-339"><span class="linenos">339</span></a><span class="sd">        distribution.</span>
</span><span id="MarkovChain-340"><a href="#MarkovChain-340"><span class="linenos">340</span></a>
</span><span id="MarkovChain-341"><a href="#MarkovChain-341"><span class="linenos">341</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-342"><a href="#MarkovChain-342"><span class="linenos">342</span></a><span class="sd">            weights (list[float]): A list of weights for each index.</span>
</span><span id="MarkovChain-343"><a href="#MarkovChain-343"><span class="linenos">343</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-344"><a href="#MarkovChain-344"><span class="linenos">344</span></a><span class="sd">            int: The selected index based on the weights.</span>
</span><span id="MarkovChain-345"><a href="#MarkovChain-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-346"><a href="#MarkovChain-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()))</span>
</span><span id="MarkovChain-347"><a href="#MarkovChain-347"><span class="linenos">347</span></a>
</span><span id="MarkovChain-348"><a href="#MarkovChain-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="MarkovChain-349"><a href="#MarkovChain-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-350"><a href="#MarkovChain-350"><span class="linenos">350</span></a><span class="sd">        Generate a synthetic trajectory for a specified duration starting from a given date using the fitted</span>
</span><span id="MarkovChain-351"><a href="#MarkovChain-351"><span class="linenos">351</span></a><span class="sd">        Markov chain. The method simulates the trajectory by transitioning through states in the Markov chain based</span>
</span><span id="MarkovChain-352"><a href="#MarkovChain-352"><span class="linenos">352</span></a><span class="sd">        on the learned transition probabilities. The generated trajectory is returned as a DataFrame with timestamps</span>
</span><span id="MarkovChain-353"><a href="#MarkovChain-353"><span class="linenos">353</span></a><span class="sd">        and abstract location labels.</span>
</span><span id="MarkovChain-354"><a href="#MarkovChain-354"><span class="linenos">354</span></a>
</span><span id="MarkovChain-355"><a href="#MarkovChain-355"><span class="linenos">355</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-356"><a href="#MarkovChain-356"><span class="linenos">356</span></a><span class="sd">            duration_hours (int): The total duration of the generated trajectory in hours.</span>
</span><span id="MarkovChain-357"><a href="#MarkovChain-357"><span class="linenos">357</span></a><span class="sd">            start_date (pd.Timestamp): The starting date and time for the generated trajectory.</span>
</span><span id="MarkovChain-358"><a href="#MarkovChain-358"><span class="linenos">358</span></a><span class="sd">            seed (Optional[int]): An optional random seed for reproducibility.</span>
</span><span id="MarkovChain-359"><a href="#MarkovChain-359"><span class="linenos">359</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-360"><a href="#MarkovChain-360"><span class="linenos">360</span></a><span class="sd">            pd.DataFrame: A DataFrame containing the generated trajectory with columns &#39;datetime&#39; and &#39;abstract_location&#39;.</span>
</span><span id="MarkovChain-361"><a href="#MarkovChain-361"><span class="linenos">361</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-362"><a href="#MarkovChain-362"><span class="linenos">362</span></a>        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain-363"><a href="#MarkovChain-363"><span class="linenos">363</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="MarkovChain-364"><a href="#MarkovChain-364"><span class="linenos">364</span></a>
</span><span id="MarkovChain-365"><a href="#MarkovChain-365"><span class="linenos">365</span></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MarkovChain-366"><a href="#MarkovChain-366"><span class="linenos">366</span></a>        <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_shift</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
</span><span id="MarkovChain-367"><a href="#MarkovChain-367"><span class="linenos">367</span></a>        <span class="n">prev_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain-368"><a href="#MarkovChain-368"><span class="linenos">368</span></a>        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_state</span><span class="p">)</span>
</span><span id="MarkovChain-369"><a href="#MarkovChain-369"><span class="linenos">369</span></a>
</span><span id="MarkovChain-370"><a href="#MarkovChain-370"><span class="linenos">370</span></a>        <span class="n">step</span><span class="p">,</span> <span class="n">hours_generated</span> <span class="o">=</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain-371"><a href="#MarkovChain-371"><span class="linenos">371</span></a>
</span><span id="MarkovChain-372"><a href="#MarkovChain-372"><span class="linenos">372</span></a>        <span class="k">while</span> <span class="n">hours_generated</span> <span class="o">&lt;</span> <span class="n">duration_hours</span><span class="p">:</span>
</span><span id="MarkovChain-373"><a href="#MarkovChain-373"><span class="linenos">373</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-374"><a href="#MarkovChain-374"><span class="linenos">374</span></a>            <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">prev_state</span><span class="p">]</span>
</span><span id="MarkovChain-375"><a href="#MarkovChain-375"><span class="linenos">375</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="MarkovChain-376"><a href="#MarkovChain-376"><span class="linenos">376</span></a>
</span><span id="MarkovChain-377"><a href="#MarkovChain-377"><span class="linenos">377</span></a>            <span class="n">next_state</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MarkovChain-378"><a href="#MarkovChain-378"><span class="linenos">378</span></a>                <span class="p">((</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MarkovChain-379"><a href="#MarkovChain-379"><span class="linenos">379</span></a>                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span>
</span><span id="MarkovChain-380"><a href="#MarkovChain-380"><span class="linenos">380</span></a>                <span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="bp">self</span><span class="o">.</span><span class="n">_choose_weighted</span><span class="p">(</span><span class="n">probs</span><span class="p">)]</span>
</span><span id="MarkovChain-381"><a href="#MarkovChain-381"><span class="linenos">381</span></a>            <span class="p">)</span>
</span><span id="MarkovChain-382"><a href="#MarkovChain-382"><span class="linenos">382</span></a>
</span><span id="MarkovChain-383"><a href="#MarkovChain-383"><span class="linenos">383</span></a>            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
</span><span id="MarkovChain-384"><a href="#MarkovChain-384"><span class="linenos">384</span></a>            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-385"><a href="#MarkovChain-385"><span class="linenos">385</span></a>            <span class="n">step</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="MarkovChain-386"><a href="#MarkovChain-386"><span class="linenos">386</span></a>            <span class="n">hours_generated</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="MarkovChain-387"><a href="#MarkovChain-387"><span class="linenos">387</span></a>            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">next_state</span>
</span><span id="MarkovChain-388"><a href="#MarkovChain-388"><span class="linenos">388</span></a>
</span><span id="MarkovChain-389"><a href="#MarkovChain-389"><span class="linenos">389</span></a>        <span class="n">diary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states_to_diary</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">,</span> <span class="n">start_date</span><span class="p">)</span>
</span><span id="MarkovChain-390"><a href="#MarkovChain-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">diary</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract_location&#39;</span><span class="p">])</span>
</span><span id="MarkovChain-391"><a href="#MarkovChain-391"><span class="linenos">391</span></a>
</span><span id="MarkovChain-392"><a href="#MarkovChain-392"><span class="linenos">392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_states_to_diary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="MarkovChain-393"><a href="#MarkovChain-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain-394"><a href="#MarkovChain-394"><span class="linenos">394</span></a><span class="sd">        Convert a list of states into a diary format with timestamps and location labels.</span>
</span><span id="MarkovChain-395"><a href="#MarkovChain-395"><span class="linenos">395</span></a><span class="sd">        This method processes the list of states generated by the Markov chain to create a diary that records the</span>
</span><span id="MarkovChain-396"><a href="#MarkovChain-396"><span class="linenos">396</span></a><span class="sd">        timestamp and corresponding location label for each hour. Consecutive entries with the same location are</span>
</span><span id="MarkovChain-397"><a href="#MarkovChain-397"><span class="linenos">397</span></a><span class="sd">        merged to simplify the diary.</span>
</span><span id="MarkovChain-398"><a href="#MarkovChain-398"><span class="linenos">398</span></a>
</span><span id="MarkovChain-399"><a href="#MarkovChain-399"><span class="linenos">399</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain-400"><a href="#MarkovChain-400"><span class="linenos">400</span></a><span class="sd">            states (list[tuple]): A list of states represented as tuples (hour, location).</span>
</span><span id="MarkovChain-401"><a href="#MarkovChain-401"><span class="linenos">401</span></a><span class="sd">            max_length (int): The maximum length of the diary in hours.</span>
</span><span id="MarkovChain-402"><a href="#MarkovChain-402"><span class="linenos">402</span></a><span class="sd">            start_time (pd.Timestamp): The starting timestamp for the diary.</span>
</span><span id="MarkovChain-403"><a href="#MarkovChain-403"><span class="linenos">403</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain-404"><a href="#MarkovChain-404"><span class="linenos">404</span></a><span class="sd">            List[Tuple[pd.Timestamp, int]]: A list of tuples containing timestamps and location labels.</span>
</span><span id="MarkovChain-405"><a href="#MarkovChain-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain-406"><a href="#MarkovChain-406"><span class="linenos">406</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_time</span>
</span><span id="MarkovChain-407"><a href="#MarkovChain-407"><span class="linenos">407</span></a>        <span class="n">prev_state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MarkovChain-408"><a href="#MarkovChain-408"><span class="linenos">408</span></a>        <span class="n">location_counter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MarkovChain-409"><a href="#MarkovChain-409"><span class="linenos">409</span></a>        <span class="n">log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">current_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="MarkovChain-410"><a href="#MarkovChain-410"><span class="linenos">410</span></a>
</span><span id="MarkovChain-411"><a href="#MarkovChain-411"><span class="linenos">411</span></a>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="MarkovChain-412"><a href="#MarkovChain-412"><span class="linenos">412</span></a>            <span class="n">h</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="MarkovChain-413"><a href="#MarkovChain-413"><span class="linenos">413</span></a>            <span class="n">h_prev</span><span class="p">,</span> <span class="n">loc_prev</span> <span class="o">=</span> <span class="n">prev_state</span>
</span><span id="MarkovChain-414"><a href="#MarkovChain-414"><span class="linenos">414</span></a>
</span><span id="MarkovChain-415"><a href="#MarkovChain-415"><span class="linenos">415</span></a>            <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain-416"><a href="#MarkovChain-416"><span class="linenos">416</span></a>                <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain-417"><a href="#MarkovChain-417"><span class="linenos">417</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="MarkovChain-418"><a href="#MarkovChain-418"><span class="linenos">418</span></a>                <span class="n">location_counter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MarkovChain-419"><a href="#MarkovChain-419"><span class="linenos">419</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain-420"><a href="#MarkovChain-420"><span class="linenos">420</span></a>                <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">h_prev</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain-421"><a href="#MarkovChain-421"><span class="linenos">421</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hours</span><span class="p">):</span>
</span><span id="MarkovChain-422"><a href="#MarkovChain-422"><span class="linenos">422</span></a>                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain-423"><a href="#MarkovChain-423"><span class="linenos">423</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_time</span><span class="p">,</span> <span class="n">location_counter</span><span class="p">))</span>
</span><span id="MarkovChain-424"><a href="#MarkovChain-424"><span class="linenos">424</span></a>                <span class="n">location_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain-425"><a href="#MarkovChain-425"><span class="linenos">425</span></a>
</span><span id="MarkovChain-426"><a href="#MarkovChain-426"><span class="linenos">426</span></a>            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="MarkovChain-427"><a href="#MarkovChain-427"><span class="linenos">427</span></a>
</span><span id="MarkovChain-428"><a href="#MarkovChain-428"><span class="linenos">428</span></a>        <span class="c1"># Simplify log by merging consecutive entries with same location</span>
</span><span id="MarkovChain-429"><a href="#MarkovChain-429"><span class="linenos">429</span></a>        <span class="n">simplified</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MarkovChain-430"><a href="#MarkovChain-430"><span class="linenos">430</span></a>        <span class="n">last_location</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="MarkovChain-431"><a href="#MarkovChain-431"><span class="linenos">431</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">log</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]:</span>
</span><span id="MarkovChain-432"><a href="#MarkovChain-432"><span class="linenos">432</span></a>            <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">last_location</span><span class="p">:</span>
</span><span id="MarkovChain-433"><a href="#MarkovChain-433"><span class="linenos">433</span></a>                <span class="n">simplified</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
</span><span id="MarkovChain-434"><a href="#MarkovChain-434"><span class="linenos">434</span></a>                <span class="n">last_location</span> <span class="o">=</span> <span class="n">loc</span>
</span><span id="MarkovChain-435"><a href="#MarkovChain-435"><span class="linenos">435</span></a>
</span><span id="MarkovChain-436"><a href="#MarkovChain-436"><span class="linenos">436</span></a>        <span class="k">return</span> <span class="n">simplified</span>
</span><span id="MarkovChain-437"><a href="#MarkovChain-437"><span class="linenos">437</span></a>
</span><span id="MarkovChain-438"><a href="#MarkovChain-438"><span class="linenos">438</span></a>    <span class="n">initialize_empty_chain</span> <span class="o">=</span> <span class="n">_initialize_empty_chain</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-439"><a href="#MarkovChain-439"><span class="linenos">439</span></a>    <span class="n">group_by_time_slot</span> <span class="o">=</span> <span class="n">_group_by_time_slot</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-440"><a href="#MarkovChain-440"><span class="linenos">440</span></a>    <span class="n">compute_location_stats</span> <span class="o">=</span> <span class="n">_compute_location_stats</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-441"><a href="#MarkovChain-441"><span class="linenos">441</span></a>    <span class="n">most_frequent_location</span> <span class="o">=</span> <span class="n">_most_frequent_location</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-442"><a href="#MarkovChain-442"><span class="linenos">442</span></a>    <span class="n">get_time_shift</span> <span class="o">=</span> <span class="n">_get_time_shift</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-443"><a href="#MarkovChain-443"><span class="linenos">443</span></a>    <span class="n">process_individual</span> <span class="o">=</span> <span class="n">_process_individual</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-444"><a href="#MarkovChain-444"><span class="linenos">444</span></a>    <span class="n">compute_tau</span> <span class="o">=</span> <span class="n">_compute_tau</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-445"><a href="#MarkovChain-445"><span class="linenos">445</span></a>    <span class="n">handle_home_transition</span> <span class="o">=</span> <span class="n">_handle_home_transition</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-446"><a href="#MarkovChain-446"><span class="linenos">446</span></a>    <span class="n">handle_non_home_transition</span> <span class="o">=</span> <span class="n">_handle_non_home_transition</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-447"><a href="#MarkovChain-447"><span class="linenos">447</span></a>    <span class="n">update_chain</span> <span class="o">=</span> <span class="n">_update_chain</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-448"><a href="#MarkovChain-448"><span class="linenos">448</span></a>    <span class="n">normalize_chain</span> <span class="o">=</span> <span class="n">_normalize_chain</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-449"><a href="#MarkovChain-449"><span class="linenos">449</span></a>    <span class="n">choose_weighted</span> <span class="o">=</span> <span class="n">_choose_weighted</span>  <span class="c1"># Expose for docs</span>
</span><span id="MarkovChain-450"><a href="#MarkovChain-450"><span class="linenos">450</span></a>    <span class="n">states_to_diary</span> <span class="o">=</span> <span class="n">_states_to_diary</span>  <span class="c1"># Expose for docs</span>
</span></pre></div>


            <div class="docstring"><p>A Markov Chain model for simulating individual mobility patterns based on historical trajectory data.
The model uses a state space defined by time slots and abstract location types (home and non-typical locations).</p>
</div>


                            <div id="MarkovChain.__init__" class="classattr">
                                        <input id="MarkovChain.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MarkovChain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config</span><span class="p">:</span> <span class="n"><a href="#MarkovChainConfig">MarkovChainConfig</a></span></span>)</span>

                <label class="view-source-button" for="MarkovChain.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.__init__-53"><a href="#MarkovChain.__init__-53"><span class="linenos">53</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MarkovChainConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain.__init__-54"><a href="#MarkovChain.__init__-54"><span class="linenos">54</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.__init__-55"><a href="#MarkovChain.__init__-55"><span class="linenos">55</span></a><span class="sd">        Initialize the Markov Chain model with the given configuration.</span>
</span><span id="MarkovChain.__init__-56"><a href="#MarkovChain.__init__-56"><span class="linenos">56</span></a>
</span><span id="MarkovChain.__init__-57"><a href="#MarkovChain.__init__-57"><span class="linenos">57</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.__init__-58"><a href="#MarkovChain.__init__-58"><span class="linenos">58</span></a><span class="sd">            config (MarkovChainConfig): Configuration parameters for the Markov Chain model.</span>
</span><span id="MarkovChain.__init__-59"><a href="#MarkovChain.__init__-59"><span class="linenos">59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.__init__-60"><a href="#MarkovChain.__init__-60"><span class="linenos">60</span></a>
</span><span id="MarkovChain.__init__-61"><a href="#MarkovChain.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">name</span>
</span><span id="MarkovChain.__init__-62"><a href="#MarkovChain.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.__init__-63"><a href="#MarkovChain.__init__-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">time_slot</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">time_slot</span>
</span><span id="MarkovChain.__init__-64"><a href="#MarkovChain.__init__-64"><span class="linenos">64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_column</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">label_column</span>
</span><span id="MarkovChain.__init__-65"><a href="#MarkovChain.__init__-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span id="MarkovChain.__init__-66"><a href="#MarkovChain.__init__-66"><span class="linenos">66</span></a>            <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Markov Chain model with the given configuration.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>config (MarkovChainConfig):</strong>  Configuration parameters for the Markov Chain model.</li>
</ul>
</div>


                            </div>
                            <div id="MarkovChain.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#MarkovChain.name"></a>
    
    

                            </div>
                            <div id="MarkovChain.chain_length" class="classattr">
                                <div class="attr variable">
            <span class="name">chain_length</span>

        
    </div>
    <a class="headerlink" href="#MarkovChain.chain_length"></a>
    
    

                            </div>
                            <div id="MarkovChain.time_slot" class="classattr">
                                <div class="attr variable">
            <span class="name">time_slot</span>

        
    </div>
    <a class="headerlink" href="#MarkovChain.time_slot"></a>
    
    

                            </div>
                            <div id="MarkovChain.label_column" class="classattr">
                                <div class="attr variable">
            <span class="name">label_column</span>

        
    </div>
    <a class="headerlink" href="#MarkovChain.label_column"></a>
    
    

                            </div>
                            <div id="MarkovChain.chain" class="classattr">
                                <div class="attr variable">
            <span class="name">chain</span><span class="annotation">: collections.defaultdict[tuple[int, int], collections.defaultdict[tuple[int, int], float]]</span>

        
    </div>
    <a class="headerlink" href="#MarkovChain.chain"></a>
    
    

                            </div>
                            <div id="MarkovChain.fit" class="classattr">
                                        <input id="MarkovChain.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">trajectory</span><span class="p">:</span> <span class="n">humobi</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">TrajectoriesFrame</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.fit-310"><a href="#MarkovChain.fit-310"><span class="linenos">310</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain.fit-311"><a href="#MarkovChain.fit-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.fit-312"><a href="#MarkovChain.fit-312"><span class="linenos">312</span></a><span class="sd">        Fit the Markov chain model to the provided trajectory data.</span>
</span><span id="MarkovChain.fit-313"><a href="#MarkovChain.fit-313"><span class="linenos">313</span></a><span class="sd">        The method initializes an empty Markov chain, processes each user&#39;s trajectory data to extract abstract location</span>
</span><span id="MarkovChain.fit-314"><a href="#MarkovChain.fit-314"><span class="linenos">314</span></a><span class="sd">        series, applies the appropriate time shift, updates the Markov chain with transitions, and finally normalizes</span>
</span><span id="MarkovChain.fit-315"><a href="#MarkovChain.fit-315"><span class="linenos">315</span></a><span class="sd">        the transition counts to probabilities.</span>
</span><span id="MarkovChain.fit-316"><a href="#MarkovChain.fit-316"><span class="linenos">316</span></a>
</span><span id="MarkovChain.fit-317"><a href="#MarkovChain.fit-317"><span class="linenos">317</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.fit-318"><a href="#MarkovChain.fit-318"><span class="linenos">318</span></a><span class="sd">            trajectory (TrajectoriesFrame): The trajectory data to fit the model to.</span>
</span><span id="MarkovChain.fit-319"><a href="#MarkovChain.fit-319"><span class="linenos">319</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.fit-320"><a href="#MarkovChain.fit-320"><span class="linenos">320</span></a><span class="sd">            None</span>
</span><span id="MarkovChain.fit-321"><a href="#MarkovChain.fit-321"><span class="linenos">321</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.fit-322"><a href="#MarkovChain.fit-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_empty_chain</span><span class="p">()</span>
</span><span id="MarkovChain.fit-323"><a href="#MarkovChain.fit-323"><span class="linenos">323</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="MarkovChain.fit-324"><a href="#MarkovChain.fit-324"><span class="linenos">324</span></a>
</span><span id="MarkovChain.fit-325"><a href="#MarkovChain.fit-325"><span class="linenos">325</span></a>        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Fitting Markov Chain&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
</span><span id="MarkovChain.fit-326"><a href="#MarkovChain.fit-326"><span class="linenos">326</span></a>            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span><span id="MarkovChain.fit-327"><a href="#MarkovChain.fit-327"><span class="linenos">327</span></a>                <span class="n">user_data</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">uloc</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span id="MarkovChain.fit-328"><a href="#MarkovChain.fit-328"><span class="linenos">328</span></a>                <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_individual</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="MarkovChain.fit-329"><a href="#MarkovChain.fit-329"><span class="linenos">329</span></a>                <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_shift</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span id="MarkovChain.fit-330"><a href="#MarkovChain.fit-330"><span class="linenos">330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_chain</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>
</span><span id="MarkovChain.fit-331"><a href="#MarkovChain.fit-331"><span class="linenos">331</span></a>                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain.fit-332"><a href="#MarkovChain.fit-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_chain</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Fit the Markov chain model to the provided trajectory data.
The method initializes an empty Markov chain, processes each user's trajectory data to extract abstract location
series, applies the appropriate time shift, updates the Markov chain with transitions, and finally normalizes
the transition counts to probabilities.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>trajectory (TrajectoriesFrame):</strong>  The trajectory data to fit the model to.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.generate" class="classattr">
                                        <input id="MarkovChain.generate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">duration_hours</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">start_date</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span>,</span><span class="param">	<span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.generate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.generate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.generate-348"><a href="#MarkovChain.generate-348"><span class="linenos">348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="MarkovChain.generate-349"><a href="#MarkovChain.generate-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.generate-350"><a href="#MarkovChain.generate-350"><span class="linenos">350</span></a><span class="sd">        Generate a synthetic trajectory for a specified duration starting from a given date using the fitted</span>
</span><span id="MarkovChain.generate-351"><a href="#MarkovChain.generate-351"><span class="linenos">351</span></a><span class="sd">        Markov chain. The method simulates the trajectory by transitioning through states in the Markov chain based</span>
</span><span id="MarkovChain.generate-352"><a href="#MarkovChain.generate-352"><span class="linenos">352</span></a><span class="sd">        on the learned transition probabilities. The generated trajectory is returned as a DataFrame with timestamps</span>
</span><span id="MarkovChain.generate-353"><a href="#MarkovChain.generate-353"><span class="linenos">353</span></a><span class="sd">        and abstract location labels.</span>
</span><span id="MarkovChain.generate-354"><a href="#MarkovChain.generate-354"><span class="linenos">354</span></a>
</span><span id="MarkovChain.generate-355"><a href="#MarkovChain.generate-355"><span class="linenos">355</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.generate-356"><a href="#MarkovChain.generate-356"><span class="linenos">356</span></a><span class="sd">            duration_hours (int): The total duration of the generated trajectory in hours.</span>
</span><span id="MarkovChain.generate-357"><a href="#MarkovChain.generate-357"><span class="linenos">357</span></a><span class="sd">            start_date (pd.Timestamp): The starting date and time for the generated trajectory.</span>
</span><span id="MarkovChain.generate-358"><a href="#MarkovChain.generate-358"><span class="linenos">358</span></a><span class="sd">            seed (Optional[int]): An optional random seed for reproducibility.</span>
</span><span id="MarkovChain.generate-359"><a href="#MarkovChain.generate-359"><span class="linenos">359</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.generate-360"><a href="#MarkovChain.generate-360"><span class="linenos">360</span></a><span class="sd">            pd.DataFrame: A DataFrame containing the generated trajectory with columns &#39;datetime&#39; and &#39;abstract_location&#39;.</span>
</span><span id="MarkovChain.generate-361"><a href="#MarkovChain.generate-361"><span class="linenos">361</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.generate-362"><a href="#MarkovChain.generate-362"><span class="linenos">362</span></a>        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain.generate-363"><a href="#MarkovChain.generate-363"><span class="linenos">363</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="MarkovChain.generate-364"><a href="#MarkovChain.generate-364"><span class="linenos">364</span></a>
</span><span id="MarkovChain.generate-365"><a href="#MarkovChain.generate-365"><span class="linenos">365</span></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MarkovChain.generate-366"><a href="#MarkovChain.generate-366"><span class="linenos">366</span></a>        <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_shift</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
</span><span id="MarkovChain.generate-367"><a href="#MarkovChain.generate-367"><span class="linenos">367</span></a>        <span class="n">prev_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain.generate-368"><a href="#MarkovChain.generate-368"><span class="linenos">368</span></a>        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_state</span><span class="p">)</span>
</span><span id="MarkovChain.generate-369"><a href="#MarkovChain.generate-369"><span class="linenos">369</span></a>
</span><span id="MarkovChain.generate-370"><a href="#MarkovChain.generate-370"><span class="linenos">370</span></a>        <span class="n">step</span><span class="p">,</span> <span class="n">hours_generated</span> <span class="o">=</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain.generate-371"><a href="#MarkovChain.generate-371"><span class="linenos">371</span></a>
</span><span id="MarkovChain.generate-372"><a href="#MarkovChain.generate-372"><span class="linenos">372</span></a>        <span class="k">while</span> <span class="n">hours_generated</span> <span class="o">&lt;</span> <span class="n">duration_hours</span><span class="p">:</span>
</span><span id="MarkovChain.generate-373"><a href="#MarkovChain.generate-373"><span class="linenos">373</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.generate-374"><a href="#MarkovChain.generate-374"><span class="linenos">374</span></a>            <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">prev_state</span><span class="p">]</span>
</span><span id="MarkovChain.generate-375"><a href="#MarkovChain.generate-375"><span class="linenos">375</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="MarkovChain.generate-376"><a href="#MarkovChain.generate-376"><span class="linenos">376</span></a>
</span><span id="MarkovChain.generate-377"><a href="#MarkovChain.generate-377"><span class="linenos">377</span></a>            <span class="n">next_state</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MarkovChain.generate-378"><a href="#MarkovChain.generate-378"><span class="linenos">378</span></a>                <span class="p">((</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MarkovChain.generate-379"><a href="#MarkovChain.generate-379"><span class="linenos">379</span></a>                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span>
</span><span id="MarkovChain.generate-380"><a href="#MarkovChain.generate-380"><span class="linenos">380</span></a>                <span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="bp">self</span><span class="o">.</span><span class="n">_choose_weighted</span><span class="p">(</span><span class="n">probs</span><span class="p">)]</span>
</span><span id="MarkovChain.generate-381"><a href="#MarkovChain.generate-381"><span class="linenos">381</span></a>            <span class="p">)</span>
</span><span id="MarkovChain.generate-382"><a href="#MarkovChain.generate-382"><span class="linenos">382</span></a>
</span><span id="MarkovChain.generate-383"><a href="#MarkovChain.generate-383"><span class="linenos">383</span></a>            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
</span><span id="MarkovChain.generate-384"><a href="#MarkovChain.generate-384"><span class="linenos">384</span></a>            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.generate-385"><a href="#MarkovChain.generate-385"><span class="linenos">385</span></a>            <span class="n">step</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="MarkovChain.generate-386"><a href="#MarkovChain.generate-386"><span class="linenos">386</span></a>            <span class="n">hours_generated</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="MarkovChain.generate-387"><a href="#MarkovChain.generate-387"><span class="linenos">387</span></a>            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">next_state</span>
</span><span id="MarkovChain.generate-388"><a href="#MarkovChain.generate-388"><span class="linenos">388</span></a>
</span><span id="MarkovChain.generate-389"><a href="#MarkovChain.generate-389"><span class="linenos">389</span></a>        <span class="n">diary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states_to_diary</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">duration_hours</span><span class="p">,</span> <span class="n">start_date</span><span class="p">)</span>
</span><span id="MarkovChain.generate-390"><a href="#MarkovChain.generate-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">diary</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract_location&#39;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Generate a synthetic trajectory for a specified duration starting from a given date using the fitted
Markov chain. The method simulates the trajectory by transitioning through states in the Markov chain based
on the learned transition probabilities. The generated trajectory is returned as a DataFrame with timestamps
and abstract location labels.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>duration_hours (int):</strong>  The total duration of the generated trajectory in hours.</li>
<li><strong>start_date (pd.Timestamp):</strong>  The starting date and time for the generated trajectory.</li>
<li><strong>seed (Optional[int]):</strong>  An optional random seed for reproducibility.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>pd.DataFrame: A DataFrame containing the generated trajectory with columns 'datetime' and 'abstract_location'.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.initialize_empty_chain" class="classattr">
                                        <input id="MarkovChain.initialize_empty_chain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize_empty_chain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.initialize_empty_chain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.initialize_empty_chain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.initialize_empty_chain-68"><a href="#MarkovChain.initialize_empty_chain-68"><span class="linenos">68</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_empty_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain.initialize_empty_chain-69"><a href="#MarkovChain.initialize_empty_chain-69"><span class="linenos">69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.initialize_empty_chain-70"><a href="#MarkovChain.initialize_empty_chain-70"><span class="linenos">70</span></a><span class="sd">        Initialize an empty Markov chain with all possible states and zero transition probabilities.</span>
</span><span id="MarkovChain.initialize_empty_chain-71"><a href="#MarkovChain.initialize_empty_chain-71"><span class="linenos">71</span></a><span class="sd">        The state space consists of tuples (h, r) where h is the hour in the chain (0 to chain_length-1) and r is the</span>
</span><span id="MarkovChain.initialize_empty_chain-72"><a href="#MarkovChain.initialize_empty_chain-72"><span class="linenos">72</span></a><span class="sd">        location type (0 for non-typical, 1 for home).</span>
</span><span id="MarkovChain.initialize_empty_chain-73"><a href="#MarkovChain.initialize_empty_chain-73"><span class="linenos">73</span></a><span class="sd">        The transition probabilities are stored in a nested defaultdict structure.</span>
</span><span id="MarkovChain.initialize_empty_chain-74"><a href="#MarkovChain.initialize_empty_chain-74"><span class="linenos">74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.initialize_empty_chain-75"><a href="#MarkovChain.initialize_empty_chain-75"><span class="linenos">75</span></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="MarkovChain.initialize_empty_chain-76"><a href="#MarkovChain.initialize_empty_chain-76"><span class="linenos">76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="MarkovChain.initialize_empty_chain-77"><a href="#MarkovChain.initialize_empty_chain-77"><span class="linenos">77</span></a>        <span class="k">for</span> <span class="n">state1</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="MarkovChain.initialize_empty_chain-78"><a href="#MarkovChain.initialize_empty_chain-78"><span class="linenos">78</span></a>            <span class="k">for</span> <span class="n">state2</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="MarkovChain.initialize_empty_chain-79"><a href="#MarkovChain.initialize_empty_chain-79"><span class="linenos">79</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">state1</span><span class="p">][</span><span class="n">state2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Initialize an empty Markov chain with all possible states and zero transition probabilities.
The state space consists of tuples (h, r) where h is the hour in the chain (0 to chain_length-1) and r is the
location type (0 for non-typical, 1 for home).
The transition probabilities are stored in a nested defaultdict structure.</p>
</div>


                            </div>
                            <div id="MarkovChain.group_by_time_slot" class="classattr">
                                        <input id="MarkovChain.group_by_time_slot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">group_by_time_slot</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trajectory</span><span class="p">:</span> <span class="n">humobi</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">TrajectoriesFrame</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.group_by_time_slot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.group_by_time_slot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.group_by_time_slot-81"><a href="#MarkovChain.group_by_time_slot-81"><span class="linenos">81</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_group_by_time_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
</span><span id="MarkovChain.group_by_time_slot-82"><a href="#MarkovChain.group_by_time_slot-82"><span class="linenos">82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.group_by_time_slot-83"><a href="#MarkovChain.group_by_time_slot-83"><span class="linenos">83</span></a><span class="sd">        Group trajectory data into specified time slots, concatenating location labels within each slot.</span>
</span><span id="MarkovChain.group_by_time_slot-84"><a href="#MarkovChain.group_by_time_slot-84"><span class="linenos">84</span></a><span class="sd">        This method resamples the trajectory data based on the configured time slot and aggregates location labels by</span>
</span><span id="MarkovChain.group_by_time_slot-85"><a href="#MarkovChain.group_by_time_slot-85"><span class="linenos">85</span></a><span class="sd">        joining them with commas. Empty slots are represented as NaN.</span>
</span><span id="MarkovChain.group_by_time_slot-86"><a href="#MarkovChain.group_by_time_slot-86"><span class="linenos">86</span></a>
</span><span id="MarkovChain.group_by_time_slot-87"><a href="#MarkovChain.group_by_time_slot-87"><span class="linenos">87</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.group_by_time_slot-88"><a href="#MarkovChain.group_by_time_slot-88"><span class="linenos">88</span></a><span class="sd">            trajectory (TrajectoriesFrame): The trajectory data to be grouped.</span>
</span><span id="MarkovChain.group_by_time_slot-89"><a href="#MarkovChain.group_by_time_slot-89"><span class="linenos">89</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.group_by_time_slot-90"><a href="#MarkovChain.group_by_time_slot-90"><span class="linenos">90</span></a><span class="sd">            pd.Series: A series indexed by time slots with concatenated location labels.</span>
</span><span id="MarkovChain.group_by_time_slot-91"><a href="#MarkovChain.group_by_time_slot-91"><span class="linenos">91</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.group_by_time_slot-92"><a href="#MarkovChain.group_by_time_slot-92"><span class="linenos">92</span></a>        <span class="n">series</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="MarkovChain.group_by_time_slot-93"><a href="#MarkovChain.group_by_time_slot-93"><span class="linenos">93</span></a>        <span class="n">grouped</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_slot</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="MarkovChain.group_by_time_slot-94"><a href="#MarkovChain.group_by_time_slot-94"><span class="linenos">94</span></a>        <span class="k">return</span> <span class="n">grouped</span>
</span></pre></div>


            <div class="docstring"><p>Group trajectory data into specified time slots, concatenating location labels within each slot.
This method resamples the trajectory data based on the configured time slot and aggregates location labels by
joining them with commas. Empty slots are represented as NaN.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>trajectory (TrajectoriesFrame):</strong>  The trajectory data to be grouped.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>pd.Series: A series indexed by time slots with concatenated location labels.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.compute_location_stats" class="classattr">
                                        <input id="MarkovChain.compute_location_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_location_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">grouped_series</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.compute_location_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.compute_location_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.compute_location_stats-96"><a href="#MarkovChain.compute_location_stats-96"><span class="linenos"> 96</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain.compute_location_stats-97"><a href="#MarkovChain.compute_location_stats-97"><span class="linenos"> 97</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_location_stats</span><span class="p">(</span><span class="n">grouped_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
</span><span id="MarkovChain.compute_location_stats-98"><a href="#MarkovChain.compute_location_stats-98"><span class="linenos"> 98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.compute_location_stats-99"><a href="#MarkovChain.compute_location_stats-99"><span class="linenos"> 99</span></a><span class="sd">        Compute frequency and rank of locations from the grouped series.</span>
</span><span id="MarkovChain.compute_location_stats-100"><a href="#MarkovChain.compute_location_stats-100"><span class="linenos">100</span></a><span class="sd">        This method analyzes the concatenated location labels in each time slot to determine how often each location</span>
</span><span id="MarkovChain.compute_location_stats-101"><a href="#MarkovChain.compute_location_stats-101"><span class="linenos">101</span></a><span class="sd">        appears and assigns ranks based on frequency.</span>
</span><span id="MarkovChain.compute_location_stats-102"><a href="#MarkovChain.compute_location_stats-102"><span class="linenos">102</span></a>
</span><span id="MarkovChain.compute_location_stats-103"><a href="#MarkovChain.compute_location_stats-103"><span class="linenos">103</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.compute_location_stats-104"><a href="#MarkovChain.compute_location_stats-104"><span class="linenos">104</span></a><span class="sd">            grouped_series (pd.Series): A series with concatenated location labels per time slot.</span>
</span><span id="MarkovChain.compute_location_stats-105"><a href="#MarkovChain.compute_location_stats-105"><span class="linenos">105</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.compute_location_stats-106"><a href="#MarkovChain.compute_location_stats-106"><span class="linenos">106</span></a><span class="sd">            tuple[dict, dict]: A tuple containing two dictionaries: one for location frequencies and another for location ranks.</span>
</span><span id="MarkovChain.compute_location_stats-107"><a href="#MarkovChain.compute_location_stats-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.compute_location_stats-108"><a href="#MarkovChain.compute_location_stats-108"><span class="linenos">108</span></a>        <span class="n">freq</span><span class="p">:</span> <span class="n">Counter</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span><span id="MarkovChain.compute_location_stats-109"><a href="#MarkovChain.compute_location_stats-109"><span class="linenos">109</span></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">grouped_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">():</span>
</span><span id="MarkovChain.compute_location_stats-110"><a href="#MarkovChain.compute_location_stats-110"><span class="linenos">110</span></a>            <span class="n">freq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
</span><span id="MarkovChain.compute_location_stats-111"><a href="#MarkovChain.compute_location_stats-111"><span class="linenos">111</span></a>        <span class="n">ranks</span> <span class="o">=</span> <span class="p">{</span><span class="n">loc</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">())}</span>
</span><span id="MarkovChain.compute_location_stats-112"><a href="#MarkovChain.compute_location_stats-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">ranks</span>
</span></pre></div>


            <div class="docstring"><p>Compute frequency and rank of locations from the grouped series.
This method analyzes the concatenated location labels in each time slot to determine how often each location
appears and assigns ranks based on frequency.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>grouped_series (pd.Series):</strong>  A series with concatenated location labels per time slot.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[dict, dict]: A tuple containing two dictionaries: one for location frequencies and another for location ranks.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.most_frequent_location" class="classattr">
                                        <input id="MarkovChain.most_frequent_location-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">most_frequent_location</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">slot_string</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">freq_map</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.most_frequent_location-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.most_frequent_location"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.most_frequent_location-114"><a href="#MarkovChain.most_frequent_location-114"><span class="linenos">114</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain.most_frequent_location-115"><a href="#MarkovChain.most_frequent_location-115"><span class="linenos">115</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_most_frequent_location</span><span class="p">(</span><span class="n">slot_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">freq_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="MarkovChain.most_frequent_location-116"><a href="#MarkovChain.most_frequent_location-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.most_frequent_location-117"><a href="#MarkovChain.most_frequent_location-117"><span class="linenos">117</span></a><span class="sd">        Determine the most frequent location from a comma-separated string of locations.</span>
</span><span id="MarkovChain.most_frequent_location-118"><a href="#MarkovChain.most_frequent_location-118"><span class="linenos">118</span></a><span class="sd">        If there&#39;s a tie in frequency, the location with the highest overall frequency in freq_map is chosen.</span>
</span><span id="MarkovChain.most_frequent_location-119"><a href="#MarkovChain.most_frequent_location-119"><span class="linenos">119</span></a>
</span><span id="MarkovChain.most_frequent_location-120"><a href="#MarkovChain.most_frequent_location-120"><span class="linenos">120</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.most_frequent_location-121"><a href="#MarkovChain.most_frequent_location-121"><span class="linenos">121</span></a><span class="sd">            slot_string (str): A comma-separated string of location labels.</span>
</span><span id="MarkovChain.most_frequent_location-122"><a href="#MarkovChain.most_frequent_location-122"><span class="linenos">122</span></a><span class="sd">            freq_map (dict): A dictionary mapping locations to their overall frequencies.</span>
</span><span id="MarkovChain.most_frequent_location-123"><a href="#MarkovChain.most_frequent_location-123"><span class="linenos">123</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.most_frequent_location-124"><a href="#MarkovChain.most_frequent_location-124"><span class="linenos">124</span></a><span class="sd">            str | float: The most frequent location label, or NaN if input is invalid.</span>
</span><span id="MarkovChain.most_frequent_location-125"><a href="#MarkovChain.most_frequent_location-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.most_frequent_location-126"><a href="#MarkovChain.most_frequent_location-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">slot_string</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="MarkovChain.most_frequent_location-127"><a href="#MarkovChain.most_frequent_location-127"><span class="linenos">127</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="MarkovChain.most_frequent_location-128"><a href="#MarkovChain.most_frequent_location-128"><span class="linenos">128</span></a>
</span><span id="MarkovChain.most_frequent_location-129"><a href="#MarkovChain.most_frequent_location-129"><span class="linenos">129</span></a>        <span class="n">locations</span> <span class="o">=</span> <span class="n">slot_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="MarkovChain.most_frequent_location-130"><a href="#MarkovChain.most_frequent_location-130"><span class="linenos">130</span></a>        <span class="n">location_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
</span><span id="MarkovChain.most_frequent_location-131"><a href="#MarkovChain.most_frequent_location-131"><span class="linenos">131</span></a>
</span><span id="MarkovChain.most_frequent_location-132"><a href="#MarkovChain.most_frequent_location-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain.most_frequent_location-133"><a href="#MarkovChain.most_frequent_location-133"><span class="linenos">133</span></a>            <span class="k">return</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MarkovChain.most_frequent_location-134"><a href="#MarkovChain.most_frequent_location-134"><span class="linenos">134</span></a>
</span><span id="MarkovChain.most_frequent_location-135"><a href="#MarkovChain.most_frequent_location-135"><span class="linenos">135</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain.most_frequent_location-136"><a href="#MarkovChain.most_frequent_location-136"><span class="linenos">136</span></a>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span> <span class="n">freq_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="MarkovChain.most_frequent_location-137"><a href="#MarkovChain.most_frequent_location-137"><span class="linenos">137</span></a>
</span><span id="MarkovChain.most_frequent_location-138"><a href="#MarkovChain.most_frequent_location-138"><span class="linenos">138</span></a>        <span class="k">return</span> <span class="n">location_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Determine the most frequent location from a comma-separated string of locations.
If there's a tie in frequency, the location with the highest overall frequency in freq_map is chosen.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>slot_string (str):</strong>  A comma-separated string of location labels.</li>
<li><strong>freq_map (dict):</strong>  A dictionary mapping locations to their overall frequencies.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>str | float: The most frequent location label, or NaN if input is invalid.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.get_time_shift" class="classattr">
                                        <input id="MarkovChain.get_time_shift-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_time_shift</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">date</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.get_time_shift-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.get_time_shift"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.get_time_shift-140"><a href="#MarkovChain.get_time_shift-140"><span class="linenos">140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_time_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain.get_time_shift-141"><a href="#MarkovChain.get_time_shift-141"><span class="linenos">141</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.get_time_shift-142"><a href="#MarkovChain.get_time_shift-142"><span class="linenos">142</span></a><span class="sd">        Calculate the time shift based on the date and chain length. This determines the starting hour in the Markov</span>
</span><span id="MarkovChain.get_time_shift-143"><a href="#MarkovChain.get_time_shift-143"><span class="linenos">143</span></a><span class="sd">        chain corresponding to the given date.</span>
</span><span id="MarkovChain.get_time_shift-144"><a href="#MarkovChain.get_time_shift-144"><span class="linenos">144</span></a>
</span><span id="MarkovChain.get_time_shift-145"><a href="#MarkovChain.get_time_shift-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.get_time_shift-146"><a href="#MarkovChain.get_time_shift-146"><span class="linenos">146</span></a><span class="sd">            date (pd.Timestamp): The date and time to calculate the shift for.</span>
</span><span id="MarkovChain.get_time_shift-147"><a href="#MarkovChain.get_time_shift-147"><span class="linenos">147</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.get_time_shift-148"><a href="#MarkovChain.get_time_shift-148"><span class="linenos">148</span></a><span class="sd">            int: The calculated time shift (hour) in the Markov chain.</span>
</span><span id="MarkovChain.get_time_shift-149"><a href="#MarkovChain.get_time_shift-149"><span class="linenos">149</span></a><span class="sd">        Raises:</span>
</span><span id="MarkovChain.get_time_shift-150"><a href="#MarkovChain.get_time_shift-150"><span class="linenos">150</span></a><span class="sd">            ValueError: If chain_length is not one of the supported values (24, 168, 336).</span>
</span><span id="MarkovChain.get_time_shift-151"><a href="#MarkovChain.get_time_shift-151"><span class="linenos">151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.get_time_shift-152"><a href="#MarkovChain.get_time_shift-152"><span class="linenos">152</span></a>        <span class="n">date_midnight</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MarkovChain.get_time_shift-153"><a href="#MarkovChain.get_time_shift-153"><span class="linenos">153</span></a>
</span><span id="MarkovChain.get_time_shift-154"><a href="#MarkovChain.get_time_shift-154"><span class="linenos">154</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">start_of_week</span><span class="p">(</span><span class="n">weeks_back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MarkovChain.get_time_shift-155"><a href="#MarkovChain.get_time_shift-155"><span class="linenos">155</span></a>            <span class="c1"># Returns the start of the week shifted back by n_weeks weeks (default is 1 week)</span>
</span><span id="MarkovChain.get_time_shift-156"><a href="#MarkovChain.get_time_shift-156"><span class="linenos">156</span></a>            <span class="k">return</span> <span class="n">date_midnight</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">date_midnight</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">weeks_back</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="MarkovChain.get_time_shift-157"><a href="#MarkovChain.get_time_shift-157"><span class="linenos">157</span></a>
</span><span id="MarkovChain.get_time_shift-158"><a href="#MarkovChain.get_time_shift-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
</span><span id="MarkovChain.get_time_shift-159"><a href="#MarkovChain.get_time_shift-159"><span class="linenos">159</span></a>            <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">hour</span>
</span><span id="MarkovChain.get_time_shift-160"><a href="#MarkovChain.get_time_shift-160"><span class="linenos">160</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">168</span><span class="p">:</span>
</span><span id="MarkovChain.get_time_shift-161"><a href="#MarkovChain.get_time_shift-161"><span class="linenos">161</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">start_of_week</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="MarkovChain.get_time_shift-162"><a href="#MarkovChain.get_time_shift-162"><span class="linenos">162</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">==</span> <span class="mi">336</span><span class="p">:</span>
</span><span id="MarkovChain.get_time_shift-163"><a href="#MarkovChain.get_time_shift-163"><span class="linenos">163</span></a>            <span class="n">is_even_week</span> <span class="o">=</span> <span class="n">date_midnight</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MarkovChain.get_time_shift-164"><a href="#MarkovChain.get_time_shift-164"><span class="linenos">164</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">start_of_week</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_even_week</span> <span class="k">else</span> <span class="n">start_of_week</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="MarkovChain.get_time_shift-165"><a href="#MarkovChain.get_time_shift-165"><span class="linenos">165</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">)</span>
</span><span id="MarkovChain.get_time_shift-166"><a href="#MarkovChain.get_time_shift-166"><span class="linenos">166</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.get_time_shift-167"><a href="#MarkovChain.get_time_shift-167"><span class="linenos">167</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported chain_length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the time shift based on the date and chain length. This determines the starting hour in the Markov
chain corresponding to the given date.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>date (pd.Timestamp):</strong>  The date and time to calculate the shift for.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The calculated time shift (hour) in the Markov chain.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If chain_length is not one of the supported values (24, 168, 336).</li>
</ul>
</div>


                            </div>
                            <div id="MarkovChain.process_individual" class="classattr">
                                        <input id="MarkovChain.process_individual-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_individual</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">user_data</span><span class="p">:</span> <span class="n">humobi</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">TrajectoriesFrame</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.process_individual-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.process_individual"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.process_individual-169"><a href="#MarkovChain.process_individual-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_individual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="n">TrajectoriesFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
</span><span id="MarkovChain.process_individual-170"><a href="#MarkovChain.process_individual-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.process_individual-171"><a href="#MarkovChain.process_individual-171"><span class="linenos">171</span></a><span class="sd">        Process an individual&#39;s trajectory data to create a series of abstract locations per time slot.</span>
</span><span id="MarkovChain.process_individual-172"><a href="#MarkovChain.process_individual-172"><span class="linenos">172</span></a><span class="sd">        This method groups the user&#39;s trajectory data by time slots, computes location statistics, and fills in</span>
</span><span id="MarkovChain.process_individual-173"><a href="#MarkovChain.process_individual-173"><span class="linenos">173</span></a><span class="sd">        missing values by forward and backward filling. The resulting series maps each time slot to an abstract</span>
</span><span id="MarkovChain.process_individual-174"><a href="#MarkovChain.process_individual-174"><span class="linenos">174</span></a><span class="sd">        location rank.</span>
</span><span id="MarkovChain.process_individual-175"><a href="#MarkovChain.process_individual-175"><span class="linenos">175</span></a>
</span><span id="MarkovChain.process_individual-176"><a href="#MarkovChain.process_individual-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.process_individual-177"><a href="#MarkovChain.process_individual-177"><span class="linenos">177</span></a><span class="sd">            user_data (TrajectoriesFrame): The trajectory data for a single user.</span>
</span><span id="MarkovChain.process_individual-178"><a href="#MarkovChain.process_individual-178"><span class="linenos">178</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.process_individual-179"><a href="#MarkovChain.process_individual-179"><span class="linenos">179</span></a><span class="sd">            pd.Series: A series indexed by time slots with abstract location ranks.</span>
</span><span id="MarkovChain.process_individual-180"><a href="#MarkovChain.process_individual-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.process_individual-181"><a href="#MarkovChain.process_individual-181"><span class="linenos">181</span></a>        <span class="n">grouped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by_time_slot</span><span class="p">(</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="MarkovChain.process_individual-182"><a href="#MarkovChain.process_individual-182"><span class="linenos">182</span></a>        <span class="n">freq_map</span><span class="p">,</span> <span class="n">rank_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_location_stats</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>
</span><span id="MarkovChain.process_individual-183"><a href="#MarkovChain.process_individual-183"><span class="linenos">183</span></a>        <span class="n">abstract_series</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_most_frequent_location</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq_map</span><span class="p">))</span>
</span><span id="MarkovChain.process_individual-184"><a href="#MarkovChain.process_individual-184"><span class="linenos">184</span></a>        <span class="n">abstract_series</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MarkovChain.process_individual-185"><a href="#MarkovChain.process_individual-185"><span class="linenos">185</span></a>        <span class="n">abstract_series</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MarkovChain.process_individual-186"><a href="#MarkovChain.process_individual-186"><span class="linenos">186</span></a>        <span class="n">abstract_series</span> <span class="o">=</span> <span class="n">abstract_series</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rank_map</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
</span><span id="MarkovChain.process_individual-187"><a href="#MarkovChain.process_individual-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="n">abstract_series</span>
</span></pre></div>


            <div class="docstring"><p>Process an individual's trajectory data to create a series of abstract locations per time slot.
This method groups the user's trajectory data by time slots, computes location statistics, and fills in
missing values by forward and backward filling. The resulting series maps each time slot to an abstract
location rank.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>user_data (TrajectoriesFrame):</strong>  The trajectory data for a single user.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>pd.Series: A series indexed by time slots with abstract location ranks.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.compute_tau" class="classattr">
                                        <input id="MarkovChain.compute_tau-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_tau</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">series</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span>,</span><span class="param">	<span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">target_loc</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.compute_tau-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.compute_tau"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.compute_tau-189"><a href="#MarkovChain.compute_tau-189"><span class="linenos">189</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain.compute_tau-190"><a href="#MarkovChain.compute_tau-190"><span class="linenos">190</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="MarkovChain.compute_tau-191"><a href="#MarkovChain.compute_tau-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.compute_tau-192"><a href="#MarkovChain.compute_tau-192"><span class="linenos">192</span></a><span class="sd">        Compute the duration (tau) of consecutive occurrences of target_loc in the series starting from start_idx.</span>
</span><span id="MarkovChain.compute_tau-193"><a href="#MarkovChain.compute_tau-193"><span class="linenos">193</span></a><span class="sd">        Returns the count of consecutive occurrences and the index where the sequence ends.</span>
</span><span id="MarkovChain.compute_tau-194"><a href="#MarkovChain.compute_tau-194"><span class="linenos">194</span></a>
</span><span id="MarkovChain.compute_tau-195"><a href="#MarkovChain.compute_tau-195"><span class="linenos">195</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.compute_tau-196"><a href="#MarkovChain.compute_tau-196"><span class="linenos">196</span></a><span class="sd">            series (pd.Series): The series to analyze.</span>
</span><span id="MarkovChain.compute_tau-197"><a href="#MarkovChain.compute_tau-197"><span class="linenos">197</span></a><span class="sd">            start_idx (int): The starting index to check for consecutive occurrences.</span>
</span><span id="MarkovChain.compute_tau-198"><a href="#MarkovChain.compute_tau-198"><span class="linenos">198</span></a><span class="sd">            target_loc (int): The location label to count consecutively.</span>
</span><span id="MarkovChain.compute_tau-199"><a href="#MarkovChain.compute_tau-199"><span class="linenos">199</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.compute_tau-200"><a href="#MarkovChain.compute_tau-200"><span class="linenos">200</span></a><span class="sd">            Tuple[int, int]: A tuple containing the count of consecutive occurrences (tau) and the index where the sequence ends.</span>
</span><span id="MarkovChain.compute_tau-201"><a href="#MarkovChain.compute_tau-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.compute_tau-202"><a href="#MarkovChain.compute_tau-202"><span class="linenos">202</span></a>
</span><span id="MarkovChain.compute_tau-203"><a href="#MarkovChain.compute_tau-203"><span class="linenos">203</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</span><span id="MarkovChain.compute_tau-204"><a href="#MarkovChain.compute_tau-204"><span class="linenos">204</span></a>        <span class="n">tau</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># start with 1 to count the current location</span>
</span><span id="MarkovChain.compute_tau-205"><a href="#MarkovChain.compute_tau-205"><span class="linenos">205</span></a>        <span class="n">j</span> <span class="o">=</span> <span class="n">start_idx</span>
</span><span id="MarkovChain.compute_tau-206"><a href="#MarkovChain.compute_tau-206"><span class="linenos">206</span></a>        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_loc</span><span class="p">:</span>
</span><span id="MarkovChain.compute_tau-207"><a href="#MarkovChain.compute_tau-207"><span class="linenos">207</span></a>            <span class="n">tau</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.compute_tau-208"><a href="#MarkovChain.compute_tau-208"><span class="linenos">208</span></a>            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.compute_tau-209"><a href="#MarkovChain.compute_tau-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="n">tau</span><span class="p">,</span> <span class="n">j</span>
</span></pre></div>


            <div class="docstring"><p>Compute the duration (tau) of consecutive occurrences of target_loc in the series starting from start_idx.
Returns the count of consecutive occurrences and the index where the sequence ends.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>series (pd.Series):</strong>  The series to analyze.</li>
<li><strong>start_idx (int):</strong>  The starting index to check for consecutive occurrences.</li>
<li><strong>target_loc (int):</strong>  The location label to count consecutively.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Tuple[int, int]: A tuple containing the count of consecutive occurrences (tau) and the index where the sequence ends.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.handle_home_transition" class="classattr">
                                        <input id="MarkovChain.handle_home_transition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_home_transition</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">series</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span>,</span><span class="param">	<span class="n">slot</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">h</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">n</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.handle_home_transition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.handle_home_transition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.handle_home_transition-211"><a href="#MarkovChain.handle_home_transition-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_home_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain.handle_home_transition-212"><a href="#MarkovChain.handle_home_transition-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.handle_home_transition-213"><a href="#MarkovChain.handle_home_transition-213"><span class="linenos">213</span></a><span class="sd">        Handle transitions when the current location is &#39;home&#39; (1). Updates the Markov chain based on the next location.</span>
</span><span id="MarkovChain.handle_home_transition-214"><a href="#MarkovChain.handle_home_transition-214"><span class="linenos">214</span></a>
</span><span id="MarkovChain.handle_home_transition-215"><a href="#MarkovChain.handle_home_transition-215"><span class="linenos">215</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.handle_home_transition-216"><a href="#MarkovChain.handle_home_transition-216"><span class="linenos">216</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="MarkovChain.handle_home_transition-217"><a href="#MarkovChain.handle_home_transition-217"><span class="linenos">217</span></a><span class="sd">            slot (int): The current index in the series.</span>
</span><span id="MarkovChain.handle_home_transition-218"><a href="#MarkovChain.handle_home_transition-218"><span class="linenos">218</span></a><span class="sd">            h (int): The current hour in the Markov chain.</span>
</span><span id="MarkovChain.handle_home_transition-219"><a href="#MarkovChain.handle_home_transition-219"><span class="linenos">219</span></a><span class="sd">            next_h (int): The next hour in the Markov chain.</span>
</span><span id="MarkovChain.handle_home_transition-220"><a href="#MarkovChain.handle_home_transition-220"><span class="linenos">220</span></a><span class="sd">            next_loc (int): The next location label.</span>
</span><span id="MarkovChain.handle_home_transition-221"><a href="#MarkovChain.handle_home_transition-221"><span class="linenos">221</span></a><span class="sd">            n (int): The total length of the series.</span>
</span><span id="MarkovChain.handle_home_transition-222"><a href="#MarkovChain.handle_home_transition-222"><span class="linenos">222</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.handle_home_transition-223"><a href="#MarkovChain.handle_home_transition-223"><span class="linenos">223</span></a><span class="sd">            int: The updated index in the series after handling the transition.</span>
</span><span id="MarkovChain.handle_home_transition-224"><a href="#MarkovChain.handle_home_transition-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.handle_home_transition-225"><a href="#MarkovChain.handle_home_transition-225"><span class="linenos">225</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain.handle_home_transition-226"><a href="#MarkovChain.handle_home_transition-226"><span class="linenos">226</span></a>        <span class="k">if</span> <span class="n">next_loc</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="MarkovChain.handle_home_transition-227"><a href="#MarkovChain.handle_home_transition-227"><span class="linenos">227</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">home</span><span class="p">)][(</span><span class="n">next_h</span><span class="p">,</span> <span class="n">home</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.handle_home_transition-228"><a href="#MarkovChain.handle_home_transition-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.handle_home_transition-229"><a href="#MarkovChain.handle_home_transition-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span><span id="MarkovChain.handle_home_transition-230"><a href="#MarkovChain.handle_home_transition-230"><span class="linenos">230</span></a>                <span class="n">tau</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">)</span>
</span><span id="MarkovChain.handle_home_transition-231"><a href="#MarkovChain.handle_home_transition-231"><span class="linenos">231</span></a>                <span class="n">h_tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.handle_home_transition-232"><a href="#MarkovChain.handle_home_transition-232"><span class="linenos">232</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">home</span><span class="p">)][(</span><span class="n">h_tau</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.handle_home_transition-233"><a href="#MarkovChain.handle_home_transition-233"><span class="linenos">233</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="MarkovChain.handle_home_transition-234"><a href="#MarkovChain.handle_home_transition-234"><span class="linenos">234</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.handle_home_transition-235"><a href="#MarkovChain.handle_home_transition-235"><span class="linenos">235</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="MarkovChain.handle_home_transition-236"><a href="#MarkovChain.handle_home_transition-236"><span class="linenos">236</span></a>
</span><span id="MarkovChain.handle_home_transition-237"><a href="#MarkovChain.handle_home_transition-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">slot</span>
</span></pre></div>


            <div class="docstring"><p>Handle transitions when the current location is 'home' (1). Updates the Markov chain based on the next location.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>series (pd.Series):</strong>  The series of abstract locations.</li>
<li><strong>slot (int):</strong>  The current index in the series.</li>
<li><strong>h (int):</strong>  The current hour in the Markov chain.</li>
<li><strong>next_h (int):</strong>  The next hour in the Markov chain.</li>
<li><strong>next_loc (int):</strong>  The next location label.</li>
<li><strong>n (int):</strong>  The total length of the series.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The updated index in the series after handling the transition.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.handle_non_home_transition" class="classattr">
                                        <input id="MarkovChain.handle_non_home_transition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_non_home_transition</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">series</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span>,</span><span class="param">	<span class="n">slot</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">h</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">n</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.handle_non_home_transition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.handle_non_home_transition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.handle_non_home_transition-239"><a href="#MarkovChain.handle_non_home_transition-239"><span class="linenos">239</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_non_home_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MarkovChain.handle_non_home_transition-240"><a href="#MarkovChain.handle_non_home_transition-240"><span class="linenos">240</span></a>                                    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain.handle_non_home_transition-241"><a href="#MarkovChain.handle_non_home_transition-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.handle_non_home_transition-242"><a href="#MarkovChain.handle_non_home_transition-242"><span class="linenos">242</span></a><span class="sd">        Handle transitions when the current location is &#39;non-typical&#39; (not home). Updates the Markov chain based on the</span>
</span><span id="MarkovChain.handle_non_home_transition-243"><a href="#MarkovChain.handle_non_home_transition-243"><span class="linenos">243</span></a><span class="sd">        next location.</span>
</span><span id="MarkovChain.handle_non_home_transition-244"><a href="#MarkovChain.handle_non_home_transition-244"><span class="linenos">244</span></a>
</span><span id="MarkovChain.handle_non_home_transition-245"><a href="#MarkovChain.handle_non_home_transition-245"><span class="linenos">245</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.handle_non_home_transition-246"><a href="#MarkovChain.handle_non_home_transition-246"><span class="linenos">246</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="MarkovChain.handle_non_home_transition-247"><a href="#MarkovChain.handle_non_home_transition-247"><span class="linenos">247</span></a><span class="sd">            slot (int): The current index in the series.</span>
</span><span id="MarkovChain.handle_non_home_transition-248"><a href="#MarkovChain.handle_non_home_transition-248"><span class="linenos">248</span></a><span class="sd">            h (int): The current hour in the Markov chain.</span>
</span><span id="MarkovChain.handle_non_home_transition-249"><a href="#MarkovChain.handle_non_home_transition-249"><span class="linenos">249</span></a><span class="sd">            next_h (int): The next hour in the Markov chain.</span>
</span><span id="MarkovChain.handle_non_home_transition-250"><a href="#MarkovChain.handle_non_home_transition-250"><span class="linenos">250</span></a><span class="sd">            next_loc (int): The next location label.</span>
</span><span id="MarkovChain.handle_non_home_transition-251"><a href="#MarkovChain.handle_non_home_transition-251"><span class="linenos">251</span></a><span class="sd">            n (int): The total length of the series.</span>
</span><span id="MarkovChain.handle_non_home_transition-252"><a href="#MarkovChain.handle_non_home_transition-252"><span class="linenos">252</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.handle_non_home_transition-253"><a href="#MarkovChain.handle_non_home_transition-253"><span class="linenos">253</span></a><span class="sd">            int: The updated index in the series after handling the transition.</span>
</span><span id="MarkovChain.handle_non_home_transition-254"><a href="#MarkovChain.handle_non_home_transition-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.handle_non_home_transition-255"><a href="#MarkovChain.handle_non_home_transition-255"><span class="linenos">255</span></a>
</span><span id="MarkovChain.handle_non_home_transition-256"><a href="#MarkovChain.handle_non_home_transition-256"><span class="linenos">256</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain.handle_non_home_transition-257"><a href="#MarkovChain.handle_non_home_transition-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="n">next_loc</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="MarkovChain.handle_non_home_transition-258"><a href="#MarkovChain.handle_non_home_transition-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)][(</span><span class="n">next_h</span><span class="p">,</span> <span class="n">home</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.handle_non_home_transition-259"><a href="#MarkovChain.handle_non_home_transition-259"><span class="linenos">259</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.handle_non_home_transition-260"><a href="#MarkovChain.handle_non_home_transition-260"><span class="linenos">260</span></a>            <span class="k">if</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span><span id="MarkovChain.handle_non_home_transition-261"><a href="#MarkovChain.handle_non_home_transition-261"><span class="linenos">261</span></a>                <span class="n">tau</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tau</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">)</span>
</span><span id="MarkovChain.handle_non_home_transition-262"><a href="#MarkovChain.handle_non_home_transition-262"><span class="linenos">262</span></a>                <span class="n">h_tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">tau</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.handle_non_home_transition-263"><a href="#MarkovChain.handle_non_home_transition-263"><span class="linenos">263</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)][(</span><span class="n">h_tau</span><span class="p">,</span> <span class="n">non_typical</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.handle_non_home_transition-264"><a href="#MarkovChain.handle_non_home_transition-264"><span class="linenos">264</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span>
</span><span id="MarkovChain.handle_non_home_transition-265"><a href="#MarkovChain.handle_non_home_transition-265"><span class="linenos">265</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.handle_non_home_transition-266"><a href="#MarkovChain.handle_non_home_transition-266"><span class="linenos">266</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="MarkovChain.handle_non_home_transition-267"><a href="#MarkovChain.handle_non_home_transition-267"><span class="linenos">267</span></a>        <span class="k">return</span> <span class="n">slot</span>
</span></pre></div>


            <div class="docstring"><p>Handle transitions when the current location is 'non-typical' (not home). Updates the Markov chain based on the
next location.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>series (pd.Series):</strong>  The series of abstract locations.</li>
<li><strong>slot (int):</strong>  The current index in the series.</li>
<li><strong>h (int):</strong>  The current hour in the Markov chain.</li>
<li><strong>next_h (int):</strong>  The next hour in the Markov chain.</li>
<li><strong>next_loc (int):</strong>  The next location label.</li>
<li><strong>n (int):</strong>  The total length of the series.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The updated index in the series after handling the transition.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.update_chain" class="classattr">
                                        <input id="MarkovChain.update_chain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_chain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">series</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span>, </span><span class="param"><span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.update_chain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.update_chain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.update_chain-269"><a href="#MarkovChain.update_chain-269"><span class="linenos">269</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain.update_chain-270"><a href="#MarkovChain.update_chain-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.update_chain-271"><a href="#MarkovChain.update_chain-271"><span class="linenos">271</span></a><span class="sd">        Update the Markov chain with transitions from the given series of abstract locations, applying a time shift.</span>
</span><span id="MarkovChain.update_chain-272"><a href="#MarkovChain.update_chain-272"><span class="linenos">272</span></a><span class="sd">        The method iterates through the series, handling transitions based on whether the current location is &#39;home&#39; or</span>
</span><span id="MarkovChain.update_chain-273"><a href="#MarkovChain.update_chain-273"><span class="linenos">273</span></a><span class="sd">        &#39;non-typical&#39;, and updates the transition counts in the Markov chain accordingly.</span>
</span><span id="MarkovChain.update_chain-274"><a href="#MarkovChain.update_chain-274"><span class="linenos">274</span></a>
</span><span id="MarkovChain.update_chain-275"><a href="#MarkovChain.update_chain-275"><span class="linenos">275</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.update_chain-276"><a href="#MarkovChain.update_chain-276"><span class="linenos">276</span></a><span class="sd">            series (pd.Series): The series of abstract locations.</span>
</span><span id="MarkovChain.update_chain-277"><a href="#MarkovChain.update_chain-277"><span class="linenos">277</span></a><span class="sd">            shift (int): The time shift to apply to the series.</span>
</span><span id="MarkovChain.update_chain-278"><a href="#MarkovChain.update_chain-278"><span class="linenos">278</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.update_chain-279"><a href="#MarkovChain.update_chain-279"><span class="linenos">279</span></a><span class="sd">            None</span>
</span><span id="MarkovChain.update_chain-280"><a href="#MarkovChain.update_chain-280"><span class="linenos">280</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.update_chain-281"><a href="#MarkovChain.update_chain-281"><span class="linenos">281</span></a>        <span class="n">home</span><span class="p">,</span> <span class="n">non_typical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="MarkovChain.update_chain-282"><a href="#MarkovChain.update_chain-282"><span class="linenos">282</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</span><span id="MarkovChain.update_chain-283"><a href="#MarkovChain.update_chain-283"><span class="linenos">283</span></a>        <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MarkovChain.update_chain-284"><a href="#MarkovChain.update_chain-284"><span class="linenos">284</span></a>        <span class="k">while</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain.update_chain-285"><a href="#MarkovChain.update_chain-285"><span class="linenos">285</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.update_chain-286"><a href="#MarkovChain.update_chain-286"><span class="linenos">286</span></a>            <span class="n">next_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.update_chain-287"><a href="#MarkovChain.update_chain-287"><span class="linenos">287</span></a>            <span class="n">current</span><span class="p">,</span> <span class="n">next_loc</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MarkovChain.update_chain-288"><a href="#MarkovChain.update_chain-288"><span class="linenos">288</span></a>            <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">home</span><span class="p">:</span>
</span><span id="MarkovChain.update_chain-289"><a href="#MarkovChain.update_chain-289"><span class="linenos">289</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_home_transition</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">next_h</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="MarkovChain.update_chain-290"><a href="#MarkovChain.update_chain-290"><span class="linenos">290</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.update_chain-291"><a href="#MarkovChain.update_chain-291"><span class="linenos">291</span></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_non_home_transition</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">next_h</span><span class="p">,</span> <span class="n">next_loc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="MarkovChain.update_chain-292"><a href="#MarkovChain.update_chain-292"><span class="linenos">292</span></a>            <span class="n">slot</span> <span class="o">+=</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Update the Markov chain with transitions from the given series of abstract locations, applying a time shift.
The method iterates through the series, handling transitions based on whether the current location is 'home' or
'non-typical', and updates the transition counts in the Markov chain accordingly.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>series (pd.Series):</strong>  The series of abstract locations.</li>
<li><strong>shift (int):</strong>  The time shift to apply to the series.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.normalize_chain" class="classattr">
                                        <input id="MarkovChain.normalize_chain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">normalize_chain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.normalize_chain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.normalize_chain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.normalize_chain-294"><a href="#MarkovChain.normalize_chain-294"><span class="linenos">294</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MarkovChain.normalize_chain-295"><a href="#MarkovChain.normalize_chain-295"><span class="linenos">295</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.normalize_chain-296"><a href="#MarkovChain.normalize_chain-296"><span class="linenos">296</span></a><span class="sd">        Normalize the transition counts in the Markov chain to probabilities.</span>
</span><span id="MarkovChain.normalize_chain-297"><a href="#MarkovChain.normalize_chain-297"><span class="linenos">297</span></a><span class="sd">        This method iterates through each origin state in the Markov chain and normalizes the transition counts to</span>
</span><span id="MarkovChain.normalize_chain-298"><a href="#MarkovChain.normalize_chain-298"><span class="linenos">298</span></a><span class="sd">        probabilities by dividing each count by the total count of transitions from that state. If a state has no</span>
</span><span id="MarkovChain.normalize_chain-299"><a href="#MarkovChain.normalize_chain-299"><span class="linenos">299</span></a><span class="sd">        outgoing transitions, its probabilities remain zero.</span>
</span><span id="MarkovChain.normalize_chain-300"><a href="#MarkovChain.normalize_chain-300"><span class="linenos">300</span></a>
</span><span id="MarkovChain.normalize_chain-301"><a href="#MarkovChain.normalize_chain-301"><span class="linenos">301</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.normalize_chain-302"><a href="#MarkovChain.normalize_chain-302"><span class="linenos">302</span></a><span class="sd">            None</span>
</span><span id="MarkovChain.normalize_chain-303"><a href="#MarkovChain.normalize_chain-303"><span class="linenos">303</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.normalize_chain-304"><a href="#MarkovChain.normalize_chain-304"><span class="linenos">304</span></a>        <span class="k">for</span> <span class="n">origin</span><span class="p">,</span> <span class="n">transitions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="MarkovChain.normalize_chain-305"><a href="#MarkovChain.normalize_chain-305"><span class="linenos">305</span></a>            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="MarkovChain.normalize_chain-306"><a href="#MarkovChain.normalize_chain-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MarkovChain.normalize_chain-307"><a href="#MarkovChain.normalize_chain-307"><span class="linenos">307</span></a>                <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">:</span>
</span><span id="MarkovChain.normalize_chain-308"><a href="#MarkovChain.normalize_chain-308"><span class="linenos">308</span></a>                    <span class="n">transitions</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
</span></pre></div>


            <div class="docstring"><p>Normalize the transition counts in the Markov chain to probabilities.
This method iterates through each origin state in the Markov chain and normalizes the transition counts to
probabilities by dividing each count by the total count of transitions from that state. If a state has no
outgoing transitions, its probabilities remain zero.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.choose_weighted" class="classattr">
                                        <input id="MarkovChain.choose_weighted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">choose_weighted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.choose_weighted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.choose_weighted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.choose_weighted-334"><a href="#MarkovChain.choose_weighted-334"><span class="linenos">334</span></a>    <span class="nd">@staticmethod</span>
</span><span id="MarkovChain.choose_weighted-335"><a href="#MarkovChain.choose_weighted-335"><span class="linenos">335</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_choose_weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MarkovChain.choose_weighted-336"><a href="#MarkovChain.choose_weighted-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.choose_weighted-337"><a href="#MarkovChain.choose_weighted-337"><span class="linenos">337</span></a><span class="sd">        Choose an index based on the provided weights using a weighted random selection. The method computes</span>
</span><span id="MarkovChain.choose_weighted-338"><a href="#MarkovChain.choose_weighted-338"><span class="linenos">338</span></a><span class="sd">        the cumulative sum of the weights and selects an index where a random number falls within the cumulative</span>
</span><span id="MarkovChain.choose_weighted-339"><a href="#MarkovChain.choose_weighted-339"><span class="linenos">339</span></a><span class="sd">        distribution.</span>
</span><span id="MarkovChain.choose_weighted-340"><a href="#MarkovChain.choose_weighted-340"><span class="linenos">340</span></a>
</span><span id="MarkovChain.choose_weighted-341"><a href="#MarkovChain.choose_weighted-341"><span class="linenos">341</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.choose_weighted-342"><a href="#MarkovChain.choose_weighted-342"><span class="linenos">342</span></a><span class="sd">            weights (list[float]): A list of weights for each index.</span>
</span><span id="MarkovChain.choose_weighted-343"><a href="#MarkovChain.choose_weighted-343"><span class="linenos">343</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.choose_weighted-344"><a href="#MarkovChain.choose_weighted-344"><span class="linenos">344</span></a><span class="sd">            int: The selected index based on the weights.</span>
</span><span id="MarkovChain.choose_weighted-345"><a href="#MarkovChain.choose_weighted-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.choose_weighted-346"><a href="#MarkovChain.choose_weighted-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()))</span>
</span></pre></div>


            <div class="docstring"><p>Choose an index based on the provided weights using a weighted random selection. The method computes
the cumulative sum of the weights and selects an index where a random number falls within the cumulative
distribution.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>weights (list[float]):</strong>  A list of weights for each index.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The selected index based on the weights.</p>
</blockquote>
</div>


                            </div>
                            <div id="MarkovChain.states_to_diary" class="classattr">
                                        <input id="MarkovChain.states_to_diary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">states_to_diary</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span>,</span><span class="param">	<span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">start_time</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="MarkovChain.states_to_diary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MarkovChain.states_to_diary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MarkovChain.states_to_diary-392"><a href="#MarkovChain.states_to_diary-392"><span class="linenos">392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_states_to_diary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="MarkovChain.states_to_diary-393"><a href="#MarkovChain.states_to_diary-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MarkovChain.states_to_diary-394"><a href="#MarkovChain.states_to_diary-394"><span class="linenos">394</span></a><span class="sd">        Convert a list of states into a diary format with timestamps and location labels.</span>
</span><span id="MarkovChain.states_to_diary-395"><a href="#MarkovChain.states_to_diary-395"><span class="linenos">395</span></a><span class="sd">        This method processes the list of states generated by the Markov chain to create a diary that records the</span>
</span><span id="MarkovChain.states_to_diary-396"><a href="#MarkovChain.states_to_diary-396"><span class="linenos">396</span></a><span class="sd">        timestamp and corresponding location label for each hour. Consecutive entries with the same location are</span>
</span><span id="MarkovChain.states_to_diary-397"><a href="#MarkovChain.states_to_diary-397"><span class="linenos">397</span></a><span class="sd">        merged to simplify the diary.</span>
</span><span id="MarkovChain.states_to_diary-398"><a href="#MarkovChain.states_to_diary-398"><span class="linenos">398</span></a>
</span><span id="MarkovChain.states_to_diary-399"><a href="#MarkovChain.states_to_diary-399"><span class="linenos">399</span></a><span class="sd">        Args:</span>
</span><span id="MarkovChain.states_to_diary-400"><a href="#MarkovChain.states_to_diary-400"><span class="linenos">400</span></a><span class="sd">            states (list[tuple]): A list of states represented as tuples (hour, location).</span>
</span><span id="MarkovChain.states_to_diary-401"><a href="#MarkovChain.states_to_diary-401"><span class="linenos">401</span></a><span class="sd">            max_length (int): The maximum length of the diary in hours.</span>
</span><span id="MarkovChain.states_to_diary-402"><a href="#MarkovChain.states_to_diary-402"><span class="linenos">402</span></a><span class="sd">            start_time (pd.Timestamp): The starting timestamp for the diary.</span>
</span><span id="MarkovChain.states_to_diary-403"><a href="#MarkovChain.states_to_diary-403"><span class="linenos">403</span></a><span class="sd">        Returns:</span>
</span><span id="MarkovChain.states_to_diary-404"><a href="#MarkovChain.states_to_diary-404"><span class="linenos">404</span></a><span class="sd">            List[Tuple[pd.Timestamp, int]]: A list of tuples containing timestamps and location labels.</span>
</span><span id="MarkovChain.states_to_diary-405"><a href="#MarkovChain.states_to_diary-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MarkovChain.states_to_diary-406"><a href="#MarkovChain.states_to_diary-406"><span class="linenos">406</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_time</span>
</span><span id="MarkovChain.states_to_diary-407"><a href="#MarkovChain.states_to_diary-407"><span class="linenos">407</span></a>        <span class="n">prev_state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MarkovChain.states_to_diary-408"><a href="#MarkovChain.states_to_diary-408"><span class="linenos">408</span></a>        <span class="n">location_counter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MarkovChain.states_to_diary-409"><a href="#MarkovChain.states_to_diary-409"><span class="linenos">409</span></a>        <span class="n">log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">current_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="MarkovChain.states_to_diary-410"><a href="#MarkovChain.states_to_diary-410"><span class="linenos">410</span></a>
</span><span id="MarkovChain.states_to_diary-411"><a href="#MarkovChain.states_to_diary-411"><span class="linenos">411</span></a>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="MarkovChain.states_to_diary-412"><a href="#MarkovChain.states_to_diary-412"><span class="linenos">412</span></a>            <span class="n">h</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="MarkovChain.states_to_diary-413"><a href="#MarkovChain.states_to_diary-413"><span class="linenos">413</span></a>            <span class="n">h_prev</span><span class="p">,</span> <span class="n">loc_prev</span> <span class="o">=</span> <span class="n">prev_state</span>
</span><span id="MarkovChain.states_to_diary-414"><a href="#MarkovChain.states_to_diary-414"><span class="linenos">414</span></a>
</span><span id="MarkovChain.states_to_diary-415"><a href="#MarkovChain.states_to_diary-415"><span class="linenos">415</span></a>            <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MarkovChain.states_to_diary-416"><a href="#MarkovChain.states_to_diary-416"><span class="linenos">416</span></a>                <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain.states_to_diary-417"><a href="#MarkovChain.states_to_diary-417"><span class="linenos">417</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="MarkovChain.states_to_diary-418"><a href="#MarkovChain.states_to_diary-418"><span class="linenos">418</span></a>                <span class="n">location_counter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MarkovChain.states_to_diary-419"><a href="#MarkovChain.states_to_diary-419"><span class="linenos">419</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MarkovChain.states_to_diary-420"><a href="#MarkovChain.states_to_diary-420"><span class="linenos">420</span></a>                <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">h_prev</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span>
</span><span id="MarkovChain.states_to_diary-421"><a href="#MarkovChain.states_to_diary-421"><span class="linenos">421</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hours</span><span class="p">):</span>
</span><span id="MarkovChain.states_to_diary-422"><a href="#MarkovChain.states_to_diary-422"><span class="linenos">422</span></a>                    <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MarkovChain.states_to_diary-423"><a href="#MarkovChain.states_to_diary-423"><span class="linenos">423</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_time</span><span class="p">,</span> <span class="n">location_counter</span><span class="p">))</span>
</span><span id="MarkovChain.states_to_diary-424"><a href="#MarkovChain.states_to_diary-424"><span class="linenos">424</span></a>                <span class="n">location_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="MarkovChain.states_to_diary-425"><a href="#MarkovChain.states_to_diary-425"><span class="linenos">425</span></a>
</span><span id="MarkovChain.states_to_diary-426"><a href="#MarkovChain.states_to_diary-426"><span class="linenos">426</span></a>            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="MarkovChain.states_to_diary-427"><a href="#MarkovChain.states_to_diary-427"><span class="linenos">427</span></a>
</span><span id="MarkovChain.states_to_diary-428"><a href="#MarkovChain.states_to_diary-428"><span class="linenos">428</span></a>        <span class="c1"># Simplify log by merging consecutive entries with same location</span>
</span><span id="MarkovChain.states_to_diary-429"><a href="#MarkovChain.states_to_diary-429"><span class="linenos">429</span></a>        <span class="n">simplified</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MarkovChain.states_to_diary-430"><a href="#MarkovChain.states_to_diary-430"><span class="linenos">430</span></a>        <span class="n">last_location</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="MarkovChain.states_to_diary-431"><a href="#MarkovChain.states_to_diary-431"><span class="linenos">431</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">log</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]:</span>
</span><span id="MarkovChain.states_to_diary-432"><a href="#MarkovChain.states_to_diary-432"><span class="linenos">432</span></a>            <span class="k">if</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">last_location</span><span class="p">:</span>
</span><span id="MarkovChain.states_to_diary-433"><a href="#MarkovChain.states_to_diary-433"><span class="linenos">433</span></a>                <span class="n">simplified</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
</span><span id="MarkovChain.states_to_diary-434"><a href="#MarkovChain.states_to_diary-434"><span class="linenos">434</span></a>                <span class="n">last_location</span> <span class="o">=</span> <span class="n">loc</span>
</span><span id="MarkovChain.states_to_diary-435"><a href="#MarkovChain.states_to_diary-435"><span class="linenos">435</span></a>
</span><span id="MarkovChain.states_to_diary-436"><a href="#MarkovChain.states_to_diary-436"><span class="linenos">436</span></a>        <span class="k">return</span> <span class="n">simplified</span>
</span></pre></div>


            <div class="docstring"><p>Convert a list of states into a diary format with timestamps and location labels.
This method processes the list of states generated by the Markov chain to create a diary that records the
timestamp and corresponding location label for each hour. Consecutive entries with the same location are
merged to simplify the diary.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>states (list[tuple]):</strong>  A list of states represented as tuples (hour, location).</li>
<li><strong>max_length (int):</strong>  The maximum length of the diary in hours.</li>
<li><strong>start_time (pd.Timestamp):</strong>  The starting timestamp for the diary.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>List[Tuple[pd.Timestamp, int]]: A list of tuples containing timestamps and location labels.</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>